(function(a,b){"use strict";var c=a.$,d,e,f={"RESPONSE":1,"NOT_LOGGED":2,"UNDER_MAINTAINANCE":3,"NO_PROJECT":4,"TEXT":1,"INTEGER":2,"FLOAT":3,"CURRENCY":4,"DATE":5,"DATETIME":6,"BOOLEAN":7,"BLOB":8,"ITEM_FIELD":1,"FILTER_FIELD":2,"PARAM_FIELD":3,"FILTER_EQ":1,"FILTER_NE":2,"FILTER_LT":3,"FILTER_LE":4,"FILTER_GT":5,"FILTER_GE":6,"FILTER_IN":7,"FILTER_NOT_IN":8,"FILTER_RANGE":9,"FILTER_ISNULL":10,"FILTER_EXACT":11,"FILTER_CONTAINS":12,"FILTER_STARTWITH":13,"FILTER_ENDWITH":14,"FILTER_SEARCH":15,"ALIGN_LEFT":1,"ALIGN_CENTER":2,"ALIGN_RIGHT":3,"STATE_INACTIVE":0,"STATE_BROWSE":1,"STATE_INSERT":2,"STATE_EDIT":3,"STATE_DELETE":4,"RECORD_UNCHANGED":null,"RECORD_INSERTED":1,"RECORD_MODIFIED":2,"RECORD_DETAILS_MODIFIED":3,"RECORD_DELETED":4,"REC_STATUS":0,"REC_CONTROLS_INFO":1,"REC_CHANGE_ID":2,"UPDATE_OPEN":0,"UPDATE_DELETE":1,"UPDATE_CANCEL":2,"UPDATE_APPEND":3,"UPDATE_INSERT":4,"UPDATE_SCROLLED":5,"UPDATE_CONTROLS":6,"UPDATE_REFRESH":7,"UPDATE_CLOSE":8},g=['','left','center','right'],h=['eq','ne','lt','le','gt','ge','in','not_in','range','isnull','exact','contains','startwith','endwith','search'];function i(a,c,d,e,f,g){if(f===b)f=true;this.owner=a;this.item_name=d||'';this.item_caption=e||'';this.visible=f;this.ID=c||b;this.item_type_id=g;this.item_type="";if(g)this.item_type=this.types[g-1];this.modal_options={width:560,transition:false,title:'',fields:[],close_button:true,close_caption:true,close_on_escape:true,print:false};this.items=[];if(a){if(!a.find(d))a.items.push(this);if(!(d in a))a[d]=this;this.task=a.task;}}i.prototype={constructor:i,types:["root","users","roles","tasks",'task',"catalogs","journals","tables","reports","catalog","journal","table","report","detail"],get_master_field:function(a,b){var c=0,d=a.length;for(;c<d;c++)if(a[c].ID==b)return a[c];},eachItem:function(a){var b=0,c=this.items.length,d;for(;b<c;b++){d=a.call(this.items[b],this.items[b],b);if(d===false)break;}},find:function(a){var b=0,c=this.items.length;for(;b<c;b++)if(this.items[b].item_name===a)return this.items[b];},item_by_ID:function(a){var b;if(this.ID===a)return this;var c=0,d=this.items.length;for(;c<d;c++){b=this.items[c].item_by_ID(a);if(b)return b;}},addChild:function(a,b,c,d,e){var f;if(this.getChildClass){f=this.getChildClass();if(f)return new f(this,a,b,c,d,e);}},send_request:function(a,b,c){return this.task.process_request(a,this,b,c);},init:function(a){var b=0,c=a[5],d,e=c.length,f;for(;b<e;b++){f=c[b][1];d=this.addChild(f[0],f[1],f[2],f[3],f[4]);if(d.initAttr)d.initAttr(f);d.init(f);}},bindItems:function(){var a=0,b=this.items.length;if(this.bindItem)this.bindItem();for(;a<b;a++)this.items[a].bindItems();},bindEvents:function(){var b=0,c=this.items.length,d=a.task_events['events'+this.ID];this._events=[];for(var e in d)if(d.hasOwnProperty(e)){this[e]=d[e];this._events.push([e,d[e]]);}for(;b<c;b++)this.items[b].bindEvents();},can_view:function(){return this.task.has_privilege(this,'can_view');},can_create:function(){return this.task.has_privilege(this,'can_create');},can_edit:function(){return this.task.has_privilege(this,'can_edit');},can_delete:function(){return this.task.has_privilege(this,'can_delete');},findTemplate:function(a,b){var c,d,e,f=this;if(b.template_class)d=this.task.templates.find("."+b.template_class);else while(true){e=f.item_name;if(f.item_type==="detail")e=f.owner.item_name+"-"+f.item_name;d=this.task.templates.find("."+e+"-"+a);if(d.length)break;f=f.owner;if(f===f.task)break;}if(d)c=d.clone();return c;},server:function(a,b,c){var d;if(!b)b=[];if(c)d=this.send_request('server_function',[a,b],function(a){if(a.error)throw a.error;else c.call(this,a.result);});else{d=this.send_request('server_function',[a,b]);if(d.error)throw d.error;else return d.result;}},server_function:function(a,b,c){return this.server(a,b,c);},makeFormModal:function(a,d){var e=this,f,g,h,i='',j='',k='',l,m,n='',o={title:this.item_caption,close_caption:true,close_button:true,print:false};function p(a){if(l){a.preventDefault();h.css('cursor','auto');g.css('margin-left',parseInt(g.css('margin-left'),10)+a.screenX-l);g.css('margin-top',parseInt(g.css('margin-top'),10)+a.screenY-m);l=a.screenX;m=a.screenY;}}function q(a){l=b;m=b;f.off("mousemove.modalform");f.off("mouseup.modalform");}d=c.extend({},o,d);if(!d.title)d.title='&nbsp';g=c('<div class="modal hide normal-modal-border" tabindex="-1" data-backdrop="static" data-item="'+this.item_name+'">'+'<div class="modal-header">'+'</div>'+'</div>');f=c(document);this.set_form_options(g,d);h=g.find('.modal-title');h.on("mousedown",function(a){l=a.screenX;m=a.screenY;f.on("mousemove.modalform",p);f.on("mouseup.modalform",q);});h.on("mousemove",function(a){c(this).css('cursor','move');});g.append(a);g.isModal=true;return g;},set_form_options:function(a,b,c){var d=this,f=a.find('.modal-header'),g=f.find('.modal-title'),h='',i='',j='',k='';if(b.close_button){if(e&&b.close_caption)h='&nbsp;'+e.close+' - [Esc]</small>';i='<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+h+' Ã—</button>';}if(e&&b.print)j='&nbsp;'+e.print+' - [Ctrl-P]</small>',k='<button type="button" id="print-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+j+'</button>';if(!g.length)g=('<h4 class="modal-title">'+b.title+'</h4>');else{g.detach();g.html(b.title);}f.empty();f.append(i+k);f.append(g);f.find("#close-btn").css('cursor','default').click(function(a){if(c)d.close_form(c);});f.find('#print-btn').css('cursor','default').click(function(b){d.print_message(a.find(".modal-body").clone());});},create_form:function(d,e){var f=this,g=d+'.'+this.item_name;if(this[d]){this[d].tabindex=1;if(e.container){c(a).on("keyup."+g,function(a){a.stopPropagation();if(e.onKeyUp)e.onKeyUp.call(f,a);});c(a).on("keydown."+g,function(a){a.stopPropagation();if(e.onKeyDown)e.onKeyDown.call(f,a);});e.container.append(this[d]);if(e.beforeShow)e.beforeShow.call(this);if(e.onShown)e.onShown.call(this);}else if(this[d].hasClass("modal")){this[d].on("show",function(a){a.stopPropagation();if(e.beforeShow)e.beforeShow.call(f,a);if(f[d].title)e.item_options.title=f[d].title;if(f[d].modal_width)e.item_options.width=f[d].modal_width;f.set_form_options(f[d],e.item_options,d);});this[d].on("shown",function(a){a.stopPropagation();if(e.onShown)e.onShown.call(f,a);});this[d].on("hide",function(a){var b=true;a.stopPropagation();if(e.onHide)b=e.onHide.call(f,a);if(b===false){a.preventDefault();f[d].data('closing',false);}});this[d].on("hidden",function(a){a.stopPropagation();if(e.onHidden)e.onHidden.call(f,a);f[d]=b;});this[d].on("keydown."+g,function(a){a.stopPropagation();if(e.onKeyDown)e.onKeyDown.call(f,a);});this[d].on("keyup."+g,function(a){a.stopPropagation();if(e.onKeyUp)e.onKeyUp.call(f,a);});this[d].modal({item_options:e.item_options});}}},close_form:function(d){var e=this,f=d+'.'+this.item_name,g;if(this[d]){this[d].data('closing',true);if(this[d].isModal){clearTimeout(g);g=setTimeout(function(){var a=e[d];if(a)a.modal('hide');},100);}else{c(a).off("keydown."+f);c(a).off("keyup."+f);this[d].remove();this[d]=b;}}},show_edit_form:function(a,b){var c=this,d=b.onKeyUp;b.onKeyUp=function(b){if(d)d.call(c,b);var e,f=(b.keyCode?b.keyCode:b.which);if(c[a]){e=c[a].find('.datepicker');if(e.length&&e.is(':visible')&&f===27&&!b.ctrlKey&&!b.shiftKey){b.stopImmediatePropagation();b.preventDefault();e.hide();}}};this.create_form(a,b);},print_message:function(b){var d=a.frames.dummy,e=c("link[rel='stylesheet']"),f='<head>';e.each(function(a,b){f+='<link href="'+b.href+'" rel="stylesheet">';});f+='</head>';d.document.write(f+'<body onload="window.print()">'+b.html()+'</body>');c("link[rel='stylesheet']").clone().appendTo(c("dummy").contents().find("head"));d.document.close();},message:function(a,d){var e=1,f=this,g={buttons:b,title:'',width:400,height:b,margin:b,print:false,text_center:false,button_min_width:100,center_buttons:false,close_button:true,close_on_escape:true},h,i,j='',k,l,m=c('<button type="button" class="btn">OK</button>'),n;d=c.extend({},g,d);h=d.buttons;j='<div class="modal-body"></div>';if(!this.is_empty_obj(h))j+='<div class="modal-footer"></div>';k=this.makeFormModal(c(j),d);l=k.find('.modal-body');if(d.margin)l.css('margin',d.margin);l.html(a);if(!d.title)k.find('.modal-header').remove();if(d.text_center)l.html(a).addClass("text-center");if(d.center_buttons)k.find(".modal-footer").css("text-align","center");k.find("#close-btn").click(function(a){k.modal('hide');});for(i in h)if(h.hasOwnProperty(i)){k.find(".modal-footer").append(m.clone().attr("id",i).attr("tabindex",e).html(i));e++;}k.on("shown",function(a){a.stopPropagation();k.find(".modal-footer").find('button.btn').each(function(){if(c(this).outerWidth()<d.button_min_width)c(this).outerWidth(d.button_min_width);});});k.on("hide",function(a){a.stopPropagation();});k.on("hidden",function(a){a.stopPropagation();});k.on("keyup keydown",function(a){var b=(a.keyCode?a.keyCode:a.which);a.stopPropagation();if(b===80&&a.ctrlKey){a.preventDefault();f.print_message(k.find(".modal-body").clone());}});k.on("click",".btn",function(a){var b;a.preventDefault();a.stopImmediatePropagation();for(var d in h)if(h.hasOwnProperty(d))if(c(a.target).attr("id")===d){if(h[d])b=h[d];clearTimeout(n);n=setTimeout(function(){if(b)b.call(f);k.modal('hide');},100);}});k.modal({width:d.width,height:d.height,keyboard:d.close_on_escape});return k;},question:function(a,b,c){var d={};d[e.yes]=b;d[e.no]=c;this.message(a,{buttons:d,margin:"20px 20px",text_center:true,center_buttons:true});},warning:function(a,b){var c={"OK":b};this.message(a,{buttons:c,margin:"20px 20px",text_center:true,center_buttons:true});},information:function(a,b){return this.message(a,b);},show_message:function(a,b){return this.message(a,b);},hide_message:function(a){a.modal('hide');},yesNoCancel:function(a,b,c,d){var f={};f[e.yes]=b;f[e.no]=c;f[e.cancel]=d;this.message(a,{buttons:f,margin:"20px 20px",text_center:true,width:500,center_buttons:true});},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},emptyFunc:function(){},abort:function(){throw 'abort';}};j.prototype=new i();function j(a,d){var e=this;i.call(this,b,0,a,d,true);this.task=this;this.user_info={};this.gridId=0;c('body').on('mousedown.context_menu',function(a){if(e.$context_menu){e.$context_menu.hide();e.$context_menu.detach();e.$context_menu_parent.append(e.$context_menu);e.$context_menu=b;}});}c.extend(j.prototype,{constructor:j,consts:f,getChildClass:function(){return k;},process_request:function(a,d,g,h){var i=this,j=new Date().getTime(),k=false,l={},m="application/json;charset=utf-8",n;function o(){return i.process_request(a,d,g,h);}if(h)k=true;if(this.ajaxStatusCode)l=this.ajaxStatusCode;c.ajax({url:"/api",type:"POST",contentType:m,async:k,cache:false,data:JSON.stringify({'method':'send_request','params':[a,this.user_id,this.ID,d.ID,g,j]}),statusCode:l,success:function(a){var c;if(a.error)d.warning(e.error+': '+d.item_caption+' - '+a.error);else{if(a.result.status===f.NO_PROJECT){d.warning('You need to create a project.');return;}else if(a.result.status===f.UNDER_MAINTAINANCE){if(!i.task._under_maintainance){i.task._under_maintainance=true;if(e)c=e.website_maintenance;else c='Web site currently under maintenance.';d.warning(c,function(){i.task._under_maintainance=b;});}return;}else if(a.result.status===f.NOT_LOGGED)if(!i.logged_in){i.login();return;}else location.reload();else if(i.ID>0&&a.result.version&&i.version&&a.result.version!==i.version)if(!i.task._version_changed){i.task._version_changed=true;i.information('<h4>'+e.apply_changes+'</h4>',{margin:'50px 0px',width:500,text_center:true});}if(h)h.call(d,a.result.data);else n=a.result.data;}},error:function(a,c,d){if(e)if(!i.task._server_request_error){i.task._server_request_error=true;i.warning(e.server_request_error,function(){i.task._server_request_error=b;});}},fail:function(a,b,c){console.log('ajax fail: ',a,b,c);}});if(n!==b)return n;},_byteLength:function(a){var b=a.length;for(var c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);if(d>0x7f&&d<=0x7ff)b++;else if(d>0x7ff&&d<=0xffff)b+=2;if(d>=0xDC00&&d<=0xDFFF)c--;}return b;},do_upload:function(a,b,c){var d=this,e,f,g=[],h,i='',j=[],k=';',l=new XMLHttpRequest();i+=b.length+k;i+=this._byteLength(a)+k;for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];i+=this._byteLength(f.name)+k;i+=h.byteLength+k;g.push(f.name);}j.push(i);j.push(a);for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];j.push(f.name);j.push(h);}l.open('POST','/upload',true);if(c.callback)l.onload=function(a){if(c.multiple)c.callback.call(d,d,g);else c.callback.call(d,d,g[0]);};if(c.on_progress)l.upload.onprogress=function(a){c.on_progress.call(d,d,a);};var m=new Blob(j,{type:'application/octet-stream'});l.send(m);},upload:function(a,d){var e=this,f={callback:b,on_progress:b,extension:b,multiple:false},g=c('<input type="file" style="position: absolute; top: -100px"/>');d=c.extend({},f,d);if(d.multiple)g.attr('multiple','multiple');c('body').append(g);g.on('change',function(b){var c=b.target.files,f,h,i,j=0,k,l,m=[],n,o=[];for(f=0,k;k=c[f];f++){i='';if(d.extension){h=k.name.split('.');if(h.length)i=h[h.length-1];if(i!==d.extension)continue;}o.push(k);}for(f=0;f<o.length;f++){l=o[f];n=new FileReader();n.onload=(function(b){return function(c){m.push([b,c.target.result]);if(m.length===o.length)e.do_upload(a,m,d);};})(l);n.readAsArrayBuffer(l);}g.remove();});g.click();},load:function(a){var b,g=this,h;if(!this.user_id)this.user_id=this.readCookie('user_id');this.send_request('init_client',null,function(b){var h;g.logged_in=true;d=b.settings;e=b.language;g.settings=b.settings;g.language=b.language;g.user_info=b.user_info;g.user_privileges=b.privileges;g.consts=f;g.safe_mode=g.settings.SAFE_MODE;g.version=g.settings.VERSION;g.ID=b.task[0];g.item_name=b.task[1];g.item_caption=b.task[2];g.visible=b.task[3];g.item_type="";if(b.task[4])g.item_type=g.types[b.task[4]-1];g.task=g;g.init(b.task);g.bindItems();g.bindEvents();g.templates=c("<div></div>");h=c(".templates");g.templates=h.clone();h.remove();if(g.on_page_loaded)g.on_page_loaded.call(g,g);else if(g.on_before_show_main_form)g.on_before_show_main_form.call(g,g);if(a)a.call(g);});},login:function(a){var b=this,d,e;if(this.on_login){d=this.on_login.call(this,this);this.do_login(d,a);}else{if(this.templates)e=this.templates.find("#login-form").clone();else e=c("#login-form").clone();e=this.makeFormModal(e,{title:e.data('caption'),transition:false});e.find("#login-btn").click(function(a){var c=e.find("#inputLoging").val(),d=e.find("#inputPassword").val(),f=hex_md5(d);b.user_id=b.send_request('login',[c,f]);b.createCookie('user_id',b.user_id,0.5);if(b.user_id){if(e)e.modal('hide');location.reload();}});e.find("#close-btn").click(function(a){e.modal('hide');});e.on("shown",function(a){e.find("#inputLoging").focus();a.stopPropagation();});e.find('input').keydown(function(a){var b=c(this),d=(a.keyCode?a.keyCode:a.which);if(d===40)if(b.attr('id')==='inputLoging')e.find('#inputPassword').focus();else e.find('#login-btn').focus();});e.modal({width:500});}},logout:function(a){if(this.user_id){this.send_request('logout',this.user_id);this.user_id=null;this.eraseCookie('user_id');location.reload();}},has_privilege:function(a,b){var c;if(a.task.item_name==="admin")return true;if(!this.user_privileges||a.master)return true;else{if(!this.user_privileges)return false;try{c=this.user_privileges[a.ID];}catch(d){c=null;}if(c)return c[b];else return false;}},createCookie:function(a,b,c){var d;if(c){var e=new Date();e.setTime(e.getTime()+(c*24*60*60*1000));d="; expires="+e.toGMTString();}else d="";document.cookie=escape(a)+"="+escape(b)+d+"; path=/";},readCookie:function(a){var b=escape(a)+"=";var c=document.cookie.split(';');for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)===' ')e=e.substring(1,e.length);if(e.indexOf(b)===0)return unescape(e.substring(b.length,e.length));}return null;},eraseCookie:function(a){this.createCookie(a,"",-1);},show_context_menu:function(a,b){if(a.length){b.preventDefault();this.$context_menu=a;this.$context_menu_parent=a.parent();a.detach();c('body').prepend(a);a.show();a.find('ul').css({top:b.pageY+"px",left:b.pageX+"px"}).show();}}});k.prototype=new i();k.prototype.constructor=k;function k(a,b,c,d,e,f){i.call(this,a,b,c,d,e,f);}k.prototype.getChildClass=function(){if(this.item_type==="reports")return n;else return m;};function l(a){this.item=a;this._change_id=0;this.records=[];this.logs={};this.fields=[];this.expanded=true;}l.prototype={constructor:l,get_change_id:function(){this._change_id+=1;return this._change_id+'';},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},log_changes:function(){if(this.item.master)return this.item.master.change_log.log_changes();else return this.item.log_changes;},find_record_log:function(){var a,b,c,d,e,f,g=[],h;if(this.log_changes()){if(this.item.master){b=this.item.master.change_log.find_record_log();if(b){c=b.details;d=c[this.item.ID];if(this.is_empty_obj(d)){f=this.item.fields.length;for(e=0;e<f;e++)g.push(this.item.fields[e].field_name);d={'logs':{},'records':this.item._records,'fields':g,'expanded':this.item.expanded};c[this.item.ID]=d;}this.logs=d.logs;this.records=d.records;this.fields=d.fields;this.expanded=d.expanded;}}if(this.item.record_count()){h=this.item.get_rec_change_id();if(!h){h=this.get_change_id();this.item.set_rec_change_id(h);}a=this.logs[h];if(this.is_empty_obj(a)){a={'unmodified_record':null,'record':this.cur_record(),'details':{}};this.logs[h]=a;}}return a;}},get_detail_log:function(a){var b={'records':[],'fields':[],'expanded':false},c,d;if(this.log_changes()){c=this.find_record_log();d=c.details;if(!this.is_empty_obj(d))b=d[a];return b;}},remove_record_log:function(){var a=this.item.get_rec_change_id();if(a){this.find_record_log();delete this.logs[a];this.item.set_rec_change_id(null);this.item.set_record_status(f.RECORD_UNCHANGED);}},cur_record:function(){return this.item._records[this.item.get_rec_no()];},record_modified:function(a){var b=false,c=a.unmodified_record,d=a.record;for(var e=0;e<this.item._record_lookup_index;e++)if(c[e]!==d[e]){b=true;break;}return b;},copy_record:function(a,c){var d=null,e;if(a){if(c===b)c=true;if(c)d=a.slice(0,this.item._record_info_index);else d=a.slice(0,this.item._record_lookup_index);e=this.item.get_rec_info(b,a);d.push([e[0],{},e[2]]);}return d;},can_log_changes:function(){var a=this.log_changes();if(this.item.item_state===f.STATE_EDIT){}},log_change:function(){var a;if(this.log_changes()){a=this.find_record_log();if(this.item.item_state===f.STATE_BROWSE){if((this.item.get_record_status()===f.RECORD_UNCHANGED)||(this.item.get_record_status()===f.RECORD_DETAILS_MODIFIED&&a.unmodified_record===null)){a.unmodified_record=this.copy_record(this.cur_record(),false);return;}}else if(this.item.item_state===f.STATE_INSERT)this.item.set_record_status(f.RECORD_INSERTED);else if(this.item.item_state===f.STATE_EDIT){if(this.item.get_record_status()===f.RECORD_UNCHANGED)this.item.record_status=f.RECORD_MODIFIED;else if(this.item.get_record_status()===f.RECORD_DETAILS_MODIFIED)if(this.record_modified(a))this.item.set_record_status(f.RECORD_MODIFIED);}else if(this.item.item_state===f.STATE_DELETE)if(this.item.get_record_status()===f.RECORD_INSERTED)this.remove_record_log();else this.item.set_record_status(f.RECORD_DELETED);else throw this.item.item_name+': change log invalid records state';if(this.item.master)if(this.item.master.get_record_status()===f.RECORD_UNCHANGED)this.item.master.set_record_status(f.RECORD_DETAILS_MODIFIED);}},get_changes:function(a){var c={},d,e,g,h,i,j,k,l,m,n;a.fields=this.fields;a.expanded=false;a.data=c;for(var o in this.logs)if(this.logs.hasOwnProperty(o)){d=this.logs[o];e=d.record;g=this.item.get_rec_info(b,e);if(g[f.REC_STATUS]!==f.RECORD_UNCHANGED){l=d.details;h=this.copy_record(e,false);i={};for(var j in l)if(l.hasOwnProperty(j)){k=l[j];m={};n=this.item.item_by_ID(parseInt(j,10));n.change_log.logs=k.logs;n.change_log.get_changes(m);i[j]=m;}c[o]={'record':h,'details':i};}}},set_changes:function(a){var b=a.data,c,d,e,f,g,h;this.records=[];this.logs={};this.fields=a.fields;this.expanded=a.expanded;this._change_id=0;for(var i in b)if(b.hasOwnProperty(i)){c=b[i];if(this._change_id<parseInt(i,10))this._change_id=parseInt(i,10);d=c.record;this.records.push(d);f={};this.logs[i]={'unmodified_record':null,'record':d,'details':f};e=c.details;for(var j in e)if(e.hasOwnProperty(j)){g=e[j];h=this.item.item_by_ID(parseInt(j,10));h.change_log.set_changes(g);f[j]={'logs':h.change_log.logs,'records':h.change_log.records,'fields':h.change_log.fields,'expanded':h.change_log.expanded};}}},copy_records:function(a){var b=0,c=a.length,d=[];for(b=0;b<c;b++)d.push(a[b].slice(0));return d;},store_details:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(var q=0;q<this.item.details.length;q++){c=this.item.details[q];o=c.ID;n=a[o];f={};h=[];k=[];l=true;if(n){d=n.logs;g=n.records;k=n.fields;l=n.expanded;h=this.copy_records(g);for(var r in d)if(d.hasOwnProperty(r)){e=d[r];i=e.record;j=c.change_log.copy_record(i);m=g.indexOf(i);if(m!==-1)h[m]=j;p={};c.change_log.store_details(e.details,p);f[r]={'unmodified_record':e.unmodified_record,'record':j,'details':p};}}else if(c._records)h=this.copy_records(c._records);b[o]={'logs':f,'records':h,'fields':k,'expanded':l};}},store_record_log:function(){var a,b,c,d;if(this.log_changes()){a=this.find_record_log();b={};this.store_details(a.details,b);d={};d.unmodified_record=a.unmodified_record;d.record=this.copy_record(a.record);d.details=b;}else{d={};d.record=this.copy_record(this.cur_record());b={};for(var e=0;e<this.item.details.length;e++){c=this.item.details[e];if(!c.disabled&&c._records)b[c.ID]=c._records.slice(0);}d.details=b;}return d;},restore_record_log:function(a){var b,c,d,e,g,h;if(this.log_changes()){b=this.find_record_log();c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];b.unmodified_record=a.unmodified_record;b.record=g;b.details=a.details;for(var i=0;i<this.item.details.length;i++){d=this.item.details[i];e=a.details[d.ID];if(!this.is_empty_obj(e))d._records=e.records;}if(this.item.get_record_status()===f.RECORD_UNCHANGED)this.remove_record_log();}else{c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];for(var i=0;i<this.item.details.length;i++){d=this.item.details[i];d._records=a.details[d.ID];}}},update:function(a){var c,d,e,g,h,i,j,k,l,m,n,o,p,q;if(a){d=a.changes;for(var r in d)if(d.hasOwnProperty(r)){c=d[r];e=c.log_id;g=c.rec_id;i=c.details;j=this.logs[e];k=j.record;l=j.details;m=i.length;for(var s=0;s<m;s++){h=i[s];n=h.ID;o=this.item.detail_by_ID(parseInt(n,10));p=l[n];if(!this.is_empty_obj(p)){o.change_log.logs=p.logs;o.change_log.update(h);}}if(g&&!k[this.item.id.bind_index])k[this.item.id.bind_index]=g;q=this.item.get_rec_info(b,k);q[f.REC_STATUS]=f.RECORD_UNCHANGED;q[f.REC_CHANGE_ID]=f.RECORD_UNCHANGED;delete this.logs[e];}}},prepare:function(){var a,b=this.item.fields.length;this.records=[];this.logs={};this.fields=[];for(a=0;a<b;a++)if(!this.item.fields[a].master_field)this.fields.push(this.item.fields[a].field_name);this.expanded=this.item.expanded;}};m.prototype=new i();function m(a,b,d,e,f,g){var h;i.call(this,a,b,d,e,f,g);if(this.task&&g!==0&&!(d in this.task))this.task[d]=this;this.field_defs=[];this._fields=[];this.fields=[];this.filter_defs=[];this.filters=[];this.details=[];this.controls=[];this.change_log=new l(this);this.paginate=false;this.details_active=false;this.disabled=false;this.expanded=true;this._log_changes=true;this._records=null;this._eof=false;this._bof=false;this._cur_row=null;this._old_row=0;this._old_status=null;this._buffer=null;this._modified=null;this._state=0;this._read_only=false;this._parent_read_only=true;this._active=false;this._disabled_count=0;this._open_params={};this._where_list=[];this._order_by_list=[];this._select_field_list=[];this._record_lookup_index=-1;this._record_info_index=-1;this.is_delta=false;this._pg_limit=100;this._pg_offset=0;this.is_loaded=false;this.view_options=c.extend({},this.modal_options);this.view_options.width=960;this.edit_options=c.extend({},this.modal_options);this.filter_options=c.extend({},this.modal_options);Object.defineProperty(this,"rec_no",{get:function(){return this.get_rec_no();},set:function(a){this.set_rec_no(a);}});Object.defineProperty(this,"rec_count",{get:function(){return this.record_count();}});Object.defineProperty(this,"records",{get:function(){return this.get_records();},set:function(a){this.set_records(a);}});Object.defineProperty(this,"active",{get:function(){return this.get_active();}});Object.defineProperty(this,"read_only",{get:function(){return this.get_read_only();},set:function(a){this.set_read_only(a);}});Object.defineProperty(this,"modified",{get:function(){return this.get_modified();}});Object.defineProperty(this,"filtered",{get:function(){return this.get_filtered();},set:function(a){this.set_filtered(a);}});Object.defineProperty(this,"item_state",{get:function(){return this.get_state();},set:function(a){this.set_state(a);}});Object.defineProperty(this,"record_status",{get:function(){return this.get_record_status();},set:function(a){this.set_record_status(a);}});Object.defineProperty(this,"default_field",{get:function(){return this.find_default_field();}});Object.defineProperty(this,"log_changes",{get:function(){return this.get_log_changes();},set:function(a){this.set_log_changes(a);}});Object.defineProperty(this,"auto_loading",{get:function(){return this.paginate;},set:function(a){this.paginate=a;}});}c.extend(m.prototype,{constructor:m,getChildClass:function(){return o;},initAttr:function(a){var b,c=a[6],d=a[7],e;if(c){e=c.length;for(b=0;b<e;b++){this.field_defs.push(c[b]);new p(this,c[b]);}}if(d){e=d.length;for(b=0;b<e;b++){this.filter_defs.push(d[b]);new q(this,d[b]);}}this.reports=a[8];},bindItem:function(){var a=0,b,c;this.prepare_fields();this.init_options();this.prepare_filters();b=this.reports.length;c=this.reports;this.reports=[];for(a=0;a<b;a++)this.reports.push(this.task.item_by_ID(c[a]));},prepare_fields:function(){var a=0,c=this._fields.length,d;for(;a<c;a++){d=this._fields[a];if(d.lookup_item&&(typeof d.lookup_item==="number")){d.lookup_item=this.task.item_by_ID(d.lookup_item);if(d.lookup_field&&(typeof d.lookup_field==="number"))d.lookup_field=d.lookup_item._field_by_ID(d.lookup_field).field_name;}if(d.master_field&&(typeof d.master_field==="number"))d.master_field=this.get_master_field(this._fields,d.master_field);}this.fields=this._fields.slice(0);for(a=0;a<c;a++){d=this.fields[a];if(this[d.field_name]===b)this[d.field_name]=d;}},prepare_filters:function(){var a=0,b,c;b=this.filters.length;for(a=0;a<b;a++){c=this.filters[a].field;if(c.lookup_item&&(typeof c.lookup_item==="number"))c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}},init_options:function(){var a,b=[],d=[],e=this._fields.length;for(a=0;a<e;a++){if(this._fields[a].view_visible&&this._fields[a].view_index!==-1)b.push(this._fields[a]);if(this._fields[a].edit_visible&&this._fields[a].edit_index!==-1)d.push(this._fields[a]);}b.sort(function(a,b){if(a.view_index>b.view_index===0)return 0;if(a.view_index>b.view_index)return 1;else return -1;});d.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});this.view_options.fields=[];for(a=0;a<b.length;a++)this.view_options.fields.push(b[a].field_name);this.edit_options.fields=[];for(a=0;a<d.length;a++)this.edit_options.fields.push(d[a].field_name);this.edit_options.title=this.item_caption;this.view_options.title=this.item_caption;this._edit_options=c.extend({},this.edit_options);this._view_options=c.extend({},this.view_options);},each:function(a){var b;if(this._active){this.first();while(!this.eof()){b=a.call(this,this);if(b===false)break;else this.next();}}},eachRecord:function(a){this.each(a);},eachField:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},eachFilter:function(a){var b=0,c=this.filters.length,d;for(;b<c;b++){d=a.call(this.filters[b],this.filters[b],b);if(d===false)break;}},eachDetail:function(a){var b=0,c=this.details.length,d;for(;b<c;b++){d=a.call(this.details[b],this.details[b],b);if(d===false)break;}},_field_by_name:function(a){return this.field_by_name(a,this._fields);},field_by_name:function(a,c){var d=0,e,f;if(c===b)c=this.fields;e=c.length;for(;d<e;d++)if(c[d].field_name===a)return c[d];return f;},_field_by_ID:function(a){return this.field_by_ID(a,this._fields);},field_by_ID:function(a,c){var d=0,e;if(c===b)c=this.fields;e=c.length;for(;d<e;d++)if(c[d].ID===a)return c[d];},filter_by_name:function(a){var b=0,c=this.filters.length;try{return this.filters[a];}catch(d){for(;b<c;b++)if(this.filters[b].filter_name===a)return this.filters[b];}},detail_by_name:function(a){var b=0,c=this.details.length;try{return this.details[a];}catch(d){for(;b<c;b++)if(this.details[b].item_name===a)return this.details[b];}},system_field_name:function(a){if(a==='id'||a==='deleted'||a==='owner_id'||a==='owner_rec_id')return true;},get_records:function(){var a,b,c=[];if(this.active){b=this._records.length;for(a=0;a<b;a++)c.push(this._records[a].slice(0,this._record_info_index));return c;}},set_records:function(a){this._records=a;},copy:function(a){var b,d,e,f,g,h,i={filters:true,details:true,handlers:true};h=new m(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);h.master=this.master;h.item_type=this.item_type;a=c.extend({},i,a);h.ID=this.ID;h.item_name=this.item_name;h.expanded=this.expanded;h.field_defs=this.field_defs;h.filter_defs=this.filter_defs;h._edit_options=this._edit_options;h._view_options=this._view_options;h.edit_options=c.extend({},this._edit_options);h.view_options=c.extend({},this._view_options);e=h.field_defs.length;for(d=0;d<e;d++)new p(h,h.field_defs[d]);h.prepare_fields();if(a.filters){e=h.filter_defs.length;for(d=0;d<e;d++)new q(h,h.filter_defs[d]);h.prepare_filters();}h._events=this._events;if(a.handlers){e=this._events.length;for(d=0;d<e;d++)h[this._events[d][0]]=this._events[d][1];}if(a.handlers)for(var j in this)if(this.hasOwnProperty(j))if((j.substring(0,3)==="on_")&&(typeof this[j]==="function"))h[j]=this[j];if(a.details)this.eachDetail(function(c,d){b=c.copy(a);b.owner=h;b.expanded=c.expanded;b.master=h;b.item_type=c.item_type;h.details.push(b);h.items.push(b);if(!(b.item_name in h))h[b.item_name]=b;if(!(b.item_name in h.details))h.details[b.item_name]=b;});return h;},clone:function(a){var c,d,e,g,h;if(a===b)a=true;c=new m(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);c.master=this.master;c.item_type=this.item_type;c.ID=this.ID;c.item_name=this.item_name;c.field_defs=this.field_defs;c.filter_defs=this.filter_defs;e=c.field_defs.length;for(d=0;d<e;d++)g=new p(c,c.field_defs[d]);c.prepare_fields();e=c.fields.length;for(d=0;d<e;d++){g=c.fields[d];if(c[g.field_name]!==b)delete c[g.field_name];}c.fields=[];e=this.fields.length;for(d=0;d<e;d++){g=this.fields[d];h=c._field_by_name(g.field_name);c.fields.push(h);if(c[h.field_name]===b)c[h.field_name]=h;}c.bind_fields();c._records=this._records;if(a){c.on_filter_record=this.on_filter_record;c.filtered=this.filtered;}c._active=true;c.set_state(f.STATE_BROWSE);c.first();return c;},store_handlers:function(){var a={};for(var b in this)if(this.hasOwnProperty(b))if((b.substring(0,3)==="on_")&&(typeof this[b]==="function"))a[b]=this[b];return a;},clear_handlers:function(){for(var a in this)if(this.hasOwnProperty(a))if((a.substring(0,3)==="on_")&&(typeof this[a]==="function"))this[a]=b;},load_handlers:function(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b];},get_log_changes:function(){return this._log_changes;},set_log_changes:function(a){this._log_changes=a;},get_modified:function(){return this._modified;},set_modified:function(a){this._modified=a;if(this.master&&a)this.master.set_modified(a);}});c.extend(m.prototype,{bind_fields:function(a){var c=0;if(a===b)a=true;this.eachField(function(a,b){a.bind_index=null;a.lookup_index=null;});this.eachField(function(a,b){if(!a.master_field){a.bind_index=c;c+=1;}});this.eachField(function(a,b){if(a.master_field)a.bind_index=a.master_field.bind_index;});this._record_lookup_index=c;if(a)this.eachField(function(a,b){if(a.lookup_item){a.lookup_index=c;c+=1;}});this._record_info_index=c;},set_select_fields:function(a){this._select_field_list=a;},set_order_by:function(a){this._order_by_list=this.get_order_by_list(a);},get_order_by_list:function(a){var b,c,d,e,f,g,h=[];g=a.length;for(f=0;f<g;f++){b=a[f];c=b;d=false;if(b[0]==='-'){d=true;c=b.substring(1);}try{e=this.field_by_name(c);}catch(i){throw this.item_name+': set_order_by method arument error - '+b+' '+i;}h.push([e.ID,d]);}return h;},set_where:function(a){this._where_list=this.get_where_list(a);},get_where_list:function(a){var b,c,d,e,g,i,j,k=[];for(c in a)if(a.hasOwnProperty(c)){d=c;i=a[c];j=c.indexOf('__');if(j>-1){g=c.substring(j+2);c=c.substring(0,j);}else g='eq';e=h.indexOf(g);if(e!==-1)e+=1;else throw this.item_name+': set_where method arument error - '+d;b=this._field_by_name(c);if(!b)throw this.item_name+': set_where method arument error - '+d;if(i!==null){if(b.data_type===f.DATETIME)i=b.format_date_to_string(i,'%Y-%m-%d %H:%M:%S');k.push([c,e,i]);}}return k;},do_before_open:function(a,c,d,e,g,h,i,j,k,l){var m,n,o,p,q=[];h.__expanded=a;h.__fields=[];o=this.fields.length;for(n=0;n<o;n++){p=this.fields[n];if(this[p.field_name]!==b)delete this[p.field_name];}this.fields=[];if(c===b&&this._select_field_list.length)c=this._select_field_list;if(c){o=c.length;for(n=0;n<o;n++)this.fields.push(this._field_by_name(c[n]));h.__fields=c;}else this.fields=this._fields.slice(0);o=this.fields.length;for(n=0;n<o;n++){p=this.fields[n];if(this[p.field_name]===b)this[p.field_name]=p;}h.__open_empty=g;if(!g){h.__limit=0;h.__offset=0;if(j){h.__limit=j;if(i)h.__offset=i;}if(d)q=this.get_where_list(d);else if(this._where_list.length)q=this._where_list.slice(0);else this.eachFilter(function(a,b){if(a.get_value()!==null)q.push([a.field.field_name,a.filter_type,a.get_value()]);});if(h.__search!==b){var r=h.__search[0],s=h.__search[1];q.push([r,f.FILTER_SEARCH,s]);}h.__filters=q;if(e)h.__order=this.get_order_by_list(e);else if(this._order_by_list.length)h.__order=this._order_by_list.slice(0);this._where_list=[];this._order_by_list=[];if(k)h.__funcs=k;if(l)h.__group_by=l;}this._sorted_fields=[];this._sorted_desc=false;this._open_params=h;if(this.on_before_open)m=this.on_before_open.call(this,this,h);return m;},do_after_open:function(){if(this.on_after_open)this.on_after_open.call(this,this);},open_details:function(a){var b=this,c=0;function d(){c-=1;if(c===0)a.call(b);}if(!this.grid_keydown){if(a){this.eachDetail(function(a,b){if(!a.disabled)c+=1;});this.eachDetail(function(a,b){if(!a.disabled)a.open(d);});}else this.eachDetail(function(a,b){if(!a.disabled)a.open();});}else if(a)a.call(this);},find_change_log:function(){if(this.master)if(this.master.get_record_status()!==f.RECORD_UNCHANGED)return this.master.change_log.get_detail_log(this.ID);},open:function(){var a,c=0,d=arguments.length,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this.details_active,w=this;if(d>2)throw item.item_name+' open method error: invalid number of arguments';for(;c<d;c++)switch(typeof arguments[c]){case "function":o=arguments[c];break;case "object":e=arguments[c];break;}if(e){g=e.expanded;h=e.fields;i=e.where;j=e.order_by;k=e.open_empty;n=e.params;s=e.offset;r=e.limit;l=e.funcs;m=e.group_by;}if(!n)n={};if(g===b)g=this.expanded;else this.expanded=g;p=o?true:false;if(this.master)if(!this.disabled&&this.master.record_count()>0){n.__owner_id=this.master.ID;if(this.master.id)n.__owner_rec_id=this.master.id.get_value();if(this.master.is_new())u=[];else{q=this.find_change_log();if(q){u=q.records;h=q.fields;g=q.expanded;}}if(u!==b){if(this.do_before_open(g,h,i,j,k,n,s,r,l,m)!==false){this.bind_fields(g);this._records=u;this._active=true;this.set_state(f.STATE_BROWSE);this.first();this.do_after_open();this.update_controls(f.UPDATE_OPEN);if(o)o.call(this,this);}return;}}else return;if(this.paginate&&s!==b){n=this._open_params;n.__offset=s;if(this.on_before_open)a=this.on_before_open.call(this,this,n);}else{s=0;a=this.do_before_open(g,h,i,j,k,n,s,r,l,m);this.bind_fields(g);}if(a!==false){if(this.paginate)n.__limit=this._pg_limit;this.change_log.prepare();this._records=[];this.do_open(s,p,n,k,function(){w.details_active=false;try{w._active=true;w.set_state(f.STATE_BROWSE);w._cur_row=null;w.first();w.do_after_open();w.update_controls(f.UPDATE_OPEN);if((s===0)&&w.on_filter_applied)w.on_filter_applied.call(w,w);}finally{w.details_active=v;}if(w.details_active)w.open_details(o);else if(o)o.call(w,w);});}},do_open:function(a,b,c,d,e){var f=this,g;if(b&&!d)this.send_request('open',c,function(b){f.do_after_upload(b,a,e);});else{if(d)g=[[],''];else g=this.send_request('open',c);this.do_after_upload(g,a,e);}},do_after_upload:function(a,c,d){var e,f,g,h;if(a){f=a[1];if(f)this.warning(f);else if(a[0]){e=a[0];h=e.length;if(c!==b)this._records.length=0;for(g=0;g<h;g++)this._records.push(e[g]);if(this._pg_limit&&this.paginate&&e){this._pg_offset=c;this.is_loaded=false;}if(h<this._pg_limit)this.is_loaded=true;d.call(this,this);}}else{this._records=[];console.log(this.item_name+" error while opening table");}},close:function(){this._active=false;this._records=null;this._cur_row=null;this.close_details();this.update_controls(f.UPDATE_CLOSE);},close_details:function(){var a=this.details.length;if(!this.grid_keydown)for(var b=0;b<a;b++)this.details[b].close();},"TEXT":1,"INTEGER":2,"FLOAT":3,"CURRENCY":4,"DATE":5,"DATETIME":6,"BOOLEAN":7,"BLOB":8,sort:function(a){var b=this,c,d,e=[],g=[],h;function i(a,b){if(a===null)if(b===f.TEXT)a='';else if(b===f.INTEGER||b===f.FLOAT||b===f.CURRENCY)a=0;else if(b===f.DATE||b===f.DATETIME)a=new Date(0);else if(b===f.BOOLEAN)a=false;if(b===f.FLOAT)a=Number(a.toFixed(10));if(b===f.CURRENCY)a=Number(a.toFixed(2));return a;}function j(a,c){var d,f,h,j,k,l,m;for(var d=0;d<e.length;d++){f=b.field_by_name(e[d]);j=f.bind_index;if(f.lookup_item)j=f.lookup_index;h=f.get_lookup_data_type();l=i(a[j],h);m=i(c[j],h);if(l<m)k=-1;if(l>m)k=1;if(k){if(g[d])k=-k;return k;}}return 0;}for(c=0;c<a.length;c++){d=a[c];if(d.charAt(0)==='-'){e.push(d.substring(1));g.push(true);}else{e.push(d);g.push(false);}}this._records.sort(j);this.update_controls();},search:function(a,b){var c=b.trim(),d={};if(c.length){d.__search=[a,c];this.open({params:d});}else this.open();},total_records:function(a){var b=this;if(this._open_params.__open_empty&&a)return 0;else this.send_request('get_record_count',this._open_params,function(c){if(c&&a)a.call(b,c[0]);});},new_record:function(){var a=[];this.eachField(function(b,c){if(!b.master_field)a.push(null);});if(this.expanded)this.eachField(function(b,c){if(b.lookup_item)a.push(null);});return a;},do_before_append:function(){if(this.on_before_append)return this.on_before_append.call(this,this);},do_after_append:function(){if(this.on_after_append)this.on_after_append.call(this,this);},append:function(){if(!this._active)throw this.item_name+": can't append record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't append record - master item is not in edit or insert mode";if(this.get_state()!==f.STATE_BROWSE)throw this.item_name+": can't append record - item is not in browse mode";if(this.do_before_append()!==false)if(this.do_before_scroll()!==false){this._old_row=this.get_rec_no();this.set_state(f.STATE_INSERT);this._records.push(this.new_record());this._cur_row=this._records.length-1;this._modified=false;this.set_record_status(f.RECORD_INSERTED);this.update_controls(f.UPDATE_APPEND);this.do_after_scroll();this.do_after_append();}},insert:function(){if(!this._active)throw this.item_name+": can't insert record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't insert record - master item is not in edit or insert mode";if(this.get_state()!==f.STATE_BROWSE)throw this.item_name+": can't insert record - item is not in browse mode";if(this.do_before_append()!==false)if(this.do_before_scroll()!==false){this._old_row=this.get_rec_no();this.set_state(f.STATE_INSERT);this._records.splice(0,0,this.new_record());this._cur_row=0;this._modified=false;this.set_record_status(f.RECORD_INSERTED);this.update_controls(f.UPDATE_INSERT);this.do_after_scroll();this.do_after_append();}},copy_rec:function(){var a,b,c;if(!this._active)throw this.item_name+": can't copy record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't copy record - master item is not in edit or insert mode";if(this.get_state()!==f.STATE_BROWSE)throw this.item_name+": can't copy record - item is not in browse mode";if(this.record_count()===0)throw this.item_name+": can't edit record - item record list is empty";c=this.get_rec_no();if(this.do_before_append()!==false)if(this.do_before_scroll()!==false){this._old_row=c;this.set_state(f.STATE_INSERT);this._buffer=this._records[c].slice(0);this._records.push(this.new_record());this._cur_row=this._records.length-1;c=this.get_rec_no();b=this._records[c].length;for(a=0;a<b;a++)if(a<this._record_info_index)this._records[c][a]=this._buffer[a];this._records[c][this.id.bind_index]=null;this._buffer=null;this._modified=false;this.set_record_status(f.RECORD_INSERTED);this.update_controls(f.UPDATE_APPEND);this.do_after_scroll();this.do_after_append();}},do_before_edit:function(){if(this.on_before_edit)return this.on_before_edit.call(this,this);},do_after_edit:function(){if(this.on_after_edit)this.on_after_edit.call(this,this);},edit:function(){if(!this._active)throw this.item_name+": can't edit record - item is not active";if(this.record_count()===0)throw this.item_name+": can't edit record - item record list is empty";if(this.master&&!this.master.is_changing())throw this.item_name+": can't edit record - master item is not in edit or insert mode";if(this.get_state()!==f.STATE_BROWSE)throw this.item_name+": can't edit record - item is not in browse mode";if(this.do_before_edit()!==false){this.change_log.log_change();this._buffer=this.change_log.store_record_log();this.set_state(f.STATE_EDIT);this._old_row=this.get_rec_no();this._old_status=this.get_record_status();this._modified=false;this.do_after_edit();}},do_before_cancel:function(){if(this.on_before_cancel)return this.on_before_cancel.call(this,this);},do_after_cancel:function(){if(this.on_after_cancel)this.on_after_cancel.call(this,this);},cancel:function(){var a,b,c,d,e=this._modified;c=this.get_rec_no();if(this.do_before_cancel()!==false){if(this.get_state()===f.STATE_EDIT){this.change_log.restore_record_log(this._buffer);this.update_controls(f.UPDATE_CANCEL);for(var a=0;a<this.details.length;a++)this.details[a].update_controls(f.UPDATE_OPEN);}else if(this.get_state()===f.STATE_INSERT){this.change_log.remove_record_log();this.update_controls(f.UPDATE_DELETE);this._records.splice(c,1);}else throw this.item_name+' cancel error: invalid item state';d=this.get_state();this.set_state(f.STATE_BROWSE);if(d===f.STATE_INSERT)this.do_before_scroll();this._cur_row=this._old_row;if(d===f.STATE_EDIT)this.set_record_status(this._old_status);this._modified=false;if(d===f.STATE_INSERT)this.do_after_scroll();this.do_after_cancel();}},is_browsing:function(){return this.get_state()===f.STATE_BROWSE;},is_changing:function(){return(this.get_state()===f.STATE_INSERT)||(this.get_state()===f.STATE_EDIT);},is_new:function(){return this.get_state()===f.STATE_INSERT;},is_editing:function(){return this.get_state()===f.STATE_EDIT;},is_deleting:function(){return this.get_state()===f.STATE_DELETE;},do_before_delete:function(a){if(this.on_before_delete)return this.on_before_delete.call(this,this);},do_after_delete:function(){if(this.on_after_delete)this.on_after_delete.call(this,this);},"delete":function(){var a=this.get_rec_no();if(!this._active)throw this.item_name+": can't delete record - item is not active";if(this.record_count()===0)throw this.item_name+": can't delete record - item record list is empty";if(this.master&&!this.master.is_changing())throw this.item_name+": can't delete record - master item is not in edit or insert mode";this.set_state(f.STATE_DELETE);try{if(this.record_count()>0)if(this.do_before_delete()!==false)if(this.do_before_scroll()!==false){this.update_controls(f.UPDATE_DELETE);this.change_log.log_change();if(this.master)this.master.set_modified(true);this._records.splice(a,1);this.set_rec_no(a);this.do_after_scroll();this.set_state(f.STATE_BROWSE);this.do_after_delete();}}finally{this.set_state(f.STATE_BROWSE);}},detail_by_ID:function(a){var b;if(typeof a==="string")a=parseInt(a,10);this.eachDetail(function(c,d){if(c.ID===a){b=c;return false;}});return b;},post:function(a){var b,c,d,e=this.get_state(),g;if(!this.is_changing())throw this.item_name+' post method: dataset is not in edit or insert mode';if(this.on_before_post)g=this.on_before_post.call(this,this);this.check_record_valid();if(g!==false){d=this.details.length;for(c=0;c<d;c++)if(this.details[c].is_changing())this.details[c].post();if(this.item_state===f.STATE_INSERT||(this.item_state===f.STATE_EDIT&&this.get_modified()))this.change_log.log_change();this.set_modified(false);if(this.master)this.master.set_modified(true);this.set_state(f.STATE_BROWSE);if(!this.valid_record()){this.update_controls(f.UPDATE_DELETE);this.search_record(this.get_rec_no(),0);}if(this.on_after_post)this.on_after_post.call(this,this);}},get_change_id:function(){this._change_id=this._change_id+1;return this._change_id;},clear_log:function(a){var b,c,d,e,g,h;for(var i in a)if(a.hasOwnProperty(i)){b=a[i][0];c=a[i][1];d=b[b.length-1];d[f.REC_STATUS]=null;d[f.REC_CHANGE_ID]=null;for(var j in c)if(c.hasOwnProperty(j)){e=c[j][0];g=c[j][1];h=c[j][2];this.clear_log(e);}}},apply:function(){var a=0,b=arguments.length,c=this,d={},e,g,h,i=true;for(;a<b;a++)switch(typeof arguments[a]){case "function":e=arguments[a];break;case "object":g=arguments[a];break;}this.change_log.get_changes(d);if(!this.master&&!this.change_log.is_empty_obj(d.data)){if(this.item_state!==f.STATE_BROWSE)throw 'Item: '+this.item_name+' is not is browse state. Apply is only possible in browse state.';if(this.on_before_apply)this.on_before_apply.call(this,this);if(e)this.send_request('apply_changes',[d,g],function(a){c.process_apply(a);});else{h=this.send_request('apply_changes',[d,g]);i=this.process_apply(h);}}return i;},process_apply:function(a){if(a)if(a.error)throw a.error;else{this.change_log.update(a.result);if(this.on_after_apply)this.on_after_apply.call(this,this);return true;}},delta:function(a){var c,d,e,g;if(a===b){a={};this.change_log.get_changes(a);}g=this.copy({filters:false,details:true,handlers:false});g.expanded=false;g.is_delta=true;d=g.details.length;for(c=0;c<d;c++){g.details[c].expanded=false;g.details[c].is_delta=true;}g.details_active=true;g.change_log.set_changes(a);g._records=g.change_log.records;g.bind_fields(g.change_log.expanded);g.set_state(f.STATE_BROWSE);g._cur_row=null;g._active=true;g.first();return g;},field_by_id:function(a,b,c){var d,e,f;if(typeof b==='string')b=[b];d=this.copy();d.set_where({id:a});if(c){d.open({expanded:false,fields:b},function(){e=d._records[0];if(b.length===1)e=e[0];return e;});}else{d.open({expanded:false,fields:b});if(d.record_count()===1){e=d._records[0];if(b.length===1)e=e[0];return e;}}},locate:function(a,b){var c=this.clone();function d(){var d,e;if(a instanceof Array){e=a.length;for(d=0;d<e;d++)if(c.field_by_name(a[d]).value!==b[d])return false;return true;}else if(c.field_by_name(a).value===b)return true;}c.first();while(!c.eof()){if(d()){this.rec_no=c.rec_no;return true;}c.next();}}});c.extend(m.prototype,{get_active:function(){return this._active;},set_read_only:function(a){var b,c;this._read_only=a;c=this.fields.length;for(b=0;b<c;b++)this.fields[b].update_controls();this.eachDetail(function(b,c){b.set_read_only(a);});},get_read_only:function(){if(this.master&&this._parent_read_only)return this.master.get_read_only();else return this._read_only;},get_filtered:function(){return this._filtered;},set_filtered:function(a){if(a)if(!this.on_filter_record)a=false;if(this._filtered!==a){this._filtered=a;this.first();this.update_controls(f.UPDATE_OPEN);}},clear_filters:function(){this.eachFilter(function(a){a.value=null;});},assign_filters:function(a){var b=this;a.eachFilter(function(a){if(a.value===null)b.filter_by_name(a.filter_name).field.value=null;else b.filter_by_name(a.filter_name).field.value=a.field.value;});},set_state:function(a){if(this._state!==a){this._state=a;if(this.on_state_changed)this.on_state_changed.call(this,this);}},get_state:function(){return this._state;},disable_detail_records:function(){var a=this.details.length;for(var b=0;b<a;b++)this.close_details();},do_after_scroll:function(){this.update_controls(f.UPDATE_SCROLLED);if(this.on_after_scroll)this.on_after_scroll.call(this,this);if(this.details_active)this.open_details();else this.disable_detail_records();},do_before_scroll:function(){if(this._cur_row!==null){if((this.get_state()===f.STATE_INSERT)||(this.get_state()===f.STATE_EDIT))this.post();if(this.on_before_scroll)return this.on_before_scroll.call(this,this);}},skip:function(a){var b,c,d,e;if(this.record_count()===0){this.do_before_scroll();this._eof=true;this._bof=true;this.do_after_scroll();}else{d=this._cur_row;b=false;c=false;e=a;if(e<0){e=0;c=true;}if(e>=this._records.length){e=this._records.length-1;b=true;}this._eof=b;this._bof=c;if(d!==e){if(this.do_before_scroll()!==false){this._cur_row=e;this.do_after_scroll();}}else if(b||c&&this.is_new()&&this.record_count()===1){this.do_before_scroll();this.do_after_scroll();}}},set_rec_no:function(a){if(this._active)if(this.filter_active())this.search_record(a,0);else this.skip(a);},get_rec_no:function(){if(this._active)return this._cur_row;},filter_active:function(){if(this.on_filter_record&&this.filtered)return true;},first:function(){if(this.filter_active())this.find_first();else this.set_rec_no(0);},last:function(){if(this.filter_active())this.find_last();else this.set_rec_no(this._records.length);},next:function(){if(this.filter_active())this.find_next();else this.set_rec_no(this.get_rec_no()+1);},prior:function(){if(this.filter_active())this.find_prior();else this.set_rec_no(this.get_rec_no()-1);},eof:function(){return this._eof;},bof:function(){return this._bof;},valid_record:function(){if(this.on_filter_record&&this.filtered)return this.on_filter_record.call(this,this);else return true;},search_record:function(a,b){var c,d=this;b=b||1;function e(){if(d.record_count()===0){d._eof=true;d._bof=true;}else{d._eof=false;d._bof=false;if(d._cur_row<0){d._cur_row=0;d._bof=true;}if(d._cur_row>=d._records.length){d._cur_row=d._records.length-1;d._eof=true;}}}function f(){if(b===1)return d.eof();else return d.bof();}if(this.active){if(this.record_count()===0){this.skip(a);return;}this._cur_row=a+b;e();if(b===0){if(this.valid_record()){this.skip(a);return;}b=1;}while(!f())if(this.valid_record()){if(a!==this._cur_row){c=this._cur_row;this._cur_row=a;this.skip(c);return;}}else{this._cur_row=this._cur_row+b;e();}}},find_first:function(){this.search_record(-1,1);},find_last:function(){this.search_record(this._records.length,-1);},find_next:function(){this.search_record(this.get_rec_no(),1);},find_prior:function(){this.search_record(this.get_rec_no(),-1);},record_count:function(){if(this._records)return this._records.length;else return 0;},find_rec_info:function(a,c){if(c===b)if(a===b){a=this.get_rec_no();if(this.record_count()>0)c=this._records[a];}if(c&&(this._record_info_index>0)){if(c.length<this._record_info_index+1)c.push([null,{},null]);return c[this._record_info_index];}},get_rec_info:function(a,b){return this.find_rec_info(a,b);},get_record_status:function(){var a=this.get_rec_info();if(a)return a[f.REC_STATUS];},set_record_status:function(a){var b=this.get_rec_info();if(b&&this.log_changes)b[f.REC_STATUS]=a;},rec_controls_info:function(){var a=this.get_rec_info();if(a)return a[f.REC_CONTROLS_INFO];},get_rec_change_id:function(){var a=this.get_rec_info();if(a)return a[f.REC_CHANGE_ID];},set_rec_change_id:function(a){var b=this.get_rec_info();if(b)b[f.REC_CHANGE_ID]=a;},rec_unchanged:function(){return this.get_record_status()===f.RECORD_UNCHANGED;},rec_inserted:function(){return this.get_record_status()===f.RECORD_INSERTED;},rec_deleted:function(){return this.get_record_status()===f.RECORD_DELETED;},rec_modified:function(){return this.get_record_status()===f.RECORD_MODIFIED||this.get_record_status()===f.RECORD_DETAILS_MODIFIED;}});c.extend(m.prototype,{_add_record:function(a,b){var c;if(this.can_create()){if(this.is_editing()){c=true;this.post();}if(!(this.is_new())){b;b.call(this);}if(this.is_new())this.create_edit_form(a);else if(c)this.edit();}},insert_record:function(a){var b=this;this._add_record(a,function(){b.insert();});},append_record:function(a){var b=this;this._add_record(a,function(){b.append();});},copy_record:function(a){if(this.can_create()&&this.record_count())if(!(this.is_changing())){this.copy_rec();this.create_edit_form(a);}},edit_record:function(a){if(this.can_edit())if(this.record_count()>0){if(!this.is_changing())this.edit();this.create_edit_form(a);}},cancel_edit:function(){this.close_edit_form();this.cancel();},delete_record:function(a){var b=this,c=b.get_rec_no(),d=b._records[c],f;if(this.can_delete())if(this.record_count()>0){this.question(e.delete_record,function(){b["delete"]();try{b.apply();}catch(g){f=(g+'').toUpperCase();if(f&&f.indexOf('FOREIGN KEY')!==-1&&(f.indexOf('VIOLATION')!==-1||f.indexOf('FAILED')!==-1))b.warning(e.cant_delete_used_record);else b.warning(g);b._records.splice(c,0,d);b._cur_row=c;b.change_log.remove_record_log();b.update_controls();b.do_after_scroll();if(a)a.call(this);}});}else this.warning('Record is not selected.');},check_record_valid:function(){var a=true;this.eachField(function(a,b){var c,d;try{a.check_valid();}catch(e){d=a.controls.length;for(c=0;c<d;c++){a.controls[c].error=e;a.controls[c].updateState(false);}a.check_valid();}});return a;},post_record:function(){try{this.post();this.close_edit_form();}catch(a){}},apply_record:function(a){try{this.post();this.apply(a);this.close_edit_form();}catch(b){}},do_on_view_keyup:function(a){if(this.task.on_view_keyup)this.task.on_view_keyup.call(this,this,a);if(this.owner.on_view_keyup)this.owner.on_view_keyup.call(this,this,a);if(this.on_view_keyup)this.on_view_keyup.call(this,this,a);},do_on_view_keydown:function(a){if(this.task.on_view_keydown)this.task.on_view_keydown.call(this,this,a);if(this.owner.on_view_keydown)this.owner.on_view_keydown.call(this,this,a);if(this.on_view_keydown)this.on_view_keydown.call(this,this,a);},view_modal:function(a){this.is_lookup_item=true;this.view(a);},view:function(a){var d=this;this.view_form=c("<div></div>").append(this.findTemplate("view",this.view_options));if(!a)this.view_form=this.makeFormModal(this.view_form,this.view_options);this.create_form('view_form',{container:a,item_options:this.view_options,beforeShow:function(){if(this.task.on_before_show_view_form)this.task.on_before_show_view_form.call(this,this);if(this.owner.on_before_show_view_form)this.owner.on_before_show_view_form.call(this,this);if(this.on_before_show_view_form)this.on_before_show_view_form.call(this,this);},onShown:function(){if(d.task.on_after_show_view_form)d.task.on_after_show_view_form.call(d,d);if(d.owner.on_after_show_view_form)d.owner.on_after_show_view_form.call(d,d);if(d.on_after_show_view_form)d.on_after_show_view_form.call(d,d);},onHide:function(a){var c,e;if(d.on_view_form_close_query)e=d.on_view_form_close_query.call(d,d);if(e===b&&d.owner.on_view_form_close_query&&!d.master)e=d.owner.on_view_form_close_query.call(d,d);if(e===b&&d.task.on_view_form_close_query)e=d.task.on_view_form_close_query.call(d,d);return e;},onHidden:function(){this.close();},onKeyUp:this.do_on_view_keyup,onKeyDown:this.do_on_view_keydown});},close_view_form:function(){this.close_form('view_form');},do_on_edit_keyup:function(a){if(this.task.on_edit_keyup)this.task.on_edit_keyup.call(this,this,a);if(this.owner.on_edit_keyup)this.owner.on_edit_keyup.call(this,this,a);if(this.on_edit_keyup)this.on_edit_keyup.call(this,this,a);},do_on_edit_keydown:function(a){if(this.task.on_edit_keydown)this.task.on_edit_keydown.call(this,this,a);if(this.owner.on_edit_keydown)this.owner.on_edit_keydown.call(this,this,a);if(this.on_edit_keydown)this.on_edit_keydown.call(this,this,a);},create_edit_form:function(){var a=this,d,e,f=arguments.length;if(f)for(var g=0;g<f;g++)if(!d&&arguments[g] instanceof jQuery)d=arguments[g];else if(!e&&typeof arguments[g]==="function")e=arguments[g];this.edit_form=c("<div></div>").append(this.findTemplate("edit",this.edit_options));if(!d)this.edit_form=this.makeFormModal(this.edit_form,this.edit_options);this.show_edit_form('edit_form',{container:d,item_options:this.edit_options,beforeShow:function(){if(a.task.on_before_show_edit_form)a.task.on_before_show_edit_form.call(a,a);if(a.owner.on_before_show_edit_form&&!a.master)a.owner.on_before_show_edit_form.call(a,a);if(a.on_before_show_edit_form)a.on_before_show_edit_form.call(a,a);},onShown:function(){if(a.task.on_after_show_edit_form)a.task.on_after_show_edit_form.call(a,a);if(a.owner.on_after_show_edit_form&&!a.master)a.owner.on_after_show_edit_form.call(a,a);if(a.on_after_show_edit_form)a.on_after_show_edit_form.call(a,a);if(e)e.call(a);},onHide:function(c){var d,e;if(a.on_edit_form_close_query)e=a.on_edit_form_close_query.call(a,a);if(e===b&&a.owner.on_edit_form_close_query&&!a.master)e=a.owner.on_edit_form_close_query.call(a,a);if(e===b&&a.task.on_edit_form_close_query)e=a.task.on_edit_form_close_query.call(a,a);return e;},onKeyUp:this.do_on_edit_keyup,onKeyDown:this.do_on_edit_keydown});},close_edit_form:function(){this.close_form('edit_form');},create_filter_form:function(){var a=this,d,e,f=arguments.length;if(f)for(var g=0;g<f;g++)if(!d&&arguments[g] instanceof jQuery)d=arguments[g];else if(!e&&typeof arguments[g]==="function")e=arguments[g];this.filter_form=c("<div></div>").append(this.findTemplate("filter",this.filter_options));if(!d)this.filter_form=this.makeFormModal(this.filter_form,this.filter_options);this.show_edit_form('filter_form',{container:d,item_options:this.filter_options,beforeShow:function(){if(a.task.on_before_show_filter_form)a.task.on_before_show_filter_form.call(a,a);if(a.owner.on_before_show_filter_form)a.owner.on_before_show_filter_form.call(a,a);if(a.on_before_show_filter_form)a.on_before_show_filter_form.call(a,a);},onShown:function(){if(a.task.on_after_show_filter_form)a.task.on_after_show_filter_form.call(a,a);if(a.owner.on_after_show_filter_form&&!a.master)a.owner.on_after_show_filter_form.call(a,a);if(a.on_after_show_filter_form)a.on_after_show_filter_form.call(a,a);},onHide:function(c){var d,e;if(a.on_filter_form_close_query)e=a.on_filter_form_close_query.call(a,a);if(e===b&&a.owner.on_filter_form_close_query)e=a.owner.on_filter_form_close_query.call(a,a);if(e===b&&a.task.on_filter_form_close_query)e=a.task.on_filter_form_close_query.call(a,a);return e;}});},close_filter_form:function(){this.close_form('filter_form');},apply_filter:function(){this.open();this.close_filter_form();},get_status_text:function(){var a='',b='';this.eachFilter(function(a,c){if((a.visible)&&a.get_value())if(a.field.data_type===f.BOOLEAN){if(a.get_value())b+=a.filter_caption+' ';}else{if(b)b+=' ';b+=a.filter_caption+': '+a.field.get_display_text();}});if(b)a=e.filter+' - '+b;return a;},close_filter:function(){this.close_filter_form();},disable_controls:function(){this._disabled_count-=1;},enable_controls:function(){this._disabled_count+=1;if(this.controls_enabled())this.update_controls(f.UPDATE_CONTROLS);},controls_enabled:function(){return this._disabled_count===0;},controls_disabled:function(){return !this.controls_enabled();},update_controls:function(a){var c=0,d=this.fields.length;if(a===b)a=f.UPDATE_REFRESH;if(this.controls_enabled()){for(c=0;c<d;c++)this.fields[c].update_controls(true);d=this.controls.length;if(this.on_update_controls)this.on_update_controls.call(this,this);for(c=0;c<d;c++)this.controls[c].update(a);}},create_table:function(a,b){return new t(this,a,b);},create_grid:function(a,b){return this.create_table(a,b);},create_tree:function(a,b,c,d,e){return new s(this,a,b,c,d,e);},create_inputs:function(a,d){var e,f,g,h,i,j=[],k=[],l=[],m,n;e={fields:[],col_count:1,label_on_top:false,row_count:b,tabindex:b};if(!a)return;d=c.extend({},e,d);if(d.fields.length)k=d.fields;else k=this.edit_options.fields;g=k.length;for(f=0;f<g;f++){i=this.field_by_name(k[f]);if(i)j.push(i);else throw this.item_name+' create_entries: there is not a field with field_name - "'+k.fields[f]+'"';}a.empty();n=c("<form></form>").appendTo(c("<div></div>").addClass("row-fluid").appendTo(a));if(!d.label_on_top)n.addClass("form-horizontal");g=j.length;for(h=0;h<d.col_count;h++)l.push(c("<div></div>").addClass("span"+12/d.col_count).appendTo(n));m=d.tabindex;if(!m&&this.edit_form){m=this.edit_form.tabindex;this.edit_form.tabindex+=g;}if(!d.row_count)d.row_count=Math.ceil(g/d.col_count);for(f=0;f<g;f++)new w(j[f],f+m,l[Math.floor(f/d.row_count)],d.label_on_top);},create_entries:function(a,b){this.create_inputs(a,b);},create_filter_inputs:function(a,d){var e,f,g,h,i=[],j=[],k,l;e={filters:[],col_count:1,label_on_top:false,tabindex:b},d=c.extend({},e,d);if(d.filters.length){g=d.filters.length;for(f=0;f<g;f++)i.push(this.filter_by_name(d.filters[f]));}else this.eachFilter(function(a,b){if(a.visible)i.push(a);});a.empty();l=c("<form></form>").appendTo(c("<div></div>").addClass("row-fluid").appendTo(a));if(!d.label_on_top)l.addClass("form-horizontal");g=i.length;for(h=0;h<d.col_count;h++)j.push(c("<div></div>").addClass("span"+12/d.col_count).appendTo(l));k=d.tabindex;if(!k&&this.filter_form){k=this.filter_form.tabindex;this.filter_form.tabindex+=g;}for(f=0;f<g;f++)new w(i[f].field,f+1,j[Math.floor(f%d.col_count)],d.label_on_top,i[f].filter_caption);},create_filter_entries:function(a,b){this.create_filter_inputs(a,b);},set_lookup_field_value:function(){if(this.record_count()){var a=this.lookup_field,b=this.field_by_name(a.lookup_field),c=null,d=this.lookup_field.owner,e={},g=[],h=this;if(b)c=b.get_value();if(a.filter&&a.filter.filter_type===f.FILTER_IN)a.set_value([this.id.value],c);else{if(d)d.eachField(function(c){if(c.master_field===a){b=h.field_by_name(c.lookup_field);if(b)e[c.field_name]=b.get_value();}});a.set_value(this.id.get_value(),c,e,this);}}if(this.is_lookup_item)this.close_view_form();},find_default_field:function(){var a=0,b=this.fields.length;for(;a<b;a++)if(this.fields[a].is_default)return this.fields[a];},set_edit_fields:function(a){this.edit_options.fields=a;},set_view_fields:function(a){this.view_options.fields=a;},round:function(a,b){return Number(a.toFixed(b));},refresh_record:function(a){var b=this,c,d,e=[],g=this.copy({filters:false,details:false,handlers:false});if(this.id.value!==null){b.eachField(function(a){e.push(a.field_name);});g.open({expanded:this.expanded,fields:e,where:{id:this.id.value}});if(g.record_count()===1){d=g._records[0].length;for(c=0;c<d;c++)b._records[b.rec_no][c]=g._records[0][c];b.update_controls(f.UPDATE_CANCEL);if(a)a.call(this);}}}});n.prototype=new i();function n(a,b,d,e,g,h){i.call(this,a,b,d,e,g,h);if(this.task&&!(d in this.task))this.task[d]=this;this._fields=[];this.params=this._fields;this._state=f.STATE_EDIT;this.param_options=c.extend({},this.modal_options);}c.extend(n.prototype,{constructor:n,set_state:function(a){if(this._state!==a)this._state=a;},get_state:function(){return this._state;},initAttr:function(a){var b,c=a[6],d;if(c){d=c.length;for(b=0;b<d;b++)new r(this,c[b]);}},bindItem:function(){var a=0,b,c=this.params.length;for(a=0;a<c;a++){b=this.params[a];if(b.lookup_item&&(typeof b.lookup_item==="number"))b.lookup_item=this.task.item_by_ID(b.lookup_item);if(b.lookup_field&&(typeof b.lookup_field==="number"))b.lookup_field=b.lookup_item._field_by_ID(b.lookup_field).field_name;}this.param_options.title=this.item_caption;},eachParam:function(a){var b=0,c=this.params.length,d;for(;b<c;b++){d=a.call(this.params[b],this.params[b],b);if(d===false)break;}},eachField:function(a){this.eachParam(a);},param_by_name:function(a){var b=0,c=this.params.length;for(;b<c;b++)if(this.params[b].param_name===a)return this.params[b];},create_params_form:function(){var a=this,d,e,f=arguments.length;if(f)for(var g=0;g<f;g++)if(!d&&arguments[g] instanceof jQuery)d=arguments[g];else if(!e&&typeof arguments[g]==="function")e=arguments[g];this.params_form=c("<div></div>").append(this.findTemplate("params",this.param_options));if(!d)this.params_form=this.makeFormModal(this.params_form,this.param_options);this.show_edit_form('params_form',{container:d,item_options:this.param_options,beforeShow:function(){if(a.task.on_before_show_params_form)a.task.on_before_show_params_form.call(a,a);if(a.owner.on_before_show_params_form)a.owner.on_before_show_params_form.call(a,a);if(a.on_before_show_params_form)a.on_before_show_params_form.call(a,a);},onShown:function(){if(a.task.on_after_show_params_form)a.task.on_after_show_params_form.call(a,a);if(a.owner.on_after_show_params_form)a.owner.on_after_show_params_form.call(a,a);if(a.on_after_show_params_form)a.on_after_show_params_form.call(a,a);},onHide:function(c){var d,e;if(a.on_params_form_close_query)e=a.on_params_form_close_query.call(a,a);if(e===b&&a.owner.on_params_form_close_query)e=a.owner.on_params_form_close_query.call(a,a);if(e===b&&a.task.on_params_form_close_query)e=a.task.on_params_form_close_query.call(a,a);return e;}});},close_params_form:function(){this.close_form('params_form');},print_report:function(){var a=0,b=arguments.length,c=true,d;for(;a<b;a++)switch(typeof arguments[a]){case "function":d=arguments[a];break;case "boolean":c=arguments[a];break;}if(!c)this.eachParam(function(a){if(a.edit_visible){c=true;return false;}});if(c)this.create_params_form();else this.process_report(d);},checkParams:function(){var a,b=this.params.length;for(a=0;a<b;a++)try{this.params[a].check_valid();}catch(c){this.warning(c);return false;}return true;},process_report:function(b){var c=this,d=location.protocol+'//'+location.hostname+(location.port?':'+location.port:''),e,f,g=[];if(this.checkParams()){if(this.owner.on_before_print_report)this.owner.on_before_print_report.call(this,this);if(this.on_before_print_report)this.on_before_print_report.call(this,this);f=this.params.length;for(e=0;e<f;e++)g.push(this.params[e].get_raw_value());this.send_request('print_report',[g,d,this.extension],function(d){var e,f,g,h,i;if(d){e=d.url;f=d.error;}if(f)c.warning(f);if(e){g=e.split('.').pop();if(g==='ods')a.open(e,"_self");else{i=a.open(e,"_blank");if(c.send_to_printer)i.onload=function(){i.print();h=setTimeout(function(){i.onfocus=function(){i.close();};},1000);};}}if(b)b.call(c,c,e);});return true;}},create_params:function(a,b){this.create_param_inputs(a,b);},create_param_inputs:function(a,d){var e,f,g,h,i=[],j=[],k,l;e={params:[],col_count:1,label_on_top:false,tabindex:b},this.options=c.extend({},e,d);if(this.options.params.length){g=this.options.params.length;for(f=0;f<g;f++)i.push(this.param_by_name(this.options.params[f]));}else{this.eachParam(function(a){if(a.edit_visible&&a.edit_index!==-1)i.push(a);});i.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});}a.empty();k=c("<form></form>").appendTo(c("<div></div>").addClass("row-fluid").appendTo(a));if(!this.options.label_on_top)k.addClass("form-horizontal");g=i.length;for(h=0;h<this.options.col_count;h++)j.push(c("<div></div>").addClass("span"+12/this.options.col_count).appendTo(k));l=this.options.tabindex;if(!l&&this.params_form){l=this.params_form.tabindex;this.params_form.tabindex+=g;}for(f=0;f<g;f++)new w(i[f],f+l,j[Math.floor(f%this.options.col_count)],this.options.label_on_top);}});o.prototype=new m();o.prototype.constructor=o;function o(a,b,c,d,e,f){m.call(this,a,b,c,d,e,f);this.master=a;a.details.push(this);a.details[c]=this;this.item_type="detail";}o.prototype.getChildClass=function(){return b;};function p(a,b){this.owner=a;this.set_info(b);this.controls=[];this.bind_index=null;this.lookup_index=null;this.field_type=this.type_names[this.data_type];this.field_kind=f.ITEM_FIELD;if(a)a._fields.push(this);Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"raw_value",{get:function(){return this.get_raw_value();}});Object.defineProperty(this,"text",{get:function(){return this.get_text();},set:function(a){this.set_text(a);}});Object.defineProperty(this,"display_text",{get:function(){return this.get_display_text();},set:function(a){this.set_display_text(a);}});Object.defineProperty(this,"lookup_text",{get:function(){return this.get_lookup_text();},set:function(a){this.set_lookup_text(a);}});Object.defineProperty(this,"lookup_value",{get:function(){return this.get_lookup_value();},set:function(a){this.set_lookup_value(a);}});Object.defineProperty(this,"alignment",{get:function(){return this.get_alignment();},set:function(a){this.set_alignment(a);}});Object.defineProperty(this,"read_only",{get:function(){return this.get_read_only();},set:function(a){this.set_read_only(a);}});}p.prototype={constructor:p,attr:["ID","field_name","field_caption","data_type","required","lookup_item","master_field","lookup_field","view_visible","view_index","edit_visible","edit_index","_read_only","_expand","_word_wrap","field_size","is_default","calculated","editable","_alignment","value_list"],type_names:["","text","integer","float",'currency',"date","datetime","boolean","blob"],copy:function(a){var b=new p(a,this.get_info());b.lookup_item=this.lookup_item;b.lookup_field=this.lookup_field;return b;},get_info:function(){var a,b=this.attr.length,c=[];for(a=0;a<b;a++)c.push(this[this.attr[a]]);return c;},set_info:function(a){if(a){var b,c=this.attr.length;for(b=0;b<c;b++)this[this.attr[b]]=a[b];}},get_row:function(){if(this.owner._records)return this.owner._records[this.owner.get_rec_no()];else throw 'An attempt to get a field value in the empty dataset - item: '+this.owner.item_name;},get_data:function(){var a;if(this.field_kind===f.ITEM_FIELD){a=this.get_row();if(a&&this.bind_index>=0)return a[this.bind_index];}else return this._value;},set_data:function(a){var b;if(this.field_kind===f.ITEM_FIELD){b=this.get_row();if(b&&this.bind_index>=0)b[this.bind_index]=a;}else this._value=a;},get_lookup_data:function(){var a;if(this.field_kind===f.ITEM_FIELD){a=this.get_row();if(a&&this.lookup_index>=0)return a[this.lookup_index];}else return this._lookup_value;},set_lookup_data:function(a){var b;if(this.field_kind===f.ITEM_FIELD){b=this.get_row();if(b&&this.lookup_index>=0)b[this.lookup_index]=a;}else this._lookup_value=a;},get_text:function(){var a="",b="";try{a=this.get_value();if(a!==null)switch(this.data_type){case f.TEXT:break;case f.INTEGER:a=this.int_to_str(a);break;case f.FLOAT:a=this.float_to_str(a);break;case f.CURRENCY:a=this.float_to_str(a);break;case f.DATE:a=this.date_to_str(a);break;case f.DATETIME:a=this.datetime_to_str(a);break;case f.BOOLEAN:if(this.get_value())a=e.yes;else a=e.no;break;}else a="";}catch(c){a='';b=this.field_caption+": "+this.type_error();this.do_on_error(b);}if(typeof a!=='string')a='';return a;},set_text:function(a){var b="";if(a!==this.get_text())try{switch(this.data_type){case f.TEXT:this.set_value(a);break;case f.INTEGER:this.set_value(this.str_to_int(a));break;case f.FLOAT:this.set_value(this.str_to_float(a));break;case f.CURRENCY:this.set_value(this.str_to_float(a));break;case f.DATE:this.set_value(this.str_to_date(a));break;case f.DATETIME:this.set_value(this.str_to_datetime(a));break;case f.BOOLEAN:if(e)if(a.length&&a.toUpperCase().trim()===e.yes.toUpperCase().trim())this.set_value(true);else this.set_value(false);else if(a.length&&(a[0]==='T'||a[0]==='t'))this.set_value(true);else this.set_value(false);break;default:this.set_value(a);}}catch(c){b=this.field_caption+": "+this.type_error();this.do_on_error(b);}},convert_date_time:function(a){if(a.search('.')!==-1)a=a.split('.')[0];return this.format_string_to_date(a,'%Y-%m-%d %H:%M:%S');},convert_date:function(a){if(a.search(' ')!==-1)a=a.split(' ')[0];return this.format_string_to_date(a,'%Y-%m-%d');},get_raw_value:function(){var a=this.get_data();if(this.data_type===f.DATETIME&&a)a=a.replace('T',' ');return a;},get_value:function(){var a=this.get_raw_value();if(a===null)switch(this.data_type){case f.TEXT:a='';break;case f.INTEGER:a=0;break;case f.FLOAT:a=0;break;case f.CURRENCY:a=0;break;case f.BOOLEAN:a=false;break;}else switch(this.data_type){case f.DATE:a=this.convert_date(a);break;case f.DATETIME:a=this.convert_date_time(a);break;case f.BOOLEAN:return a?true:false;break;}return a;},do_on_change_lookup_field:function(a,c){var d=this;if(a===b)a=null;if(this.lookup_item)if(this.master_field)this.master_field.do_on_change_lookup_field(null);else{this.set_lookup_data(a);if(this.owner)this.owner.eachField(function(a,e){if(d===a.master_field&&c!==b){a.set_lookup_data(c[a.field_name]);a.update_controls();}});}},do_before_changed:function(a,b){if(this.field_kind===f.ITEM_FIELD){if(this.owner.get_state()!==f.STATE_INSERT&&this.owner.get_state()!==f.STATE_EDIT)throw this.owner.item_name+' is not in edit or insert mode';if(this.owner.on_before_field_changed)return this.owner.on_before_field_changed.call(this.owner,this,a,b);}},set_value:function(a,b,c,d){var e;if(this.field_kind===f.ITEM_FIELD)if(((this.field_name==='id'&&this.value)||this.field_name==='deleted')&&(self.value!==a))throw this.owner.item_name+': can not change value of the system field - '+this.field_name;this.new_value=null;if(a!==null){this.new_value=a;switch(this.data_type){case f.INTEGER:this.new_value=a;if(typeof a==="string")this.new_value=parseInt(a,10);break;case f.FLOAT:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case f.CURRENCY:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case f.BOOLEAN:this.new_value=a?1:0;break;case f.DATE:this.new_value=this.format_date_to_string(a,'%Y-%m-%d');break;case f.DATETIME:this.new_value=this.format_date_to_string(a,'%Y-%m-%d %H:%M:%S');break;case f.TEXT:this.new_value=a+'';break;}}if(this.get_raw_value()!==this.new_value){if(this.do_before_changed(this.new_value,b)!==false){try{this.set_data(this.new_value);}catch(g){e=this.field_caption+": "+this.type_error();this.do_on_error(e);}this.new_value=null;this.do_on_change_lookup_field(b,c);this.set_modified(true);this.do_after_changed(d);}}else if(b&&b!==this.get_lookup_value()){this.do_on_change_lookup_field(b,c);this.do_after_changed(d);}},set_modified:function(a){if(this.field_kind===f.ITEM_FIELD)if(this.owner.set_modified&&!this.calculated)this.owner.set_modified(a);},get_lookup_data_type:function(){if(this.lookup_item)return this.lookup_item._field_by_name(this.lookup_field).data_type;else return this.data_type;},get_lookup_value:function(){var a=null;if(this.lookup_item&&this.get_value()){a=this.get_lookup_data();switch(this.get_lookup_data_type()){case f.DATE:if(typeof a==="string")a=this.convert_date(a);break;case f.DATETIME:if(typeof a==="string")a=this.convert_date_time(a);break;case f.BOOLEAN:if(a)return true;else return false;break;}}else a=this.get_value();return a;},set_lookup_value:function(a){if(this.lookup_item){this.set_lookup_data(a);this.update_controls();}},get_lookup_text:function(){var a=this,b,c='';try{if(this.lookup_item){if(this.get_value())c=this.get_lookup_value();if(c===null)c='';else{b=this.get_lookup_data_type();if(b)switch(b){case f.DATE:c=this.date_to_str(c);break;case f.DATETIME:c=this.datetime_to_str(c);break;case f.FLOAT:c=this.float_to_str(c);break;case f.CURRENCY:c=this.cur_to_str(c);break;}}}}catch(d){}return c;},set_lookup_text:function(a){if(this.lookup_item){if(a)switch(this.get_lookup_data_type()){case f.DATE:a=this.str_to_date(a);break;case f.DATETIME:a=this.str_to_datetime(a);break;case f.FLOAT:a=this.str_to_float(a);break;case f.CURRENCY:a=this.str_to_cur(a);break;}this.set_lookup_data(a);this.update_controls();}else this.set_text(a);},get_display_text:function(){var a,c='';if(this.lookup_item)c=this.get_lookup_text();else if(this.value_list)try{c=this.value_list[this.get_value()-1];}catch(d){}else if(this.data_type===f.CURRENCY){if(this.raw_value!==null)c=this.cur_to_str(this.get_value());}else c=this.get_text();if(this.owner&&this.owner.on_get_field_text)if(!this.on_get_field_text_called){this.on_get_field_text_called=true;try{a=this.owner.on_get_field_text.call(this.owner,this);if(a!==b)c=a;}finally{this.on_get_field_text_called=false;}}if(c===b)c='';return c;},set_read_only:function(a){this._read_only=a;this.update_controls();},get_read_only:function(){var a=this._read_only;if(this.owner&&this.owner._parent_read_only&&this.owner.get_read_only())a=this.owner.get_read_only();return a;},set_visible:function(a){this._visible=a;this.update_controls();},get_visible:function(){return this._visible;},set_alignment:function(a){this._alignment=a;this.update_controls();},get_alignment:function(){return this._alignment;},set_expand:function(a){this._expand=a;this.update_controls();},get_expand:function(){return this._expand;},set_word_wrap:function(a){this._word_wrap=a;this.update_controls();},get_word_wrap:function(){return this._word_wrap;},check_type:function(){this.get_value();if((this.data_type===f.TEXT)&&(this.field_size!==0)&&(this.get_text().length>this.field_size))this.do_on_error(this.field_caption+': '+e.invalid_length.replace('%d',this.field_size));return true;},check_reqired:function(){if(!this.required)return true;else if(this.get_raw_value()!==null)return true;else this.do_on_error(this.field_caption+': '+e.value_required);},check_valid:function(){var a;if(this.check_reqired())if(this.check_type()){if(this.owner&&this.owner.on_field_validate){a=this.owner.on_field_validate.call(this.owner,this);if(a){this.do_on_error(a);return;}}return true;}},do_after_changed:function(a){if(this.owner&&this.owner.on_field_changed)this.owner.on_field_changed.call(this.owner,this,a);if(this.filter&&this.filter.owner.on_filter_changed)this.filter.owner.on_filter_changed.call(this.filter.owner,this.filter);this.update_controls();},do_on_error:function(a){throw a;},system_field:function(){if(this.field_name==='id'||this.field_name==='deleted'||this.field_name==='owner_id'||this.field_name==='owner_rec_id')return true;},update_controls:function(a){var b,c;c=this.controls.length;for(b=0;b<c;b++)this.controls[b].update();if(!a&&this.owner&&this.owner.controls){c=this.owner.controls.length;for(b=0;b<c;b++)this.owner.controls[b].update_field(this);}},type_error:function(){switch(this.data_type){case f.INTEGER:return e.invalid_int.replace('%s','');case f.FLOAT:return e.invalid_float.replace('%s','');case f.CURRENCY:return e.invalid_cur.replace('%s','');case f.DATE:return e.invalid_date.replace('%s','');case f.DATE_TIME:return e.invalid_date.replace('%s','');case f.BOOLEAN:return e.invalid_bool.replace('%s','');default:return e.invalid_value.replace('%s','');}},valid_char_code:function(a){var b=String.fromCharCode(a),c=a>=48&&a<=57,e=b==='.'||b===d.DECIMAL_POINT||b===d.MON_DECIMAL_POINT,g=b==='+'||b==='-';if(this.data_type===f.INTEGER)if(!c&&!g)return false;if(this.data_type===f.FLOAT||this.data_type===f.CURRENCY)if(!c&&!g&&!e)return false;return true;},str_to_int:function(a){var b=parseInt(a,10);if(isNaN(b))throw "invalid integer value";return b;},str_to_date:function(a){return this.format_string_to_date(a,d.D_FMT);},str_to_datetime:function(a){return this.format_string_to_date(a,d.D_T_FMT);},str_to_float:function(a){var b;a=a.replace(d.DECIMAL_POINT,".");a=a.replace(d.MON_DECIMAL_POINT,".");b=parseFloat(a);if(isNaN(b))throw "invalid float value";return b;},str_to_cur:function(a){var b=c.trim(a);if(d.MON_THOUSANDS_SEP)b=b.replace(d.MON_THOUSANDS_SEP,'');if(d.CURRENCY_SYMBOL)b=c.trim(b.replace(d.CURRENCY_SYMBOL,''));if(d.POSITIVE_SIGN)b=b.replace(d.POSITIVE_SIGN,'');if(d.NEGATIVE_SIGN&&b.indexOf(d.NEGATIVE_SIGN)!==-1){b=b.replace(d.NEGATIVE_SIGN,'');b='-'+b;}b=c.trim(b.replace(d.MON_DECIMAL_POINT,'.'));b=parseFloat(b);return b;},int_to_str:function(a){return a.toString();},float_to_str:function(a){var b=(''+a.toFixed(6)).replace(".",d.DECIMAL_POINT),c=b.length-1,e='';for(;c>=0;c--)if((b[c]==='0')&&(e.length===0))continue;else e=b[c]+e;if(e.slice(e.length-1)===d.DECIMAL_POINT)e=e+'0';return e;},date_to_str:function(a){return this.format_date_to_string(a,d.D_FMT);},datetime_to_str:function(a){return this.format_date_to_string(a,d.D_T_FMT);},cur_to_str:function(a){var b,c,e,f,g,h=0,i,j=a.toFixed(d.FRAC_DIGITS);if(isNaN(j[0]))j=j.slice(1,j.length);b=j.indexOf('.');c='';e=j;if(b>=0){e=j.slice(0,b);c=j.slice(b+1,j.length);}j='';i=e.length;for(f=0;f<i;f++){g=e[i-f-1];j=g+j;h+=1;if((h%3===0)&&(f!==i-1))j=d.MON_THOUSANDS_SEP+j;}if(c)j=j+d.MON_DECIMAL_POINT+c;if(a<0){if(d.N_SIGN_POSN===3)j=d.NEGATIVE_SIGN+j;else if(d.N_SIGN_POSN===4)j=d.result+d.NEGATIVE_SIGN;}else if(d.P_SIGN_POSN===3)j=d.POSITIVE_SIGN+j;else if(d.P_SIGN_POSN===4)j=j+d.POSITIVE_SIGN;if(d.CURRENCY_SYMBOL)if(a<0)if(d.N_CS_PRECEDES)if(d.N_SEP_BY_SPACE)j=d.CURRENCY_SYMBOL+' '+j;else j=d.CURRENCY_SYMBOL+j;else if(d.N_SEP_BY_SPACE)j=j+' '+d.CURRENCY_SYMBOL;else j=j+d.CURRENCY_SYMBOL;else if(d.P_CS_PRECEDES)if(d.P_SEP_BY_SPACE)j=d.CURRENCY_SYMBOL+' '+j;else j=d.CURRENCY_SYMBOL+j;else if(d.P_SEP_BY_SPACE)j=j+' '+d.CURRENCY_SYMBOL;else j=j+d.CURRENCY_SYMBOL;if(a<0){if(d.N_SIGN_POSN===0&&d.NEGATIVE_SIGN)j=d.NEGATIVE_SIGN+'('+j+')';else if(d.N_SIGN_POSN===1)j=d.NEGATIVE_SIGN+j;else if(d.N_SIGN_POSN===2)j=j+d.NEGATIVE_SIGN;}else if(d.P_SIGN_POSN===0&&d.POSITIVE_SIGN)j=d.POSITIVE_SIGN+'('+j+')';else if(d.P_SIGN_POSN===1)j=d.POSITIVE_SIGN+j;else if(d.P_SIGN_POSN===2)j=j+d.POSITIVE_SIGN;return j;},parseDateInt:function(a,b){var c=parseInt(a.substring(0,b),10);if(isNaN(c))throw 'invalid date';return c;},format_string_to_date:function(a,b){var c='',d=a,e,f,g,h=0,i=0,j=0;for(var k=0;k<b.length;++k){c=b.charAt(k);switch(c){case "%":break;case "d":e=this.parseDateInt(d,2);d=d.slice(2);break;case "m":f=this.parseDateInt(d,2);d=d.slice(2);break;case "Y":g=this.parseDateInt(d,4);d=d.slice(4);break;case "H":h=this.parseDateInt(d,2);d=d.slice(2);break;case "M":i=this.parseDateInt(d,2);d=d.slice(2);break;case "S":j=this.parseDateInt(d,2);d=d.slice(2);break;default:d=d.slice(c.length);}}return new Date(g,f-1,e,h,i,j);},leftPad:function(a,b,c){var d=a.toString();while(d.length<b)d=c+d;return d;},format_date_to_string:function(a,b){var c='',d='';for(var e=0;e<b.length;++e){c=b.charAt(e);switch(c){case "%":break;case "d":d+=this.leftPad(a.getDate(),2,'0');break;case "m":d+=this.leftPad(a.getMonth()+1,2,'0');break;case "Y":d+=a.getFullYear();break;case "H":d+=this.leftPad(a.getHours(),2,'0');break;case "M":d+=this.leftPad(a.getMinutes(),2,'0');break;case "S":d+=this.leftPad(a.getSeconds(),2,'0');break;default:d+=c;}}return d;},select_from_view_form:function(){var a=this.lookup_item.copy();a.is_lookup_item=true;a.details_active=false;a.lookup_field=this;if(this.owner&&this.owner.on_param_lookup_item_show)this.owner.on_param_lookup_item_show.call(this.owner,this,a);if(this.owner&&this.owner.on_field_lookup_item_show)this.owner.on_field_lookup_item_show.call(this.owner,this,a);if(this.filter&&this.filter.owner.on_filter_lookup_item_show)this.filter.owner.on_filter_lookup_item_show.call(this.filter.owner,this.filter,a);a.view();}};function q(a,b){var c=this,d;this.owner=a;this.set_info(b);if(a){a.filters.push(this);if(!(this.filter_name in a.filters))a.filters[this.filter_name]=this;if(this.field_name){d=this.owner._field_by_ID(this.field_name);this.field=new p();this.field.set_info(d.get_info());this.field._read_only=false;this.field.filter=this;this.field._value=null;this.field._lookup_value=null;this.field.field_kind=f.FILTER_FIELD;}}Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});}q.prototype={constructor:q,attr:["filter_name","filter_caption","field_name","filter_type","data_type","visible"],copy:function(a){var b=new q(a,this.get_info());return b;},get_info:function(){var a,b=this.attr.length,c=[];for(a=0;a<b;a++)c.push(this[this.attr[a]]);return c;},set_info:function(a){if(a){var b,c=this.attr.length;for(b=0;b<c;b++)this[this.attr[b]]=a[b];}},get_value:function(){return this.field.get_raw_value();},set_value:function(a,b){this.field.set_value(a,b);}};r.prototype=new p();r.prototype.constructor=p;function r(a,c){p.call(this,a,c);this.param_name=this.field_name;this.param_caption=this.field_caption;this.field_size=0;this.report=a;this._value=null;this._lookup_value=null;this.field_kind=f.PARAM_FIELD;if(this.owner[this.param_name]===b)this.owner[this.param_name]=this;}function s(a,b,c,d,e,f){this.init(a,b,c,d,e,f);}s.prototype={constructor:s,init:function(a,d,e){var f=this,g={id_field:b,parent_field:b,text_field:b,parent_of_root_value:b,text_tree:b,on_click:b,on_dbl_click:b};this.id=a.task.controlId++;this.item=a;this.$container=d;this.options=c.extend({},g,e);this.$element=c('<div class="dbtree '+this.item.item_name+'" tabindex="0" style="overflow-x:auto; overflow-y:auto;"></div>');this.$element.css('position','relative');this.$element.data('tree',this);this.$element.tabindex=0;this.item.controls.push(this);this.$element.bind('destroyed',function(){f.item.controls.splice(f.item.controls.indexOf(f),1);});this.$element.appendTo(this.$container);this.height(d.height());this.$element.on('focus blur',function(a){f.select_node(f.selected_node,false);});this.$element.on('keyup',function(a){f.keyup(a);});this.$element.on('keydown',function(a){f.keydown(a);});if(a.get_active()&&this.$container.width())this.build();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('closing');return false;},height:function(a){if(a)this.$element.height(a);else return this.$element.height();},is_focused:function(){return this.$element.get(0)===document.activeElement;},scroll_into_view:function(){this.select_node(this.selected_node);},update:function(a){var b,c=this,d;if(this.form_closing())return;switch(a){case f.UPDATE_OPEN:this.build();break;case f.UPDATE_CANCEL:this.changed();break;case f.UPDATE_APPEND:this.changed();break;case f.UPDATE_INSERT:this.changed();break;case f.UPDATE_DELETE:this.changed();break;case f.UPDATE_SCROLLED:this.syncronize();break;case f.UPDATE_CONTROLS:this.syncronize();break;case f.UPDATE_CLOSE:this.$element.empty();break;case f.UPDATE_REFRESH:this.build();break;}},keydown:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(this.selected_node&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.toggle_expanded(this.selected_node);break;case 38:a.preventDefault();c=this.selected_node.prev();if(c.length)this.select_node(c);else{c=this.selected_node.parent().parent();if(c.length&&c.prop("tagName")==="LI")this.select_node(c);}break;break;case 40:a.preventDefault();if(this.selected_node.hasClass('parent')&&!this.selected_node.hasClass('collapsed')){c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}else{c=this.selected_node.next();if(c.length)this.select_node(c);else{c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}}break;}},keyup:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 13:break;case 38:break;case 40:break;}},build_child_nodes:function(a,b){var c=0,d=b.length,e,f,g,h,i,j,k,l,m,n,o,p;for(c=0;c<d;c++){e=b[c];f=e.id;g=e.text;h=e.rec;i='<span class="empty-bullet"></span>',j="",k="",o=this.child_nodes[f+''];if(o&&o.length){i='<i class="icon-chevron-right bullet"></i>';j=' parent';k='collapsed';}l='<li class="'+k+j+'" style="list-style: none" data-rec="'+h+'">'+'<div><span class="tree-bullet">'+i+'</span>'+'<span class="tree-text">'+g+'<span></div>';a+=l;if(o&&o.length){a+='<ul style="display: none">';a=this.build_child_nodes(a,o);a+='</ul>';}a+='</li>';a+='</li>';}return a;},collect_nodes:function(a){var c=a[this.options.id_field],d=a[this.options.parent_field],e=a[this.options.text_field],f;this.child_nodes={};a.first();while(!a.eof()){f=this.child_nodes[d.value+''];if(f===b){f=[];this.child_nodes[d.value+'']=f;}f.push({'id':c.value,'text':e.display_text,'rec':a.rec_no});a.next();}},build:function(){var a=this,b=this.item.clone(),d='<ul>',e,f,g,h,i,j,k;this.collect_nodes(b);this.$element.empty();k=this.child_nodes[this.options.parent_of_root_value+''];if(k&&k.length)d=this.build_child_nodes(d,k);d+='</ul>';this.$element.append(c(d));j=this.$element.find('li');f=j.length;for(e=0;e<f;e++){i=j.eq(e);g=i.data('rec');b.set_rec_no(g);this.item._cur_row=g;i.data("record",b._records[g]);h=b.rec_controls_info();h[this.id]=i.get();if(this.options.node_callback)this.options.node_callback(i,this.item);}this.select_node(j.eq(0));this.$element.off('click','li.parent > div span.tree-bullet');this.$element.on('click','li.parent > div span.tree-bullet',function(b){var d=c(this),e=d.parent().parent(),f;a.toggle_expanded(e);b.preventDefault();b.stopPropagation();});this.$element.off('click','li > div span.tree-text');this.$element.on('click','li > div span.tree-text',function(b){var d=c(this).parent().parent();a.select_node(d);});},toggle_expanded:function(a){var b=a.find('div:first span.tree-bullet'),c;if(a.hasClass('parent')){c=a.find('ul:first'),a.toggleClass('collapsed');if(a.hasClass('collapsed'))b.html('<i class="icon-chevron-right bullet"></i>');else b.html('<i class="icon-chevron-down bullet"></i>');c.slideToggle(0);}},expand:function(a){if(a.hasClass('parent')&&a.hasClass('collapsed'))this.toggle_expanded(a);a=a.parent().parent();if(a.prop("tagName")==="LI")this.expand(a);},collapse:function(a){if(a.hasClass('parent')&&!a.hasClass('collapsed'))this.toggle_expanded(a);},select_node:function(a,c){var d=this,e,f;if(c===b)c=true;if(this.selected_node)this.selected_node.removeClass('selected selected-focused');if(a&&(!this.selected_node||a.get(0)!==this.selected_node.get(0))){this.selected_node=a;f=this.item._records.indexOf(a.data("record"));if(f!==this.item.rec_no)this.item.set_rec_no(f);e=this.selected_node.parent().parent();if(e.prop("tagName")==="LI")this.expand(e);}if(this.is_focused())this.selected_node.addClass('selected-focused');else this.selected_node.addClass('selected');if(c)this.update_selected_node(this.selected_node);},update_selected_node:function(a){var b,c,d,e,f;if(a.length){b=this.$element.scrollTop();c=b+this.$element.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$element.scrollTop(d);else if(e>c)this.$element.scrollTop(e-this.$element.height());}},syncronize:function(){var a,b;if(this.item.record_count())try{a=this.item.rec_controls_info(),b=c(a[this.id]);this.select_node(b);}catch(d){console.log(d);}},changed:function(){}};function t(a,b,c){this.init(a,b,c);}t.prototype={constructor:t,init:function(a,d,g){var h=this,i={height:480,fields:[],column_width:{},row_count:0,title_word_wrap:false,row_line_count:1,expand_selected_row:0,auto_fit_width:true,multi_select:false,multi_select_title:'',multi_select_colum_width:b,multi_select_get_selected:b,multi_select_set_selected:b,multi_select_select_all:b,tabindex:0,striped:true,dblclick_edit:true,on_dblclick:b,on_pagecount_update:b,editable:false,always_show_editor:false,keypress_edit:true,editable_fields:b,selected_field:b,append_on_lastrow_keydown:false,sortable:false,sort_fields:b,row_callback:b,title_callback:b,show_footer:b,pagination_container:b};this.item=a;if(!this.item.paginate)i.striped=false;this.id=a.task.gridId++;this.$container=d;this.options=c.extend({},i,g);this.editMode=this.options.always_show_editor;this._sorted_fields=[];this._multiple_sort=false;this.on_dblclick=this.options.on_dblclick;if(!this.options.multi_select&&this.item.lookup_field&&this.item.lookup_field.field_kind===f.FILTER_FIELD&&this.item.lookup_field.filter.filter_type===f.FILTER_IN){this.options.multi_select=true;this._filter_dict={};if(this.item.lookup_field.value.length)for(var j=0;j<this.item.lookup_field.value.length;j++)this._filter_dict[this.item.lookup_field.value[j]]=true;this.options.multi_select_get_selected=function(a){return h._filter_dict[a.id.value];},this.options.multi_select_set_selected=function(a,b){var c=[];if(b)h._filter_dict[a.id.value]=true;else delete h._filter_dict[a.id.value];for(var d in h._filter_dict)if(h._filter_dict.hasOwnProperty(d))c.push(parseInt(d,10));if(c.length)h.item.lookup_field.set_value(c,e.items_selected.replace('%d',c.length));else h.item.lookup_field.set_value(null,'');};}this.page=0;this.recordCount=0;this.cellWidths={};this.autoFieldWidth=true;this.fieldWidthUpdated=false;this.initFields();this.$element=c('<div class="dbtable '+a.item_name+'" style="overflow-x:auto;"></div>');this.$element.data('grid',this);this.item.controls.push(this);this.$element.bind('destroyed',function(){h.item.controls.splice(h.item.controls.indexOf(h),1);});this.$element.appendTo(this.$container);this.createTable();if(a.get_active())setTimeout(function(){h.initRows();},0);},initFields:function(){var a=0,b,c,d;this.fields=[];if(this.options.fields.length)d=this.options.fields;else d=this.item.view_options.fields;if(d.length){b=d.length;for(;a<b;a++){c=this.item.field_by_name(d[a]);if(c)this.fields.push(c);}}this.options.editable=this.options.editable&&!this.item.read_only;if(this.options.editable)this.options.striped=false;this.editableFields=[];if(this.options.editable_fields){b=this.options.editable_fields.length;for(a=0;a<b;a++){c=this.item.field_by_name(this.options.editable_fields[a]);if(c&&!c.read_only)this.editableFields.push(c);}}else{b=this.fields.length;for(a=0;a<b;a++)if(!this.fields[a].read_only)this.editableFields.push(this.fields[a]);}this.initSelectedField();},initKeyboardEvents:function(){var a=this,b;clearTimeout(b);b=setTimeout(function(){a.$table.on('keydown',function(b){a.keydown(b);});a.$table.on('keyup',function(b){a.keyup(b);});a.$table.on('keypress',function(b){a.keypress(b);});},400);},createTable:function(){var a=this,d=c(document),e,f,g,h,i=0,j,k,l,m,n,o,p,q,r;this.colspan=this.fields.length;if(this.options.multi_select)this.colspan+=1;this.$element.append(c('<table class="outer-table">'+'   <thead>'+'       <tr><th>&nbsp</th></tr>'+'   </thead>'+'   <tfoot>'+'       <tr><th>&nbsp</th></tr>'+'   </tfoot>'+'   <tr>'+'       <td id="top-td" style="padding: 0; border: 0" colspan='+this.colspan+'>'+'           <div class="overlay-div" style="height:100px; width:100%; overflow-y:auto; overflow-x:hidden;">'+'               <table class="inner-table" style="width: 100%"></table>'+'           </div>'+'       </td>'+'   </tr>'+'</table>'));this.$outer_table=this.$element.find("table.outer-table");this.$scroll_div=this.$element.find('div.overlay-div');this.$table=this.$element.find("table.inner-table");this.$head=this.$element.find("table.outer-table thead tr:first");this.$foot=this.$element.find("table.outer-table tfoot tr:first");this.$scroll_div.keydown(function(a){var b=(a.keyCode?a.keyCode:a.which);if(b==32)a.preventDefault();});this.$element.find('table.outer-table').addClass("table table-condensed table-bordered").css("margin",0);this.$table.addClass("table table-condensed").css("margin",0).attr("disabled",false);if(this.options.striped)this.$table.addClass("table-striped");this.$table.on('mousedown dblclick','td',function(b){a.clicked(b,this);});if(!this.options.word_wrap)this.$table.on('mouseenter','div',function(){var a=c(this);if(this.offsetHeight<(this.scrollHeight-2)||this.offsetWidth<(this.scrollWidth-2))a.tooltip({'placement':'right','title':a.text()}).on('hide',function(a){a.stopPropagation();}).on('hidden',function(a){a.stopPropagation();}).on('show',function(a){a.stopPropagation();}).on('shown',function(a){a.stopPropagation();}).eq(0).tooltip('show');});if(this.options.multi_select){var a=this;this.$table.on('mousedown','td input.multi_select',function(b){var d=c(this),e=d.is(':checked');b.preventDefault();b.stopPropagation();a.clicked(b,d.closest('td'));if(a.options.multi_select_set_selected){a.options.multi_select_set_selected.call(a.item,a.item,!e);a.update_select_all_checkbox();}});}if(this.options.multi_select_select_all){var a=this;this.$outer_table.on('click','th input.multi_select',function(b){a.options.multi_select_select_all.call(a.item,a.item,c(this).is(':checked'));});}this.$table.attr("tabindex",this.options.tabindex);this.initKeyboardEvents();this.$element.on('mousemove.grid-title','table.outer-table thead tr:first th',function(b){var d=c(this),e=d.data('field_name'),f=a.$element.find("thead tr:first th:last").get(0);if(d.outerWidth()-b.offsetX<8&&!j&&this!==f)d.css('cursor','col-resize');else if(a.options.sortable&&(!a.options.sort_fields||a.options.sort_fields.indexOf(e)!==-1))d.css('cursor','pointer');else d.css('cursor','default');});function s(b){var c=i+b.screenX-j,d=parseInt(e.css("left"),10);if(j){b.preventDefault();if(c>-(f.innerWidth()-30)&&(!a.options.auto_fit_width||c<(h.innerWidth()-30))){i=c;e.css('left',d+b.screenX-j);}j=b.screenX;}}function t(b,c){var d,e,f,g,h;d=b.data('field_name');e=a.$table.find('td.'+d);f=a.$element.find("tfoot tr:first th."+d);g=a.getCellWidth(d);h=g+c;e.width(h);e.find('div').width(h);b.width(h);b.find('div').width(h);f.width(h);f.find('div').width(h);a.syncColWidth();h=b.width();a.setCellWidth(d,h);return h-g;}function u(c){var g,k,l,m;d.off("mousemove.grid-title");d.off("mouseup.grid-title");if(i<0){i=t(f,i);if(a.options.auto_fit_width)t(h,-i);}else if(a.options.auto_fit_width){i=-t(h,-i);t(f,i);}else t(f,i);j=b;e.remove();}this.$element.on('mousedown.grid-title','table.outer-table thead tr:first th',function(b){var g=c(this),k,l,m=g.data('field_name'),n,o=[],p=[],q=[],k,q=false,r;l=a.$element.find("thead tr:first th:last").get(0);if(g.outerWidth()-b.offsetX<8&&this!==l){g.css('cursor','default');j=b.screenX;f=g;k=a.fields.indexOf(a.item.field_by_name(m));r=a.fields[k+1].field_name;h=a.$element.find("thead tr:first th."+r);i=0;d.on("mousemove.grid-title",s);d.on("mouseup.grid-title",u);e=c('<div>').addClass('selection-box').css({'width':0,'height':a.$outer_table.find('thead').innerHeight()+a.$scroll_div.innerHeight(),'left':g.position().left+g.outerWidth(),'top':a.$element.position().top});e.appendTo(a.$element);}else if(m&&a.options.sortable&&(!a.options.sort_fields||a.options.sort_fields.indexOf(m)!==-1)){if(b.ctrlKey){if(!a._multiple_sort)a._multiple_sort=true;}else if(a._multiple_sort){a._sorted_fields=[];a._multiple_sort=false;}q=[];o=[];for(var t=0;t<a._sorted_fields.length;t++){n=a._sorted_fields[t];if(n.charAt(0)==='-'){q.push(true);o.push(n.substring(1));}else{q.push(false);o.push(n);}}if(a._multiple_sort){k=jQuery.inArray(m,o);if(k===-1){o.push(m);q.push(false);}else q[k]=!q[k];}else if(o.length&&o[0]===m)q[0]=!q[0];else{o=[m];q=[false];}a._sorted_fields=[];for(var t=0;t<o.length;t++){m=o[t];if(q[t])m='-'+m;a._sorted_fields.push(m);}if(a.item.master||!a.item.paginate)a.item.sort(a._sorted_fields);else{a.item._open_params.__order=a.item.get_order_by_list(a._sorted_fields);a.item.open({params:a.item._open_params});}}});this.$table.focus(function(b){if(!this.syncronizing){this.syncronizing=true;try{a.syncronize();}finally{this.syncronizing=false;}}});this.$table.blur(function(b){a.syncronize();});this.createPager();this.createFooter();m=this.$element.clone().css("float","left").css("position","absolute").css("top",-1000);m.width(this.$container.width());this.fillTitle(m);this.createFooter(m);l=m.find("table.inner-table");if(this.options.multi_select)n=c('<tr><td><div><input type="checkbox"></div></td><td><div>W</div></td></tr>');else n=c("<tr><td><div>W</div></td></tr>");for(k=0;k<10;k++)l.append(n.clone());c('body').append(m);this.rowHeight=l.height()/10;g=l.find('td');this.td_height_margin=parseInt(g.css('padding-top'),10)+parseInt(g.css('padding-bottom'),10)+parseInt(g.css('margin-top'),10)+parseInt(g.css('margin-bottom'),10)+parseInt(g.css('border-top-width'),10);this.textHeight=l.find('div').outerHeight();r=m.outerHeight();q=m.find('div.overlay-div').height();m.remove();this.$scroll_div.height(this.options.height-(r-q));if(!this.options.row_count&&this.item.paginate){if(this.options.row_line_count>1)this.row_count=Math.floor((this.$scroll_div.height()-1)/(this.textHeight*this.options.row_line_count+this.td_height_margin+1));else if(this.options.expand_selected_row&&this.options.row_line_count===1){q=this.$scroll_div.height()-this.rowHeight-(this.options.expand_selected_row-1)*this.textHeight-1;this.row_count=Math.floor(q/this.rowHeight)+1;}else this.row_count=Math.floor((this.$scroll_div.height()-1)/this.rowHeight);if(this.row_count<=0)this.row_count=1;this.item._pg_limit=this.row_count;}},createPager:function(a){var b=this,d,f,g,h;if(this.item.paginate){g=-1;d=c('<td class="pager" style="line-height: 0" colspan='+this.colspan+'>'+'   <div id="pager" style="margin: 0 auto">'+'       <form class="form-inline" style="margin: 0">'+'           <a class="btn btn-small" tabindex="-1" href="first"><i class="icon-backward"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="prior"><i class="icon-chevron-left"></i></a>'+'           <label  class="control-label" for="input-page" style="margin: 0px 4px">'+e.page+'</label>'+'           <input class="pager-input input-mini" id="input-page" tabindex="'+g+'" type="text">'+'           <label id="page-count" class="control-label" for="input-page" style="margin: 0px 4px">'+e.of+'1000000 </label>'+'           <a class="btn btn-small" tabindex="-1" href="next"><i class="icon-chevron-right"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="last"><i class="icon-forward"></i></a>'+'       </form>'+'   </div>'+'</td>');this.$fistPageBtn=d.find('[href="first"]');this.$fistPageBtn.on("click",function(a){b.firstPage();a.preventDefault();});this.$fistPageBtn.addClass("disabled");this.$priorPageBtn=d.find('[href="prior"]');this.$priorPageBtn.on("click",function(a){b.priorPage();a.preventDefault();});this.$priorPageBtn.addClass("disabled");this.$nextPageBtn=d.find('[href="next"]');this.$nextPageBtn.on("click",function(a){b.nextPage();a.preventDefault();});this.$lastPageBtn=d.find('[href="last"]');this.$lastPageBtn.on("click",function(a){b.lastPage();a.preventDefault();});this.$pageInput=d.find('input');this.$pageInput.val(1);this.$pageInput.on("keydown",function(a){var c,d=(a.keyCode?a.keyCode:a.which);if(d===13){c=parseInt(b.$pageInput.val(),10);a.preventDefault();if(!isNaN(c)&&(c>0)){b.$pageInput.val(c);b.setPageNumber(c-1);}}});this.$pageCount=d.find('#page-count');this.$pageCount.text(e.of+'1000000');f=d.find('#pager').clone().css("float","left").css("position","absolute").css("top",-1000);c("body").append(f);h=f.width();f.remove();if(this.options.pagination_container){this.options.pagination_container.empty();this.options.pagination_container.append(d);}else if(a)a.find('tfoot').append(d);else this.$element.find('tfoot').append(d);this.$pageCount.text(e.of+' ');d.find('#pager').width(h);}},initSelectedField:function(){var a;if(!this.selectedField&&this.editableFields.length){this.selectedField=this.editableFields[0];if(this.options.selected_field){a=this.item.field_by_name(this.options.selected_field);if(this.editableFields.indexOf(a)!==-1)this.selectedField=a;}}},setSelectedField:function(a){var b=this,c=this.selectedField!==a;if(this.editableFields.indexOf(a)!==-1){if(c&&this.options.editable){this.flushEditor();this.hideEditor();}this.hide_selection();this.selectedField=a;if(c&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){b.showEditor();},75);}this.show_selection();}},nextField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a<this.editableFields.length-1)this.setSelectedField(this.editableFields[a+1]);}},priorField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a>0)this.setSelectedField(this.editableFields[a-1]);}},hideEditor:function(){var a,c,d,e;e;if(this.editing){try{if(!this.options.always_show_editor)this.editMode=false;e=this.editor.$controlGroup.parent();c=this.editor.field;d=e.find('div.'+c.field_name);a=e.outerWidth();e.css("padding-left",this.editor.paddingLeft);e.css("padding-top",this.editor.paddingTop);e.css("padding-right",this.editor.paddingRight);e.css("padding-bottom",this.editor.paddingBottom);this.editor.$controlGroup.remove();this.editor.removed=true;this.editor=b;e.outerWidth(a);d.show();}finally{this.editing=false;}this.focus();}},flushEditor:function(){if(this.editor&&this.editing)this.editor.change_field_text();},showEditor:function(){var a,b,d,e,f=this.itemRow();if(f&&!this.editing&&this.selectedField&&this.item.record_count()){if(!this.item.is_changing())this.item.edit();this.editMode=true;this.editor=new v(this,this.selectedField);this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input').css('margin-bottom',0);this.editor.$controlGroup.css('margin-bottom',0);d=f.find('div.'+this.editor.field.field_name);d.hide();e=f.find('td.'+this.editor.field.field_name);this.editor.$input.css('font-size',e.css('font-size'));a=e.outerWidth();this.editor.paddingLeft=e.css("padding-left");this.editor.paddingTop=e.css("padding-top");this.editor.paddingRight=e.css("padding-right");this.editor.paddingBottom=e.css("padding-bottom");this.editor.padding=e.css("padding");e.css("padding",0);e.outerWidth(a);e.append(this.editor.$controlGroup);a=0;this.editor.$input.parent().children('*').each(function(){a+=c(this).outerWidth(true);});this.editor.$input.width(this.editor.$input.width()+this.editor.$controlGroup.width()-a);this.editor.update();if(this.is_focused())if(this.editor.$input.modalCanFocus())this.editor.$input.focus();this.editing=true;}},height:function(a){if(a===b)return this.$element.height();else this.$scroll_div.height(a-(this.$element.height()-this.$scroll_div.height()));},fillTitle:function(a){var d,e,f,g,h,i,j,k,l={},m='',n;if(a===b)a=this.$element;e=this._sorted_fields.length;for(d=0;d<e;d++){k=this._sorted_fields[d];if(k.charAt(0)==='-')l[k.substring(1)]='icon-arrow-down';else l[k]='icon-arrow-up';}g=a.find("table.outer-table thead tr:first");g.empty();if(this.options.multi_select){if(this.options.multi_select_select_all)j=c('<input class="multi_select" type="checkbox">');else if(this.options.multi_select_title)m=this.options.multi_select_title;h=c('<div class="text-center multi_select" style="overflow: hidden">'+m+'</div>');if(j)h.append(j);i=c('<th class="bottom-border multi_select"></th>').append(h);n=this.getCellWidth('multi_select');if(n&&this.fields.length){i.width(n);h.width(n);}g.append(i);}e=this.fields.length;for(d=0;d<e;d++){f=this.fields[d];h=c('<div class="text-center '+f.field_name+'" style="overflow: hidden"><p style="vertical-align: middle; margin: 0;">'+f.field_caption+'</p></div>');i=c('<th class="'+f.field_name+'" data-field_name="'+f.field_name+'" bottom-border"></th>').append(h);if(!this.options.title_word_wrap){h.css('height',this.textHeight);i.css('height',this.textHeight);}n=this.getCellWidth(f.field_name);if(n&&(d<this.fields.length-1)){i.width(n);h.width(n);}if(l[f.field_name]){i.find('p').append('<i class="'+l[f.field_name]+'"></i>');i.find('i').css('margin-left',2);}g.append(i);}if(this.options.title_callback)this.options.title_callback(g,this.item);},createFooter:function(a){var d,e,f,g,h,i,j;if(a===b)a=this.$element;g=a.find("table.outer-table tfoot tr:first");g.empty();if(this.options.multi_select){h=c('<div class="text-center multi_select" style="overflow: hidden"></div>');i=c('<th class="multi_select"></th>').append(h);g.append(i);}e=this.fields.length;for(d=0;d<e;d++){f=this.fields[d];h=c('<div class="text-center '+f.field_name+'" style="overflow: hidden">&nbsp</div>');i=c('<th class="'+f.field_name+'"></th>').append(h);g.append(i);}if(!this.options.show_footer)g.hide();},show_footer:function(){this.$element.find("table.outer-table tfoot tr:first").show();},hideFooter:function(){this.$element.find("table.outer-table tfoot tr:first").hide();},getCellWidth:function(a){return this.cellWidths[a];},setCellWidth:function(a,b){this.cellWidths[a]=b;},initRows:function(){if(this.item._pg_offset===0){this.initFields();if(this.item.paginate){this.page=0;this.updatePageInfo();this.updatePageCount();}else this.fieldWidthUpdated=false;}this.refresh();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('closing');return false;},update:function(a){var b,c=this,d;if(this.form_closing())return;switch(a){case f.UPDATE_OPEN:this.initRows();break;case f.UPDATE_CANCEL:this.refreshRow();break;case f.UPDATE_APPEND:d=this.addNewRow();this.$table.append(d);this.syncronize();if(this.item.controls_enabled()&&this.item.record_count()===1)this.resize();break;case f.UPDATE_INSERT:d=this.addNewRow();this.$table.prepend(d);this.syncronize();break;case f.UPDATE_DELETE:this.deleteRow();break;case f.UPDATE_SCROLLED:this.syncronize();break;case f.UPDATE_CONTROLS:this.syncronize();break;case f.UPDATE_CLOSE:this.$table.empty();break;case f.UPDATE_REFRESH:this.resize();break;}},update_field:function(a,b){var c=this.itemRow(),d,e,f;if(this.item.active&&this.item.controls_enabled()&&this.item.record_count()){f=c.find('div.'+a.field_name+' span');e=this.get_field_text(a);if(e!==f.text()){f.text(e);d=(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth())||(this.$table.get(0).clientWidth>this.$element.innerWidth())||(this.$head.find('th.'+a.field_name).outerWidth()!==c.find('td.'+a.field_name).outerWidth()&&a!==this.fields[this.fields.length-1])||(f.get(0)&&f.get(0).clientWidth!==f.get(0).scrollWidth)||(this.item.is_new()&&this.item.record_count()===1);if(d)if(this.item.record_count()<100)this.resize();else this.syncColWidth();if(!b)this.update_selected(c);}}},syncColWidth:function(){var a,b,c,d,e,f=this.fields.length;if(this.item.record_count()){a=this.$table.find("tr:first-child");if(this.options.multi_select){c=this.$head.find('th.'+'multi_select');d=a.find('td.'+'multi_select');d.width(c.width());}for(e=0;e<f-1;e++){b=this.fields[e];c=this.$head.find('th.'+b.field_name);d=a.find('td.'+b.field_name);d.find('div').width(c.find('div').width());d.width(c.width());}}},update_selected:function(a){var b,c=false;if(!a)a=this.itemRow();if(this.options.multi_select&&this.options.multi_select_get_selected){if(this.options.multi_select_get_selected.call(this.item,this.item))c=true;b=a.find('input.multi_select');if(b.length)b[0].checked=c;}if(this.options.row_callback)this.options.row_callback(a,this.item);},deleteRow:function(){var a=this.itemRow();a.remove();this.syncColWidth();},itemRow:function(){if(this.item.record_count())try{var a=this.item.rec_controls_info(),b=c(a[this.id]);this.update_selected(b);return b;}catch(d){console.log(d);}},refreshRow:function(){var a=this;this.eachField(function(b,c){a.update_field(b,true);});},do_on_edit:function(a){if(this.item.lookup_field)this.item.set_lookup_field_value();else if(!this.options.editable||(!this.editMode&&a)){if(this.on_dblclick)this.on_dblclick.call(this.item,this.item);else if(this.options.dblclick_edit)this.item.edit_record();}else if(!this.editMode&&!a&&this.options.editable)this.showEditor();},clicked:function(a,b){var d,e,f=c(b).parent();if(this.options.editable)this.setSelectedField(this.item.field_by_name(c(b).data('field_name')));d=this.item._records.indexOf(f.data("record"));if(this.editMode&&d!==this.item.rec_no){if(!this.item.is_editing())this.item.edit();this.flushEditor();this.item.post();}this.item.set_rec_no(d);if(!this.editing&&!this.is_focused())this.focus();if(a.type==="dblclick")this.do_on_edit(true);},hide_selection:function(){if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.removeClass("selected-focused selected");this.selected_row.find('td.'+this.selectedField.field_name).removeClass("field-selected-focused field-selected");}else this.selected_row.removeClass("selected-focused selected");},show_selection:function(){var a='selected',b='field-selected';if(this.is_focused()){a='selected-focused';b='field-selected-focused';}if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.addClass(a);this.selected_row.find('td.'+this.selectedField.field_name).removeClass(a).addClass(b);}else this.selected_row.addClass(a);},select_row:function(a){var b,c=this.textHeight,d=this.rowHeight,e='selected';this.update_selected_row(a);if(this.is_focused())e='selected-focused';this.hide_selection();if(this.selected_row&&this.options.expand_selected_row&&this.options.row_line_count===1)this.selected_row.find('tr, div').css('height',c);this.selected_row=a;this.show_selection();if(this.options.expand_selected_row&&this.options.row_line_count===1){b=this.selected_row.find('tr, div');b.css('height','');if(b.eq(0).height()<this.options.expand_selected_row*c)b.eq(0).css('height',this.options.expand_selected_row*c);}},update_selected_row:function(a){var b,c,d,e;if(a.length){b=this.$scroll_div.scrollTop();c=b+this.$scroll_div.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$scroll_div.scrollTop(d);else if(e>c)this.$scroll_div.scrollTop(e-this.$scroll_div.height());}},syncronize:function(){var a=this,b,c;if(this.item.controls_enabled()&&this.item.record_count()>0){c=this.itemRow();b=!this.selected_row||(this.selected_row&&c&&this.selected_row.get(0)!==c.get(0));if(b&&this.options.editable)this.hideEditor();try{this.select_row(this.itemRow());}catch(d){}if(b&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){a.showEditor();},75);}}},get_field_text:function(a){return a.get_lookup_data_type()===f.BOOLEAN?a.get_lookup_value()?'Ã—':'':a.get_display_text();},keydown:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 33:case 34:case 35:case 36:case 38:case 40:this.item.grid_keydown=true;a.preventDefault();this.flushEditor();if(c===33)this.priorPage();else if(c===34)if(this.item.paginate&&this.item.is_loaded)this.item.last();else this.nextPage();else if(c===38){this.item.prior();if(this.item.bof())this.priorPage(function(){b.item.last();});}else if(c===40){this.item.next();if(this.item.eof())if(this.options.editable&&this.editMode&&this.options.append_on_lastrow_keydown){if(!this.item.is_editing())this.item.edit();this.item.post();if(!this.item.is_new())this.item.append();}else this.nextPage();}else if(c===36)this.firstPage();else if(c===35)this.lastPage();break;case 37:if(this.options.editable&&!this.editMode)this.priorField();break;case 39:if(this.options.editable&&!this.editMode)this.nextField();break;}},keyup:function(a){var c=this,d,e=(a.keyCode?a.keyCode:a.which);if(a.target===this.$table.get(0)&&!a.ctrlKey&&!a.shiftKey)switch(e){case 13:this.do_on_edit(false);break;case 33:case 34:case 35:case 36:case 38:case 40:this.item.grid_keydown=b;a.preventDefault();if(this.item.details_active&&!this.loading)this.item.open_details();break;case 32:a.preventDefault();if(this.options.multi_select_set_selected){d=this.itemRow().find('input.multi_select');if(d.length){d[0].checked=!d[0].checked;this.options.multi_select_set_selected.call(this.item,this.item,d[0].checked);}}break;}},keypress:function(a){var b=this,c,d=a.which;if(d>32&&this.options.editable&&this.options.keypress_edit&&!this.editMode)if(this.selectedField&&this.selectedField.valid_char_code(d))this.showEditor();},setPageNumber:function(a,b){var c=this;if(!this.item.paginate||this.loading)return;if(a<this.pageCount||a===0){this.page=a;this.loading=true;this.item.open({offset:this.page*this.item._pg_limit},function(){if(b)b.call(c);c.loading=false;c.updatePageInfo();});}},reload:function(a){if(this.item.paginate)this.setPageNumber(this.page,a);else this.open(a);},updatePageInfo:function(){this.$pageInput.val(this.page+1);if(this.page===0){this.$fistPageBtn.addClass("disabled");this.$priorPageBtn.addClass("disabled");}else{this.$fistPageBtn.removeClass("disabled");this.$priorPageBtn.removeClass("disabled");}if(this.item.is_loaded){this.$lastPageBtn.addClass("disabled");this.$nextPageBtn.addClass("disabled");}else{this.$lastPageBtn.removeClass("disabled");this.$nextPageBtn.removeClass("disabled");}},updatePageCount:function(a){var b=this;this.item.total_records(function(a){b.recordCount=a;b.pageCount=Math.ceil(a/b.row_count);b.$pageCount.text(e.of+' '+b.pageCount);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(b.item,b.item,b);});},firstPage:function(a){if(this.item.paginate)this.setPageNumber(0,a);else this.item.first();},nextPage:function(a){var b,c;if(this.item.paginate){if(!this.item.is_loaded)this.setPageNumber(this.page+1,a);}else{c=this.item.clone();c.set_rec_no(this.item.get_rec_no());b=this.$scroll_div.innerHeight()/this.rowHeight-1;for(var d=0;d<b;d++)if(!c.eof())c.next();else break;this.item.set_rec_no(c.get_rec_no());}},priorPage:function(a){var b,c;if(this.item.paginate)if(this.page>0)this.setPageNumber(this.page-1,a);else this.syncronize();else{c=this.item.clone();c.set_rec_no(this.item.get_rec_no());b=this.$scroll_div.innerHeight()/this.rowHeight-1;for(var d=0;d<b;d++)if(!c.eof())c.prior();else break;this.item.set_rec_no(c.get_rec_no());}},lastPage:function(a){var b=this;if(this.item.paginate){this.item.total_records(function(c){b.recordCount=c;b.pageCount=Math.ceil(c/b.row_count);b.$pageCount.text(e.of+' '+b.pageCount);b.setPageNumber(b.pageCount-1,a);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(this.item,this.item,this);});}else this.item.last();},eachField:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},addNewRow:function(){var a=c(this.newRow()),b=this.item.get_rec_no(),d;a.data("record",this.item._records[b]);d=this.item.rec_controls_info();d[this.id]=a.get();if(this.options.row_callback)this.options.row_callback(a,this.item);return a;},newColumn:function(a,b,c,d,e){var f=this.getCellWidth(a),g='class="'+a+'"',h='data-field_name="'+a+'"',i='style="text-align:'+b+';overflow: hidden'+'"',j='style="overflow: hidden';if(this.textHeight&&this.options.row_line_count>=1)j+='; height: '+this.options.row_line_count*this.textHeight+'px';if(e&&f&&(d<this.fields.length-1))j+='; width: '+f+'px';j+='"';return '<td '+g+' '+h+' '+i+'>'+'<div '+g+' '+j+'>'+'<span '+j+'>'+c+'</span>'+'</div>'+'</td>';},newRow:function(){var a,b,c,d,e,h,i,j='',k=!this.autoFieldWidth||(this.autoFieldWidth&&this.fieldWidthUpdated);c=this.fields.length;i='';if(this.options.multi_select){if(this.options.multi_select_get_selected)if(this.options.multi_select_get_selected.call(this.item,this.item))j='checked';i+=this.newColumn('multi_select','center','<input class="multi_select" type="checkbox" '+j+'>',-1,k);}for(b=0;b<c;b++){d=this.fields[b];a=this.item[d.field_name];if(!(a instanceof p))a=this.item.field_by_name(d.field_name);h=this.get_field_text(a);e=a.data_type===f.BOOLEAN?'center':g[a.alignment];i+=this.newColumn(a.field_name,e,h,b,k);}return '<tr class="inner">'+i+'</tr>';},getElementWidth:function(a){if(!a.length)return 0;if(a.is(':visible'))return a.width();else return this.getElementWidth(a.parent());},refresh:function(a){var b,d,e,f,g,h,i,j,k,l,m,n='',o,p,q=[],r,s,t=this.$table.is(':visible'),u,v=this.item.clone(),w=c('<div>');s=this.is_focused();if(this.options.editable&&this.editMode&&this.editor){if(!s)s=this.editor.$input.is(':focus');u=this.editor.$input.value;this.hideEditor();}w.css("position","absolute").css("top",-1000).width(this.getElementWidth(this.$element));c('body').append(w);this.$outer_table.detach();w.append(this.$outer_table);v.on_get_field_text=this.item.on_get_field_text;this.$head.empty();this.$table.empty();m='';p=this.item.rec_no;try{while(!v.eof()){this.item._cur_row=v._cur_row;m+=this.newRow();q.push(v.get_rec_no());v.next();}this.$table.html(m);m=this.$table.find("tr");d=m.length;for(b=0;b<d;b++){f=m.eq(b);o=q[b];v.set_rec_no(o);this.item._cur_row=o;f.data("record",v._records[o]);r=v.rec_controls_info();r[this.id]=f.get();if(this.options.row_callback)this.options.row_callback(f,this.item);}}finally{this.item._cur_row=p;}f=this.$table.find("tr:first");if(this.autoFieldWidth&&!this.fieldWidthUpdated){g='<tr>';if(this.options.multi_select){if(this.options.multi_select_title)n=this.options.multi_select_title;g=g+'<th class="multi_select">'+'<div class="text-center multi_select" style="overflow: hidden">'+n+'</div>'+'</th>';}d=this.fields.length;for(b=0;b<d;b++)g=g+'<th class="'+this.fields[b].field_name+'" ><div style="overflow: hidden">'+this.fields[b].field_caption+'</div></th>';g=c(g+'</tr>');this.$table.prepend(g);if(this.options.multi_select)if(this.options.multi_select_colum_width)g.find(".multi_select").css("width",this.options.multi_select_colum_width);else g.find(".multi_select").css("width",'3%');for(var x in this.options.column_width)if(this.options.column_width.hasOwnProperty(x))g.find("."+x).css("width",this.options.column_width[x]);if(this.options.multi_select){h=f.find("td."+'multi_select');this.setCellWidth('multi_select',h.width());}for(b=0;b<d;b++){e=this.fields[b];h=f.find("td."+e.field_name);this.setCellWidth(e.field_name,h.width());}g.remove();this.fillTitle(w);if(this.options.multi_select){h=f.find("td."+'multi_select');j=this.$head.find("th."+'multi_select');k=this.$foot.find("th."+'multi_select');i=this.getCellWidth('multi_select');h.find('div').width(i);h.width(i);j.find('div').width(i);j.width(i);k.find('div').width(i);k.width(i);}for(b=0;b<d;b++){e=this.fields[b];if(b<this.fields.length-1){h=f.find("td."+e.field_name);j=this.$head.find("th."+e.field_name);k=this.$foot.find("th."+e.field_name);i=this.getCellWidth(e.field_name);h.find('div').width(i);h.width(i);j.find('div').width(i);j.width(i);k.find('div').width(i);k.width(i);}}if(this.item.record_count()>0&&t)this.fieldWidthUpdated=true;}else{this.fillTitle(w);this.syncColWidth();}this.$outer_table.detach();this.$element.append(this.$outer_table);w.remove();this.update_select_all_checkbox();this.syncronize();if(s)this.focus();if(this.options.editable&&this.editMode&&this.editor){this.showEditor();this.editor.$input.value=u;}if(a)a.call(this);},update_select_all_checkbox:function(){var a=this;if(this.options.multi_select_select_all)setTimeout(function(){a.$outer_table.find('th input.multi_select').prop('checked',a.$table.find('td input.multi_select').is(":checked"));},200);},resize:function(){if(this.autoFieldWidth){this.fieldWidthUpdated=false;this.refresh();}},is_focused:function(){return this.$table.get(0)===document.activeElement;},focus:function(){if(!this.is_focused())if(this.$table.modalCanFocus())this.$table.focus();}};function u(a){var b=this;this.field=a;this.read_only=false;}u.prototype={constructor:u,createEntry:function(a,b,d){var e=this,h,i,j,k,l,m,n,o,p;if(!a)return;if(this.label)l=c('<label class="control-label"></label>').attr("for",a.field_name).text(this.label).addClass(a.field_name);if(a.get_lookup_data_type()===f.BOOLEAN)m=c('<input>').attr("id",a.field_name).attr("type","checkbox").attr("tabindex",b+"").click(function(a){e.field.value=!e.field.value;});else if(a.data_type===f.INTEGER&&a.value_list){m=c('<select>');m.append('<option value="0"></option>');for(var q=0;q<a.value_list.length;q++)m.append('<option value="'+(q+1)+'">'+a.value_list[q]+'</option>');m.attr("id",a.field_name).attr("tabindex",b+"");m.on('change',function(){e.field.value=parseInt(m.val(),10);});}else if(a.get_lookup_data_type()===f.BLOB)m=c('<textarea>').attr("id",a.field_name).attr("tabindex",b+"").innerHeight(70);else m=c('<input>').attr("id",a.field_name).attr("type","text").attr("tabindex",b+"");m.addClass(a.field_name);o=c('<div></div>').addClass("controls");this.$input=m;this.$input.focus(function(a){e.focusIn(a);});this.$input.blur(function(a){e.focusOut();});this.$input.mousedown(function(a){e.mouseIsDown=true;});this.$input.mouseup(function(a){if(!e.mouseIsDown)e.$input.select();e.mouseIsDown=false;});this.$input.keydown(c.proxy(this.keydown,this));this.$input.keyup(c.proxy(this.keyup,this));this.$input.keypress(c.proxy(this.keypress,this));if(a.lookup_item&&!a.master_field){p=c('<div class="input-prepend input-append"></div>').addClass("input-with-buttons");n=c('<button class="btn input-button" type="button"><i class="icon-remove-sign"></button>');n.attr("tabindex",-1);n.click(function(){a.set_value(null);});this.$firstBtn=n;p.append(n);p.append(m);n=c('<button class="btn input-button" type="button"><i class="icon-folder-open"></button>');n.attr("tabindex",-1);n.click(function(){e.selectValue();});this.$lastBtn=n;p.append(n);o.append(p);m.addClass("input-item");}else{switch(a.get_lookup_data_type()){case f.TEXT:m.addClass("input-text");o.append(m);break;case f.INTEGER:if(this.field.value_list)m.addClass("input-select");else m.addClass("input-integer");o.append(m);break;case f.FLOAT:m.addClass("input-float");o.append(m);break;case f.CURRENCY:m.addClass("input-currency");o.append(m);break;case f.DATE:case f.DATETIME:p=c('<div class="input-append"></div>').addClass("input-with-buttons");m.addClass("input-date");p.append(m);n=c('<button class="btn input-button" type="button"><i class="icon-calendar"></button>');n.attr("tabindex",-1);n.click(function(){e.showDatePicker();});this.$lastBtn=n;p.append(n);o.append(p);break;case f.BOOLEAN:o.append(m);break;case f.BLOB:m.addClass("input-text");o.append(m);break;}h=a.data_type===f.BOOLEAN?'center':g[a.alignment];this.$input.css("text-align",h);}if(this.label_on_top)this.$controlGroup=c('<div class="input-container"></div>');else this.$controlGroup=c('<div class="control-group input-container"></div>');if(this.label)this.$controlGroup.append(l);this.$controlGroup.append(o);if(d)d.append(this.$controlGroup);this.field.controls.push(this);this.$input.bind('destroyed',function(){e.field.controls.splice(e.field.controls.indexOf(e),1);});this.$input.on('mouseenter',function(){var a=c(this);if(e.error)a.tooltip('show');});this.$input.tooltip({'placement':'bottom','title':''}).on('hide',function(a){a.stopPropagation();}).on('hidden',function(a){a.stopPropagation();}).on('show',function(a){a.stopPropagation();}).on('shown',function(a){a.stopPropagation();});this.$modalForm=this.$input.closest('.modal');this.update();},form_closing:function(){if(this.$modalForm)return this.$modalForm.data('closing');return false;},update:function(){if(this.field.field_kind===f.ITEM_FIELD)if(this.field.owner.record_count()===0){this.read_only=true;if(this.$firstBtn)this.$firstBtn.prop('disabled',this.read_only);if(this.$lastBtn)this.$lastBtn.prop('disabled',this.read_only);if(this.$input)this.$input.prop('disabled',this.read_only);return;}if(!this.removed&&!this.form_closing()){if(this.read_only!==this.field.get_read_only()){this.read_only=this.field.get_read_only();if(this.$firstBtn)this.$firstBtn.prop('disabled',this.read_only);if(this.$lastBtn)this.$lastBtn.prop('disabled',this.read_only);if(this.$input)this.$input.prop('disabled',this.read_only);}if(this.field.master_field){if(this.$firstBtn)this.$firstBtn.prop('disabled',true);if(this.$lastBtn)this.$lastBtn.prop('disabled',true);if(this.$input)this.$input.prop('disabled',true);}if(this.field.get_lookup_data_type()===f.BOOLEAN)if(this.field.get_lookup_value())this.$input.attr("checked","checked");else this.$input.removeAttr("checked","checked");if(this.field.value_list)this.$input.val(this.field.value+'');else{this.errorValue=b;this.error=b;this.$input.val(this.field.get_display_text());}this.updateState(true);}},keydown:function(a){var b=(a.keyCode?a.keyCode:a.which);if(this.field.lookup_item&&!(b===229||b===9||b==8))a.preventDefault();if(a.ctrlKey===true)if(b!==67&&b!==86&&b!==88&&b!=90&&b!=8&&b!=37&&b!=39)a.preventDefault();if(b===9)if(this.grid&&this.grid.editMode){a.preventDefault();if(a.shiftKey)this.grid.priorField();else this.grid.nextField();}},keyup:function(a){var b=(a.keyCode?a.keyCode:a.which);if(b===13&&!a.ctrlKey&&!a.shiftKey){if(this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();if(!this.grid.item.is_changing())this.grid.item.edit();this.grid.flushEditor();this.grid.hideEditor();if(this.grid.item.is_changing())this.grid.item.post();}else if(this.field.lookup_item){a.stopPropagation();a.preventDefault();this.selectValue();}else if((this.field.data_type===f.DATE)||(this.field.data_type===f.DATETIME)){a.stopPropagation();a.preventDefault();this.showDatePicker();}}else if(b===27&&this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();this.grid.item.cancel();this.grid.hideEditor();}},keypress:function(a){var b=a.which;if(this.field.lookup_item)a.preventDefault();if(this.$input.is('select')){}else if(b&&!this.field.valid_char_code(b))a.preventDefault();},showDatePicker:function(){var a=this,b;if(this.field.data_type===f.DATE)b=d.D_FMT;else if(this.field.data_type===f.DATETIME)b=d.D_T_FMT;this.$input.datepicker({weekStart:e.week_start,format:b,daysMin:e.days_min,months:e.months,monthsShort:e.months_short}).on('show',function(b){b.stopPropagation();a.$input.datepicker().attr('data-weekStart',1);}).on('hide',function(a){a.stopPropagation();}).on('changeDate',function(b){a.field.set_value(b.date);a.$input.datepicker('hide');});this.$input.datepicker('show');},selectValue:function(){if(this.field.on_entry_button_click)this.field.on_entry_button_click.call(this.item,this.field);else this.field.select_from_view_form();},change_field_text:function(){var a=true,c;this.errorValue=b;this.error=b;if(this.field.lookup_item){if(this.$input.val()!==this.field.get_lookup_text())this.$input.val(this.field.get_display_text());}else try{c=this.$input.val();if(c==='')this.field.set_value(null);else{this.field.set_text(c);this.field.check_valid();this.$input.val(c);}}catch(d){this.errorValue=c;this.error=d;this.updateState(false);if(this.field.owner&&this.field.owner.task.settings.DEBUGGING)throw 'change_field_text error: '+d;a=false;}return a;},focusIn:function(a){this.hideError();if(!this.field.lookup_item){if(this.errorValue)this.$input.val(this.errorValue);else this.$input.val(this.field.get_text());if(!this.mouseIsDown){this.$input.select();this.mouseIsDown=false;}}else this.$input.val(this.field.get_display_text());this.mouseIsDown=false;},focusOut:function(a){var b=false;if(this.grid&&this.grid.editMode)if(this.grid.item.is_changing()){this.grid.flushEditor();this.grid.item.post();}if(this.field.data_type===f.BOOLEAN)b=true;else if(this.field.value_list)b=true;else if(this.change_field_text()){this.$input.val(this.field.get_display_text());b=true;}this.updateState(b);return b;},updateState:function(a){if(a){if(this.$controlGroup)this.$controlGroup.removeClass('error');this.errorValue=b;this.error=b;this.$input.tooltip('hide').attr('data-original-title','').tooltip('fixTitle');this.hideError();}else{this.showError();if(this.$controlGroup)this.$controlGroup.addClass('error');this.$input.tooltip('hide').attr('data-original-title',this.error).tooltip('fixTitle');}},showError:function(a){},hideError:function(a){},focus:function(){this.$input.focus();}};v.prototype=new u();v.prototype.constructor=v;function v(a,b){u.call(this,b);this.grid=a;this.createEntry(b,0);}c.extend(v.prototype,{});w.prototype=new u();w.prototype.constructor=w;function w(a,b,c,d,e){u.call(this,a);if(this.field.owner&&this.field.owner.edit_form&&this.field.owner.edit_form.hasClass("modal"))this.$edit_form=this.field.owner.edit_form;this.label=e;this.label_on_top=d;if(!this.label)this.label=this.field.field_caption;this.createEntry(a,b,c);}c.extend(w.prototype,{showError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("normal-modal-border")){this.$edit_form.removeClass("nomal-modal-border");this.$edit_form.addClass("error-modal-border");}},hideError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("error-modal-border")){this.$edit_form.removeClass("error-modal-border");this.$edit_form.addClass("nomal-modal-border");}}});c.event.special.destroyed={remove:function(a){if(a.handler)a.handler();}};a.task=new j();a.task.constructors={task:j,group:k,item:m,detail:o};c.ajaxSetup({cache:false});})(window);