(function(a){"use strict";var b,c,d,e={"RESPONSE":1,"NOT_LOGGED":2,"UNDER_MAINTAINANCE":3,"NO_PROJECT":4,"TEXT":1,"INTEGER":2,"FLOAT":3,"CURRENCY":4,"DATE":5,"DATETIME":6,"BOOLEAN":7,"LONGTEXT":8,"KEYS":9,"ITEM_FIELD":1,"FILTER_FIELD":2,"PARAM_FIELD":3,"FILTER_EQ":1,"FILTER_NE":2,"FILTER_LT":3,"FILTER_LE":4,"FILTER_GT":5,"FILTER_GE":6,"FILTER_IN":7,"FILTER_NOT_IN":8,"FILTER_RANGE":9,"FILTER_ISNULL":10,"FILTER_EXACT":11,"FILTER_CONTAINS":12,"FILTER_STARTWITH":13,"FILTER_ENDWITH":14,"FILTER_CONTAINS_ALL":15,"ALIGN_LEFT":1,"ALIGN_CENTER":2,"ALIGN_RIGHT":3,"STATE_INACTIVE":0,"STATE_BROWSE":1,"STATE_INSERT":2,"STATE_EDIT":3,"STATE_DELETE":4,"RECORD_UNCHANGED":null,"RECORD_INSERTED":1,"RECORD_MODIFIED":2,"RECORD_DELETED":3,"RECORD_DETAILS_MODIFIED":4,"REC_STATUS":0,"REC_CONTROLS_INFO":1,"REC_CHANGE_ID":2,"UPDATE_OPEN":0,"UPDATE_DELETE":1,"UPDATE_CANCEL":2,"UPDATE_APPEND":3,"UPDATE_INSERT":4,"UPDATE_SCROLLED":5,"UPDATE_CONTROLS":6,"UPDATE_CLOSE":7,"UPDATE_STATE":8,"UPDATE_APPLIED":9,"UPDATE_PAGE_CHANGED":10,"UPDATE_SUMMARY":11},f=['','left','center','right'],g=['eq','ne','lt','le','gt','ge','in','not_in','range','isnull','exact','contains','startwith','endwith','contains_all'],h=["ID","field_name","field_caption","data_type","required","lookup_item","master_field","lookup_field","lookup_field1","lookup_field2","view_visible","view_index","edit_visible","edit_index","_read_only","_expand","_word_wrap","field_size","default_value","is_default","calculated","editable","_alignment","lookup_values","multi_select","multi_select_all","enable_typeahead","field_help","field_placeholder","field_mask"],i=["filter_name","filter_caption","field_name","filter_type","multi_select_all","data_type","visible","filter_help","filter_placeholder"],j=["","text","integer","float",'currency',"date","datetime","boolean","longtext","keys"];function k(a,b,c,d,e,f,g){if(e===undefined)e=true;this.owner=a;this.item_name=c||'';this.item_caption=d||'';this.visible=e;this.ID=b||null;this.item_type_id=f;this.item_type='';if(f)this.item_type=this.types[f-1];if(g)this.js_filename='js/'+g;this.items=[];if(a){if(!a.find(c))a.items.push(this);if(!(c in a))a[c]=this;this.task=a.task;}}k.prototype={constructor:k,types:["root","users","roles","tasks",'task',"items","items","details","reports","item","item","detail_item","report","detail"],get_master_field:function(a,b){var c=0,d=a.length;for(;c<d;c++)if(a[c].ID==b)return a[c];},each_item:function(a){var b=0,c=this.items.length,d;for(;b<c;b++){d=a.call(this.items[b],this.items[b],b);if(d===false)break;}},all:function(a){var b=0,c=this.items.length;a.call(this,this);for(;b<c;b++)this.items[b].all(a);},find:function(a){var b=0,c=this.items.length;for(;b<c;b++)if(this.items[b].item_name===a)return this.items[b];},item_by_ID:function(a){var b;if(this.ID===a)return this;var c=0,d=this.items.length;for(;c<d;c++){b=this.items[c].item_by_ID(a);if(b)return b;}},addChild:function(a,b,c,d,e,f){var g;if(this.getChildClass){g=this.getChildClass();if(g)return new g(this,a,b,c,d,e,f);}},send_request:function(a,b,c){return this.task.process_request(a,this,b,c);},init:function(a){var b=0,c=a.items,d,e=c.length,f;for(;b<e;b++){f=c[b][1];d=this.addChild(f.id,f.name,f.caption,f.visible,f.type,f.js_filename);d._default_order=f.default_order;d._primary_key=f.primary_key;d._deleted_flag=f.deleted_flag;d._master_id=f.master_id;d._master_rec_id=f.master_rec_id;d._keep_history=f.keep_history;d._lock_on_edit=f.lock_on_edit;d._view_params=f.view_params;d._edit_params=f.edit_params;d.virtual_table=f.virtual_table;d.prototype_ID=f.prototype_ID;if(d.initAttr)d.initAttr(f);d.init(f);}},bind_items:function(){var a=0,b=this.items.length;if(this._bind_item)this._bind_item();for(;a<b;a++)this.items[a].bind_items();},script_loaded:function(){if(this.js_filename)return this.task._script_cache[this.js_filename];else return true;},_check_args:function(a){var b,c={};for(b=0;b<a.length;b++)c[typeof a[b]]=a[b];return c;},load_script:function(a,b,c){var d=this,e,f,g;if(a&&!this.task._script_cache[a]){g=document.createElement('script');f=document.getElementsByTagName('script')[0];e=a;g.src=e;g.type="text/javascript";g.async=true;f.parentNode.insertBefore(g,f);g.onload=function(){d.task._script_cache[a]=true;if(c)c.call(d,d);if(b)b.call(d,d);};}else if(b)b.call(d,d);},load_module:function(a){this.load_modules([this],a);},load_modules:function(a,b){var c=this,d=0,e=a.length,f,g=[],h=0,i=false,j=function(a){a.load_script(a.js_filename,function(){if(--h===0)if(b&&!i){i=true;b.call(c,c);}},function(){a.bind_handlers();});};for(;d<e;d++){f=a[d];if(!f.script_loaded())g.push(f);if(f.details&&f.each_detail)f.each_detail(function(a){if(!a.script_loaded())g.push(a);});}e=g.length;h=e;if(e)for(d=0;d<e;d++)j.call(g[d],g[d]);else if(b)b.call(this,this);},bind_handlers:function(){var a=task.events['events'+this.ID];this._events=[];for(var b in a)if(a.hasOwnProperty(b)){this[b]=a[b];this._events.push([b,a[b]]);}},bind_events:function(){var a=0,b=this.items.length;this.bind_handlers();for(;a<b;a++)this.items[a].bind_events();},view$:function(a){return this.view_form.find(a);},edit$:function(a){return this.edit_form.find(a);},filter$:function(a){return this.filter_form.find(a);},param$:function(a){return this.param_form.find(a);},can_view:function(){return this.task.has_privilege(this,'can_view');},_search_template:function(a,b){var c,d="."+a;if(b)d="."+a+"-"+b;c=this.task.templates.find(d);if(c.length)return c;},_parse_template:function(b){var c,d='$include(',e,f,g=b.html(),h='';b.empty();g=g.replace(/<!--(.*?)-->/g,"");while(true){c=g.indexOf(d);if(c!==-1){h+=g.slice(0,c);g=g.slice(c+d.length);c=g.indexOf(')');e=g.slice(0,c+1).replace(/[('")]/g,'');f=this.task.templates.find(e).clone();f=this._parse_template(f);h+=f.html();g=g.slice(c+1);}else{h+=g;break;}}return b.append(a(h));},find_template:function(a,b){var c,d,e,f=this;if(b.template_class)d=this._search_template(b.template_class);if(!d){if(f.item_type==="detail"){d=this._search_template(f.owner.item_name+"-"+f.item_name,a);if(!d)d=this._search_template(f.owner.owner.item_name+"-details",a);if(!d)d=this._search_template("default",a);if(!d)f=f.owner;}if(!d)while(true){e=f.item_name;d=this._search_template(f.item_name,a);if(d)break;f=f.owner;if(f===f.task)break;}}if(!d)d=this._search_template('default',a);if(d)c=d.clone();else this.warning(this.item_caption+': '+a+' form template not found.');return c;},server:function(b,c){var d=this._check_args(arguments),e=d['function'],f=d.boolean,g,h,i;if(c!==undefined&&(c===e||c===f))c=undefined;if(c===undefined)c=[];else if(!a.isArray(c))c=[c];if(e||f){this.send_request('server',[b,c],function(a){g=a[0];h=a[1];if(e)e.call(this,g,h);if(h)throw h;});}else{i=this.send_request('server',[b,c]);g=i[0];h=i[1];if(h)throw h;else return g;}},_focus_form:function(a){a.find(':input:enabled:visible').each(function(a){if(this.tabIndex!==-1){this.focus();return false;}});},_create_form_header:function(b,c,d,e){var f,g,h,i,j,k={title:this.item_caption,close_button:true,print:false},l,m='';function n(a){var b=g.find('.modal-header');if(i){a.preventDefault();b.css('cursor','auto');g.css('margin-left',parseInt(g.css('margin-left'),10)+a.screenX-i);g.css('margin-top',parseInt(g.css('margin-top'),10)+a.screenY-j);i=a.screenX;j=a.screenY;}}function o(a){i=undefined;j=undefined;f.off("mousemove.modalform");f.off("mouseup.modalform");}if(task.old_forms){l=a('<div class="modal-header">');l.css('display','block');}else if(c.form_header&&(!l||!l.length)){l=a('<div class="modal-header">'+'<div class="header-title"></div>'+'<div class="header-refresh-btn"></div>'+'<div class="header-history-btn"></div>'+'<div class="header-filters"></div>'+'<div class="header-search"></div>'+'<div class="header-print-btn"></div>'+'<div class="header-close-btn"></div>'+'</div>');l.find('.header-search').show();}if(d)if(this.master)m=this.master.item_name+'-'+this.item_name+' '+d+'-form';else m=this.item_name+' '+d+'-form';c=a.extend({},k,c);if(!c.title)c.title='&nbsp';if(e&&e.length){if(task.old_forms){b.addClass('jam-form');return b;}else{g=a('<div class="form-frame '+m+'" tabindex="-1">'+'</div>');if(c.form_header)g.append(l);if(!c.form_border)g.addClass('no-border');}}else{g=a('<div class="modal hide normal-modal-border '+m+'" tabindex="-1" data-backdrop="static">'+'</div>');if(c.form_header)g.append(l);f=a(document);g.on("mousedown",".modal-header",function(a){i=a.screenX;j=a.screenY;f.on("mousemove.modalform",n);f.on("mouseup.modalform",o);});g.on("mousemove",".modal-header",function(b){a(this).css('cursor','move');});}this._set_form_options(g,c);g.append(b);g.addClass('jam-form');return g;},_set_old_form_options:function(a,b,c){var e=this,f=c+'_form',g,h=a.find('.modal-header'),i=h.find('.modal-title'),j='',k='',l='',m='',n='';if(b.close_button){if(d&&b.close_on_escape)j='&nbsp;'+d.close+' - [Esc]</small>';k='<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+j+' ×</button>';}if(d&&b.print)l='&nbsp;'+d.print+' - [Ctrl-P]</small>',m='<button type="button" id="print-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+l+'</button>';if(b.history_button&&this.keep_history&&task.history_item)n='<i id="history-btn" class="icon-film" style="float: right; margin: 5px;"></i>';if(!i.text().length)i=('<h4 class="modal-title">'+b.title+'</h4>');else i.html(b.title);h.empty();h.append(k+n+m);h.append(i);h.find("#close-btn").css('cursor','default').click(function(a){if(f)e._close_form(c);});h.find('#print-btn').css('cursor','default').click(function(b){if(a.find(".form-body").length)g=a.find(".form-body");else if(a.find(".modal-body").length)g=a.find(".modal-body");e.print_html(g);});h.find('#history-btn').css('cursor','default').click(function(a){e.show_history();});},_set_form_options:function(a,b,c){var e=this,f=c+'_form',g=a.find('.modal-header'),h='',i='',j='',k='',l=0,m;if(task.old_forms){this._set_old_form_options(a,b,c);return;}if(!b.title)b.title=this.item_caption;if(b.close_button){if(d&&b.close_on_escape)h='&nbsp;'+d.close+' - [Esc]</small>';i='<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+h+' ×</button>';g.find('.header-close-btn').html(i);}else g.find('.header-close-btn').hide();if(d&&b.print){j='&nbsp;'+d.print+' - [Ctrl-P]</small>',k='<button type="button" id="print-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+j+'</button>';g.find('.header-print-btn').html(k);}else g.find('.header-print-btn').hide();if(b.history_button&&this.keep_history&&task.history_item){g.find('.header-history-btn').html('<a class="btn header-btn history-btn" href="#"><i class="icon-film"></i></a>').tooltip({placement:'bottom',title:d.view_rec_history,trigger:'hover'});g.find('.history-btn').css('cursor','default').click(function(a){a.preventDefault();e.show_history();});}else g.find('.header-history-btn').hide();if(!this.virtual_table&&b.refresh_button){g.find('.header-refresh-btn').html('<a class="btn header-btn refresh-btn" href="#"><i class="icon-refresh"></i></a>').tooltip({placement:'bottom',title:d.refresh_page,trigger:'hover'});g.find(".refresh-btn").css('cursor','default').click(function(a){a.preventDefault();e.refresh_page(true);});}else g.find('.header-refresh-btn').hide();if(this.each_filter)this.each_filter(function(a){if(a.visible)l+=1;});if(b.enable_filters&&l){g.find('.header-filters').html('<a class="btn header-btn header-filters-btn" href="#">'+d.filters+'</a>'+'<span class="filters-text pull-left"></span>');g.find('.header-filters-btn').tooltip({placement:'bottom',title:d.set_filters,trigger:'hover'}).css('cursor','default').click(function(a){a.preventDefault();e.create_filter_form();});}if(!b.enable_search)g.find('.header-search').hide();g.find('.header-title').html('<h4 class="modal-title">'+b.title+'</h4>');g.find("#close-btn").css('cursor','default').click(function(a){if(f)e._close_form(c);});g.find('#print-btn').css('cursor','default').click(function(b){if(a.find(".form-body").length)m=a.find(".form-body");else if(a.find(".modal-body").length)m=a.find(".modal-body");e.print_html(m);});if(b.form_header)g.css('display','flex');else g.css('display','none');},init_filters:function(){var a=this;this._on_filters_applied_internal=function(){if(a.view_form.length)a.view_form.find(".filters-text").html(a.get_filter_html());};},init_search:function(){function b(a){if(a&&a.lookup_type!=="boolean"&&a.lookup_type!=="date"&&a.lookup_type!=="datetime")return true;}function c(a){if(a>=48&&a<=57||a>=96&&a<=105||a>=65&&a<=90||a>=186&&a<=192||a>=219&&a<=222)return true;}function d(a,b){var c=a.field_by_name(p),d='contains_all';a.set_order_by(a.view_options.default_order);a._search_params=a.search(p,b.val(),d,true,function(){b.css('font-weight','bold');});}var e,f=this,g,h=0,i,j,k,l,m=[],n,o,p,q=[];if(this.view_options.search_field)p=this.view_options.search_field;for(g=0;g<this.view_options.fields.length;g++){n=this.field_by_name(this.view_options.fields[g]);if(n&&b(n)){q.push([n.field_name,n.field_caption]);if(!p)p=this.view_options.fields[g];h+=1;if(h>20)break;}}if(p){this.view_form.find('#search-form').remove();this.view_form.find('.header-search').append('<form id="search-form" class="form-inline pull-right">'+'<div class="btn-group">'+'<button class="field-btn btn btn-small">'+this.field_by_name(p).field_caption+'</button>'+'<button class="btn btn-small dropdown-toggle" data-toggle="dropdown">'+'<span class="caret"></span>'+'</button>'+'<ul class="dropdown-menu">'+'</ul>'+'</div>'+' <input id="search-input" type="text" class="input-medium search-query" autocomplete="off">'+'</form>');j=this.view_form.find("#search-input");o=this.view_form.find('#search-form .field-btn');o.click(function(a){a.preventDefault();j.focus();});k=this.view_form.find('#search-form .dropdown-menu');for(g=0;g<q.length;g++){l=a('<li><a href="#">'+q[g][1]+'</a></li>');l.data('field',q[g]);l.click(function(b){var c=a(this).data('field');b.preventDefault();p=c[0];o.text(c[1]);j.focus();j.val('');d(f,j);});k.append(l);}j.on('input',function(){var b=a(this);b.css('font-weight','normal');clearTimeout(e);e=setTimeout(function(){d(f,b);},500);});j.keydown(function(a){var b=a.which;if(b===13)a.preventDefault();else if(b===40){f.view_form.find('.dbtable.'+f.item_name+' .inner-table').focus();a.preventDefault();}});this.view_form.on('keydown',function(a){var b=a.which;if(a.target.tagName==='INPUT'||a.target.tagName==='TEXTAREA')return;if(c(b)||b===8)if(!j.is(":focus")){if(b!==8)j.val('');j.focus();}});}else this.view_form.find("#search-form").hide();},_process_key_event:function(b,c,d){var e,f=this[b+'_form'],g=this[b+'_options'],h;if(this._active_form(b))if(f._form_disabled){d.preventDefault();d.stopPropagation();d.stopImmediatePropagation();}else{if(d.which!==116)d.stopPropagation();this._process_event(b,c,d);h=f.find('.jam-form');h.each(function(){var b=a(this),e=b.data('options');if(b.is(":visible"))e.item._process_event(e.form_type,c,d);});}},_process_event:function(a,b,c){var d='on_'+a+'_form_'+b,e,f;if(b==='close_query'){if(this[d])e=this[d].call(this,this);if(!this.master&&e===undefined&&this.owner[d])e=this.owner[d].call(this,this);if(e===undefined&&this.task[d])e=this.task[d].call(this,this);return e;}else if(b==='keyup'||b==='keydown'){if(this[d])if(this[d].call(this,this,c))return;if(!this.master&&this.owner[d])if(this.owner[d].call(this,this,c))return;if(this.task[d])if(this.task[d].call(this,this,c))return;}else{if(this.task[d])if(this.task[d].call(this,this))return;if(!this.master&&this.owner[d])if(this.owner[d].call(this,this))return;if(this[d])if(this[d].call(this,this))return;}if(a==='edit')if(b==='shown')task._edited_items.push(this);else if(b==='closed'){f=task._edited_items.indexOf(this);if(f>-1)task._edited_items.splice(f,1);}},_resize_form:function(a,b){var c=a+'_form',d=this[c],e=this[a+'_options'],f;f=b.innerWidth()-parseInt(d.css('border-left-width'),10)-parseInt(d.css('border-right-width'),10);if(e.width<f)d.width(e.width);else d.width(f);},_active_form:function(b){var c=b+'_form',d=this[c],e=a(document.activeElement).closest('.jam-form.'+b+'-form');if(d.get(0)===e.get(0))return true;},_create_form:function(b,c){var d=this,e,f=b+'_form',g={},h=this[b+'_options'],i,j,k;g.item=this;g.form_type=b;g.item_options=h;g.item_options.form_type=b;i=f+'.'+this.item_name;if(h.tab_id)i+='.'+h.tab_id;if(c)c.empty();e=a("<div></div>").append(this.find_template(b,h));e=this._create_form_header(e,h,b,c);this[f]=e;if(e){g.form=e;e.data('options',g);e.tabindex=1;if(c){a(window).on("keyup."+i,function(a){if(a.which===27&&h.close_on_escape){if(d._active_form(b))d._close_form(b);}else d._process_key_event(b,'keyup',a);});a(window).on("keydown."+i,function(a){d._process_key_event(b,'keydown',a);});c.append(e);this[f].bind('destroyed',function(){d._close_modeless_form(f);});this._process_event(b,'created');this._set_form_options(e,h,b);this._focus_form(e);this._process_event(b,'shown');if(h.width&&b!=='view'){this._resize_form(b,c);a(window).on("resize."+i,function(a){clearTimeout(j);j=setTimeout(function(){d._resize_form(b,c);},100);});}}else if(e.hasClass("modal")){e.on("show",function(a){if(a.target===d[f].get(0)){a.stopPropagation();d._process_event(b,'created');d._set_form_options(d[f],h,b);}});e.on("shown",function(a){if(a.target===d[f].get(0)){d._focus_form(d[f]);a.stopPropagation();d._process_event(b,'shown');}});e.on("hide",function(a){if(a.target===d[f].get(0)){var c=true;a.stopPropagation();c=d._process_event(b,'close_query');if(c===false){a.preventDefault();d[f].data('_closing',false);}}});e.on("hidden",function(a){if(a.target===d[f].get(0)){a.stopPropagation();d._process_event(b,'closed');d[f].remove();d[f]=undefined;}});e.on("keydown."+i,function(a){d._process_key_event(b,'keydown',a);});e.on("keyup."+i,function(a){d._process_key_event(b,'keyup',a);});e.modal({item:this,form_name:f,item_options:h});}}},_close_modeless_form:function(a){var b=this,c=a+'_form';if(this[c])this._close_form(a);if(this[c]){this[c].bind('destroyed',function(){b._close_modeless_form(a);});throw this.item_name+" - can't close form";}},_close_form:function(b){var c=this,d=b+'_form',e=this[d],f,g,h;if(e){f=e.data('options'),h=d+'.'+this.item_name;if(f.item_options.tab_id)h+='.'+f.item_options.tab_id;e.data('_closing',true);if(e.hasClass('modal'))setTimeout(function(){e.modal('hide');},100);else{g=c._process_event(f.form_type,'close_query');if(g!==false){a(window).off("keydown."+h);a(window).off("keyup."+h);a(window).off("resize."+h);this[d]=undefined;if(this._tab_info){this.task.close_tab(this._tab_info.container,this._tab_info.tab_id);this._tab_info=undefined;}c._process_event(f.form_type,'closed');e.remove();}}}},disable_edit_form:function(){this._disable_form(this.edit_form);},enable_edit_form:function(){this._enable_form(this.edit_form);},edit_form_disabled:function(){return this.edit_form._form_disabled;},_disable_form:function(a){if(a){a.css('pointer-events','none');a._form_disabled=true;}},_enable_form:function(a){if(a){a.css('pointer-events','auto');a._form_disabled=false;}},print_html:function(b){var c=window.frames.dummy,d=a("link[rel='stylesheet']"),e,f='<head>';d.each(function(a,b){f+='<link href="'+b.href+'" rel="stylesheet">';});f+='</head>';e=b.clone();c.document.write(f+'<body onload="window.print()">'+e.html()+'</body>');c.document.close();},alert:function(b,c){var d={type:'info',header:undefined,align:'right',replace:true,pulsate:true,click_close:true,body_click_hide:false,show_header:true,duration:5,timeout:0},e=0,f=0,g=a('body'),h;c=a.extend({},d,c);if(!c.replace&&a('body').find('.alert-absolute').length)return;if(!c.header)c.header=task.language[c.type];if(!c.header)c.show_header=false;h=a('<div class="alert alert-block alert-absolute">'+'<button type="button" class="close" data-dismiss="alert">&times;</button>'+'<h4>'+c.header+'</h4>'+'<p>'+b+'</p>'+'</div>');if(task.forms_container&&task.forms_container.length)g=task.forms_container;else a('body').children().each(function(){var b=a(this);if(b.width()>f&&b.css('z-index')==='auto'){f=b.width();g=b;}});a('body').find('.alert-absolute').remove();if(c.body_click_hide)a('body').off('mouseup.alert-absolute').on('mouseup.alert-absolute',function(b){a('body').find('.alert-absolute').remove();});a(window).off('resize.alert-absolute').on('resize.alert-absolute',function(b){a('body').find('.alert-absolute').remove();});h.addClass('alert-'+c.type);if(c.pulsate)h.find('h4').addClass('pulsate');if(!c.show_header)h.find('h4').hide();a('body').append(h);h.css('top',0);if(c.align==='right'){if(g)e=a(window).width()-(g.offset().left+g.width());h.css('right',e);}else{if(g)e=g.offset().left;h.css('left',e);}h.show();if(c.duration)setTimeout(function(){h.hide(100);setTimeout(function(){h.remove();},100);},c.duration*1000);},alert_error:function(b,c){c=a.extend({},c);c.type='error';this.alert(b,c);},alert_success:function(b,c){c=a.extend({},c);c.type='success';this.alert(b,c);},message:function(b,c){var d=this,e={title:'',width:400,form_header:true,height:undefined,margin:undefined,buttons:undefined,default_button:undefined,print:false,text_center:false,button_min_width:100,center_buttons:false,close_button:true,close_on_escape:true},f,g,h='',i,j,k=a('<button type="button" class="btn">OK</button>'),l;if(b instanceof jQuery)b=b.clone();c=a.extend({},e,c);f=c.buttons;h='<div class="modal-body"></div>';if(!this.is_empty_obj(f))h+='<div class="modal-footer"></div>';i=this._create_form_header(a(h),c);j=i.find('.modal-body');if(c.margin)j.css('margin',c.margin);j.html(b);if(!c.title)i.find('.modal-header').remove();if(c.text_center)j.html(b).addClass("text-center");if(c.center_buttons)i.find(".modal-footer").css("text-align","center");i.find("#close-btn").click(function(a){i.modal('hide');});for(g in f)if(f.hasOwnProperty(g))i.find(".modal-footer").append(k.clone().data('key',g).css("min-width",c.button_min_width).html(g).click(function(b){b.preventDefault();b.stopPropagation();var c=a(this).data('key');setTimeout(function(){try{if(f[c])f[c].call(d);}catch(a){}i.modal('hide');},100);}));i.on("show hide hidden",function(a){if(a.target===i.get(0))a.stopPropagation();});i.on("shown",function(a){if(a.target===i.get(0)){d._focus_form(i);a.stopPropagation();}});i.on("keyup keydown",function(b){var c;b.stopPropagation();if(b.which===37||b.which===39){c=jQuery.Event(b.type);c.which=b.which+1;a(b.target).trigger(c);}else if(b.which===80&&b.ctrlKey){b.preventDefault();d.print_html(i.find(".modal-body"));}});i.modal({width:c.width,height:c.height,keyboard:c.close_on_escape});return i;},question:function(b,c,e,f){var g={},h={buttons:g,margin:"40px 20px",text_center:true,center_buttons:true};f=a.extend({},h,f);g[d.yes]=c;g[d.no]=e;return this.message(b,f);},warning:function(b,c,d){var e={"OK":c},f={buttons:e,margin:"40px 20px",text_center:true,center_buttons:true};d=a.extend({},f,d);return this.message(b,d);},show_message:function(a,b){return this.message(a,b);},hide_message:function(a){a.modal('hide');},yes_no_cancel:function(a,b,c,e){var f={};f[d.yes]=b;f[d.no]=c;f[d.cancel]=e;return this.message(a,{buttons:f,margin:"40px 20px",text_center:true,width:500,center_buttons:true});},display_history:function(b){var c=this,f='',g=a('<div class="accordion history-accordion" id="history_accordion">'),h,i,j={},k,l,m,n,o,p,q;if(c.master){i=c.master.copy({handlers:false});h=i.item_by_ID(c.ID);i.open({open_empty:true});i.append();}else h=c.copy({handlers:false,details:false});h.open({open_empty:true});h.append();b.each(function(b){var f=a('<div class="accordion-group history-group">'+'<div class="accordion-heading history-heading">'+'<a class="accordion-toggle history-toggle" data-toggle="collapse" data-parent="#history_accordion" href="#history_collapse'+b.rec_no+'">'+'</a>'+'</div>'+'<div id="history_collapse'+b.rec_no+'" class="accordion-body collapse">'+'<div class="accordion-inner history-inner">'+'</div>'+'</div>'+'</div>'),i,k='',l='',m,n,o,p,q,r,s;r=b.changes.value;if(r&&r[0]==='0'){r=r.substring(1);r=JSON.parse(r);}if(b.operation.value===e.RECORD_DELETED)l='<p>Record deleted</p>';else if(r){s=r;if(s)for(i=0;i<s.length;i++){p=h.field_by_ID(s[i][0]);o=1;if(s[i].length===3)o=2;if(p&&!p.system_field()){q=p.field_caption;if(p.lookup_item){if(!j[p.lookup_item.ID])j[p.lookup_item.ID]=[];p.set_data(s[i][o]);n=p.value;if(n){j[p.lookup_item.ID].push([p.lookup_field,n]);n='<span class="'+p.lookup_field+'_'+n+'">'+d.value_loading+'</span>';}}else{p.set_data(s[i][o]);n=p.display_text;if(p.raw_value===null)n=' ';}if(b.operation.value===e.RECORD_INSERTED)l+='<p>'+c.task.language.field+' <b>'+q+'</b>: '+c.task.language.new_value+': <b>'+n+'</b></p>';else if(b.operation.value===e.RECORD_MODIFIED)l+='<p>'+c.task.language.field+' <b>'+q+'</b>: '+c.task.language.new_value+': <b>'+n+'</b></p>';}}}if(b.user.value)k=c.task.language.by_user+' '+b.user.value;f.find('.accordion-toggle').html(b.date.format_date_to_string(b.date.value,'%d.%m.%Y %H:%M:%S')+': '+b.operation.display_text+' '+k);f.find('.accordion-inner').html(l);if(b.rec_no===0)f.find('.accordion-body').addClass('in');g.append(f);});if(b.record_count())f=g;q=c.task.message(f,{width:700,height:600,title:b.item_caption+': '+c.item_caption,footer:false,print:true});g=q.find('#history_accordion.accordion');for(var r in j)if(j.hasOwnProperty(r)){p=c.task.item_by_ID(parseInt(r,10));if(p){p=p.copy({handlers:false});k={};l={};l[p._primary_key]=true;for(var s=0;s<j[r].length;s++){l[j[r][s][0]]=true;k[j[r][s][1]]=true;}m=[];for(var t in k)if(k.hasOwnProperty(t))m.push(parseInt(t,10));n=[];for(var u in l)if(l.hasOwnProperty(u))n.push(u);o={};o[p._primary_key+'__in']=m;p.open({where:o,fields:n},function(){var a=this;a.each(function(a){a.each_field(function(b){if(!b.system_field())g.find("."+b.field_name+'_'+a._primary_key_field.value).text(b.value);});});});}}},show_history:function(){var a=this,b=this.ID,c=this.task.history_item.copy();if(!this.rec_count){this.warning(d.no_record);return;}if(this.master)b=this.prototype_ID;c.set_where({item_id:b,item_rec_id:this.field_by_name(this._primary_key).value});c.set_order_by(['-date']);c.open(function(){a.display_history(c);});},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},emptyFunc:function(){},abort:function(a){a=a?' - '+a:'';throw 'execution aborted: '+this.item_name+a;},log_message:function(a){if(this.task.settings.DEBUGGING){a=a?' message: '+a:'';console.log(this.item_name+a);}}};l.prototype=new k();function l(b,c){var d=this;k.call(this,undefined,0,b,c,true);this.task=this;this.user_info={};this._script_cache={};this._grid_id=0;this._edited_items=[];this.events={};this.form_options={left:undefined,top:undefined,title:'',fields:[],form_header:true,form_border:true,close_button:true,close_on_escape:true,close_focusout:false,print:false,width:0,tab_id:''};this.edit_options=a.extend({},this.form_options,{history_button:true,edit_details:[],detail_height:0,modeless:false});this.view_options=a.extend({},this.form_options,{history_button:true,refresh_button:true,enable_search:true,search_field:undefined,enable_filters:true,view_detail:undefined,detail_height:0});this.table_options={multiselect:false,dblclick_edit:true,height:0,row_count:0,row_line_count:1,expand_selected_row:0,freeze_count:0,sort_fields:[],edit_fields:[],summary_fields:[]};this.constructors={task:l,group:m,item:o,detail:q};}a.extend(l.prototype,{constructor:l,consts:e,getChildClass:function(){return m;},process_request:function(b,c,f,g){var h=this,i=new Date().getTime(),j=false,k={},l="application/json;charset=utf-8",m;if(g)j=true;if(this.ajaxStatusCode)k=this.ajaxStatusCode;a.ajax({url:"api",type:"POST",contentType:l,async:j,cache:false,data:JSON.stringify([b,this.ID,c.ID,f,i]),statusCode:k,success:function(b){var f;if(b.error)console.log(b);else if(b.result.status===e.NO_PROJECT){a('body').empty();c.warning(d.no_task);return;}else if(b.result.status===e.UNDER_MAINTAINANCE){if(!h.task._under_maintainance){h.task._under_maintainance=true;if(d)f=d.website_maintenance;else f='Web site currently under maintenance.';c.warning(f,function(){h.task._under_maintainance=undefined;});}return;}else if(b.result.status===e.NOT_LOGGED){if(!h.logged_in)h.login();else location.reload();return;}else if(h.ID>0&&b.result.version&&h.version&&b.result.version!==h.version){if(!h.task._version_changed){h.task._version_changed=true;h.message('<h4>'+d.version_changed+'</h4>',{margin:'40px 40px',width:500,text_center:true});}return;}if(g)g.call(c,b.result.data);else m=b.result.data;},error:function(a,b,e){if(a.responseText&&h.ID!==0){document.open();document.write(a.responseText);document.close();}else if(d){task.alert_error(d.server_request_error);if(g)g.call(c,[null,d.server_request_error]);}},fail:function(a,b,c){console.log('ajax fail: ',a,b,c);}});if(m!==undefined)return m;},_byteLength:function(a){var b=a.length;for(var c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);if(d>0x7f&&d<=0x7ff)b++;else if(d>0x7ff&&d<=0xffff)b+=2;if(d>=0xDC00&&d<=0xDFFF)c--;}return b;},do_upload:function(a,b,c){var d=this,e,f,g=[],h,i='',j=[],k=';',l=new XMLHttpRequest(),m=this.ID+';'+this.item_name;i+=m.length+';'+m+k;i+=b.length+k;i+=this._byteLength(a)+k;for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];i+=this._byteLength(f.name)+k;i+=h.byteLength+k;g.push(f.name);}j.push(i);j.push(a);for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];j.push(f.name);j.push(h);}l.open('POST','upload',true);if(c.callback)l.onload=function(a){if(c.multiple)c.callback.call(d,g);else c.callback.call(d,g[0]);};if(c.on_progress)l.upload.onprogress=function(a){c.on_progress.call(d,d,a);};var n=new Blob(j,{type:'application/octet-stream'});l.send(n);},upload:function(b,c){var d=this,e={callback:undefined,on_progress:undefined,extension:undefined,multiple:false},f=a('<input type="file" style="position: absolute; top: -100px"/>');c=a.extend({},e,c);if(c.multiple)f.attr('multiple','multiple');a('body').append(f);f.on('change',function(a){var e=a.target.files,g,h,i,j,k,l=[],m,n=[];for(g=0,j;j=e[g];g++){i='';if(c.extension){h=j.name.split('.');if(h.length)i=h[h.length-1];if(i!==c.extension)continue;}n.push(j);}for(g=0;g<n.length;g++){k=n[g];m=new FileReader();m.onload=(function(a){return function(e){l.push([a,e.target.result]);if(l.length===n.length)d.do_upload(b,l,c);};})(k);m.readAsArrayBuffer(k);}f.remove();});f.click();},load:function(){var a=this;this.send_request('connect',null,function(b){if(b)a.load_task();else a.login();});},login:function(){var b=this,c,d;if(this.templates)d=this.templates.find("#login-form").clone();else d=a("#login-form").clone();d=this._create_form_header(d,{title:d.data('caption'),form_header:true});d.find("#login-btn").click(function(a){var c=d.find("#inputLoging").val(),e=d.find("#inputPassword").val();a.preventDefault();if(c&&e)b.send_request('login',[c,e],function(a){if(a){if(d)d.modal('hide');b.load_task();}});});d.find("#close-btn").click(function(a){d.modal('hide');});d.on("shown",function(a){d.find("#inputLoging").focus();a.stopPropagation();});d.find('input').keydown(function(b){var c=a(this),e=(b.keyCode?b.keyCode:b.which);if(e===40)if(c.attr('id')==='inputLoging')d.find('#inputPassword').focus();else d.find('#login-btn').focus();});d.modal({width:500});},logout:function(){this.send_request('logout');location.reload();},load_task:function(){var f=this,g;this.send_request('load',null,function(g){var h=g[0],i=g[1],j;if(i){f.warning(i);return;}f.logged_in=true;b=h.settings;c=h.locale;d=h.language;f.settings=b;f.language=d;f.locale=c;f.user_info=h.user_info;f.user_privileges=h.privileges;f.consts=e;f.safe_mode=f.settings.SAFE_MODE;f.forms_in_tabs=f.settings.FORMS_IN_TABS;f.full_width=f.settings.FULL_WIDTH;f.version=f.settings.VERSION;f.ID=h.task.id;f.item_name=h.task.name;f.item_caption=h.task.caption;f.visible=h.task.visible;f.lookup_lists=h.task.lookup_lists;f.history_item=h.task.history_item;f.item_type="";if(h.task.type)f.item_type=f.types[h.task.type-1];if(h.task.js_filename)f.js_filename='js/'+h.task.js_filename;f.task=f;f.templates=a("<div></div>");j=a(".templates");f.templates=j.clone();j.remove();f.init(h.task);f.bind_items();if(f.ID===0){f.js_filename='jam/js/admin.js';f.settings.DYNAMIC_JS=false;}if(f.static_js_modules){f.bind_events();f._page_loaded();}else f.init_modules();if(f.history_item)f._set_history_item(f.item_by_ID(f.history_item));window.onbeforeunload=function(){var a,b;for(a=0;a<f._edited_items.length;a++){b=f._edited_items[a];if(b.is_changing()&&b.is_modified()){if(b._tab_info)f.show_tab(b._tab_info.container,b._tab_info.tab_id);return 'You have unsaved changes!';}}};});},_page_loaded:function(){if(c.RTL)a('html').attr('dir','rtl');if(this.on_page_loaded)this.on_page_loaded.call(this,this);},_set_history_item:function(a){var b=this,c;this.history_item=a;if(this.history_item){this.history_item.read_only=true;a.view_options.fields=['item_id','item_rec_id','date','operation','user'];if(!a.on_field_get_text)a.on_field_get_text=function(a){var d,f;if(a.field_name==='operation'){if(a.value===e.RECORD_INSERTED)return b.language.created;else if(a.value===e.RECORD_MODIFIED||a.value===e.RECORD_DETAILS_MODIFIED)return b.language.modified;else if(a.value===e.RECORD_DELETED)return b.language.deleted;}else if(a.field_name==='item_id'){f=b.item_by_ID(a.value);if(f){c=f.item_caption;return c;}}};this.history_item.edit_record=function(){var b=a.task.item_by_ID(a.item_id.value),c=a.task.history_item.copy();c.set_where({item_id:a.item_id.value,item_rec_id:a.item_rec_id.value});c.set_order_by(['-date']);c.open(function(){b.display_history(c);});};}},init_modules:function(){var a=this,b=0,c=false,d=function(a){if(a.js_filename)b++;},e=function(d){if(d.js_filename)d.load_script(d.js_filename,function(){if(--b===0){a.bind_events();if(!c){c=true;a._page_loaded();}}});};if(this.settings.DYNAMIC_JS){b=1;e(this);}else{this.all(d);this.all(e);}},has_privilege:function(a,b){var c;if(a.task.ID===0)return true;if(!this.user_privileges)return true;else{if(!this.user_privileges)return false;try{c=this.user_privileges[a.ID];}catch(d){c=null;}if(c)return c[b];else return false;}},create_cookie:function(a,b,c){var d;if(c){var e=new Date();e.setTime(e.getTime()+(c*24*60*60*1000));d="; expires="+e.toGMTString();}else d="";document.cookie=escape(a)+"="+escape(b)+d+"; path=/";},read_cookie:function(a){var b=escape(a)+"=";var c=document.cookie.split(';');for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)===' ')e=e.substring(1,e.length);if(e.indexOf(b)===0)return unescape(e.substring(b.length,e.length));}return null;},erase_cookie:function(a){this.create_cookie(a,"",-1);},set_forms_container:function(a,b){if(a&&a.length){this.forms_container=a;if(b&&b.splash_screen)this.splash_screen=b.splash_screen;if(this.forms_in_tabs)this.init_tabs(a,'tabs-top',this.splash_screen,true);}},create_menu:function(b,c){var d,e,f=this,g,h,i=[],j,k,l={forms_container:undefined,splash_screen:undefined,view_first:false,create_single_group:false,create_group_for_single_item:false};c=a.extend({},l,c);this.set_forms_container(c.forms_container,{splash_screen:c.splash_screen});task.each_item(function(a){var b=[];if(a.visible){a.each_item(function(a){if(a.visible&&a.can_view())b.push(a);});if(b.length)i.push({group:a,items:b});}});for(d=0;d<i.length;d++){j=i[d].group;if((i[d].items.length===1&&!c.create_group_for_single_item)||(i.length===1&&!c.create_single_group))h=b;else{g=a('<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">'+j.item_caption+' <b class="caret"></b></a></li>');b.append(g);h=a('<ul class="dropdown-menu">');g.append(h);}for(e=0;e<i[d].items.length;e++){k=i[d].items[e];h.append(a('<li>').append(a('<a class="item-menu" href="#">'+k.item_caption+'</a>').data('item',k)));}}b.find('.item-menu').on('click',(function(b){var c=a(this).data('item');b.preventDefault();if(c.item_type==="report")c.print(false);else c.view(f.forms_container);}));if(c.view_first)b.find('.item-menu:first').click();},_tab_content:function(a){var b=a.find('a').attr('href').substr(1);return a.parent().parent().find('> div.tab-content > div.'+b);},_show_tab:function(a){var b=a.find('a').attr('href').substr(1),c,d=this._tab_content(a),e=a.parent().parent().parent();e.find('> .tabbable > div.tab-content > div.tab-pane').removeClass('active');d.addClass('active').trigger('tab_active_changed');e.find('> .tabbable > ul.nav-tabs > li').removeClass('active');a.addClass('active');c=d.data('active_el');if(c)c.focus();d.on('tab_active_changed',function(){var a=d.find('.jam-form:first');if(a.length)a.trigger('active_changed');});},_check_tabs_empty:function(a){var b=a.find('> .tabbable'),c=a.find('> .splash-screen');if(b.find('> ul.nav-tabs > li').length){b.show();c.hide();}else{b.hide();c.show();}},show_tab:function(a,b){var c=a.find('> .tabbable > ul.nav-tabs > li a[href="#'+b+'"]');if(c.length)this._show_tab(c.parent());this._check_tabs_empty(a);},_close_tab:function(a){var b=a.parent(),c=this._tab_content(a),d;this._show_tab(a);if(a.next().length)d=a.next();else d=a.prev();this._tab_content(a).remove();a.remove();if(d.length)this._show_tab(d);if(!b.children().length)b.parent().hide();},close_tab:function(a,b){var c=a.find('> .tabbable > ul.nav-tabs > li a[href="#'+b+'"]');if(c.length)this._close_tab(c.parent());this._check_tabs_empty(a);},init_tabs:function(b,c,d,e){var f=this,g;if(!c)c='tabs-top';g=a('<div class="tabbable '+c+'">');b.empty();if(d)b.append('<div class="splash-screen">'+d+'</div>');else if(e)g.hide();b.append(g);if(c==='tabs-below'){g.append('<div class="tab-content">');g.append('<ul class="nav nav-tabs">');}else{g.append('<ul class="nav nav-tabs">');g.append('<div class="tab-content">');}},can_add_tab:function(a){return a.find('> .tabbable  > ul.nav-tabs').length>0;},add_tab:function(b,c,d){var e=this,f,g,h,i,j,k,l;if(!b.length)this.warning('Container must be specified.');if(!c)this.warning('Tab name must be specified.');if(!d)d={};if(this.can_add_tab(b)){g=b.find('> .tabbable > ul.nav-tabs');if(!d.tab_id)d.tab_id='tab'+g.find('> li').length+1;h=g.find('> li.active');k=g.find('> li a[href="#'+d.tab_id+'"]');if(k.length)k=k.parent();else{i=b.find('> .tabbable > div.tab-content');if(d.show_close_btn)c='<span> '+c+' </span><i class="icon-remove close-tab-btn"></i>';k=a('<li><a href="#'+d.tab_id+'">'+c+'</a></li>');g.append(k);l=a('<div class="tab-pane '+d.tab_id+'"></div>');i.append(l);k.on('click',function(b){b.preventDefault();b.stopPropagation();e._show_tab(a(this));});l.on('focusout',function(b){var c;a(b.target).parents().each(function(){if(this===l.get(0)){l.data('active_el',b.target);return false;}});});if(d.show_close_btn)k.on('click','.close-tab-btn',function(a){a.preventDefault();a.stopPropagation();if(d.on_close)d.on_close.call();else e.close_tab(b,d.tab_id);});}if(d.set_active||!h.length)this.show_tab(b,d.tab_id);return l;}}});m.prototype=new k();function m(a,b,c,d,e,f,g){k.call(this,a,b,c,d,e,f,g);}a.extend(m.prototype,{constructor:m,getChildClass:function(){if(this.item_type==="reports")return p;else return o;}});function n(a){this.item=a;this._change_id=0;this.records=[];this.logs={};this.fields=[];this.expanded=true;}n.prototype={constructor:n,get_change_id:function(){this._change_id+=1;return this._change_id+'';},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},log_changes:function(){if(this.item.master)return this.item.master.change_log.log_changes();else return this.item.log_changes;},find_record_log:function(){var a,b,c,d,e,f,g=[],h;if(this.item.master){b=this.item.master.change_log.find_record_log();if(b){c=b.details;d=c[this.item.ID];if(this.is_empty_obj(d)){f=this.item.fields.length;for(e=0;e<f;e++)g.push(this.item.fields[e].field_name);d={logs:{},records:this.item._dataset,fields:g,expanded:this.item.expanded};c[this.item.ID]=d;}this.logs=d.logs;this.records=d.records;this.fields=d.fields;this.expanded=d.expanded;}}if(this.item.record_count()){h=this.item._get_rec_change_id();if(!h){h=this.get_change_id();this.item._set_rec_change_id(h);}a=this.logs[h];if(this.is_empty_obj(a)){a={old_record:null,record:this.cur_record(),details:{}};this.logs[h]=a;}}return a;},get_detail_log:function(a){var b,c,d;c=this.find_record_log();d=c.details;if(!this.is_empty_obj(d))b=d[a];if(b===undefined&&this._is_delta)b={records:[],fields:[],expanded:false,logs:{}};return b;},remove_record_log:function(){var a=this.item._get_rec_change_id();if(a){this.find_record_log();delete this.logs[a];this.item._set_rec_change_id(null);this.item._set_record_status(e.RECORD_UNCHANGED);}},cur_record:function(){return this.item._dataset[this.item._get_rec_no()];},record_modified:function(a){var b=false,c=a.old_record,d=a.record;for(var e=0;e<this.item._record_lookup_index;e++)if(c[e]!==d[e]){b=true;break;}return b;},copy_record:function(a,b){var c=null,d;if(a){if(b===undefined)b=true;if(b)c=a.slice(0,this.item._record_info_index);else c=a.slice(0,this.item._record_lookup_index);d=this.item.get_rec_info(undefined,a);c.push([d[0],{},d[2]]);}return c;},can_log_changes:function(){var a=this.log_changes();if(this.item.item_state===e.STATE_EDIT){}},log_change:function(){var a;if(this.log_changes()){a=this.find_record_log();if(this.item.item_state===e.STATE_BROWSE){if((this.item._get_record_status()===e.RECORD_UNCHANGED)||(this.item._get_record_status()===e.RECORD_DETAILS_MODIFIED&&a.old_record===null)){a.old_record=this.copy_record(this.cur_record(),false);return;}}else if(this.item.item_state===e.STATE_INSERT)this.item._set_record_status(e.RECORD_INSERTED);else if(this.item.item_state===e.STATE_EDIT){if(this.item._get_record_status()===e.RECORD_UNCHANGED)this.item.record_status=e.RECORD_MODIFIED;else if(this.item._get_record_status()===e.RECORD_DETAILS_MODIFIED)if(this.record_modified(a))this.item._set_record_status(e.RECORD_MODIFIED);}else if(this.item.item_state===e.STATE_DELETE)if(this.item._get_record_status()===e.RECORD_INSERTED)this.remove_record_log();else this.item._set_record_status(e.RECORD_DELETED);else throw this.item.item_name+': change log invalid records state';if(this.item.master)if(this.item.master._get_record_status()===e.RECORD_UNCHANGED)this.item.master._set_record_status(e.RECORD_DETAILS_MODIFIED);}},get_changes:function(a){var b={},c,d,f=null,g,h,i,j,k,l,m,n;a.fields=this.fields;a.expanded=false;a.data=b;for(var o in this.logs)if(this.logs.hasOwnProperty(o)){c=this.logs[o];d=c.record;g=this.item.get_rec_info(undefined,d);if(g[e.REC_STATUS]!==e.RECORD_UNCHANGED){l=c.details;if(this.item.keep_history)f=c.old_record;h=this.copy_record(d,false);i={};for(var j in l)if(l.hasOwnProperty(j)){k=l[j];m={};n=this.item.item_by_ID(parseInt(j,10));n.change_log.logs=k.logs;n.change_log.get_changes(m);i[j]=m;}b[o]={record:h,details:i,old_record:f};}}},set_changes:function(a){var b=a.data,c,d,e,f,g,h;this.records=[];this.logs={};this.fields=a.fields;this.expanded=a.expanded;this._change_id=0;for(var i in b)if(b.hasOwnProperty(i)){c=b[i];if(this._change_id<parseInt(i,10))this._change_id=parseInt(i,10);d=c.record;this.records.push(d);f={};this.logs[i]={old_record:null,record:d,details:f};e=c.details;for(var j in e)if(e.hasOwnProperty(j)){g=e[j];h=this.item.item_by_ID(parseInt(j,10));h.change_log.set_changes(g);f[j]={logs:h.change_log.logs,records:h.change_log.records,fields:h.change_log.fields,expanded:h.change_log.expanded};}}},copy_records:function(a){var b=0,c=a.length,d=[];for(b=0;b<c;b++)d.push(a[b].slice(0));return d;},store_details:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(var q=0;q<this.item.details.length;q++){c=this.item.details[q];o=c.ID;n=a[o];f={};h=[];k=[];l=true;if(n){d=n.logs;g=n.records;k=n.fields;l=n.expanded;h=this.copy_records(g);for(var r in d)if(d.hasOwnProperty(r)){e=d[r];i=e.record;j=c.change_log.copy_record(i);m=g.indexOf(i);if(m!==-1)h[m]=j;p={};c.change_log.store_details(e.details,p);f[r]={old_record:e.old_record,record:j,details:p};}}else if(c._dataset)h=this.copy_records(c._dataset);b[o]={logs:f,records:h,fields:k,expanded:l};}},store_record_log:function(){var a,b,c,d;if(this.log_changes()){a=this.find_record_log();b={};this.store_details(a.details,b);d={};d.old_record=a.old_record;d.record=this.copy_record(a.record);d.details=b;}else{d={};d.record=this.copy_record(this.cur_record());b={};for(var e=0;e<this.item.details.length;e++){c=this.item.details[e];if(!c.disabled&&c._dataset)b[c.ID]=c._dataset.slice(0);}d.details=b;}return d;},restore_record_log:function(a){var b,c,d,f,g,h;if(this.log_changes()){b=this.find_record_log();c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];b.old_record=a.old_record;b.record=g;b.details=a.details;for(var i=0;i<this.item.details.length;i++){d=this.item.details[i];f=a.details[d.ID];if(!this.is_empty_obj(f))d._dataset=f.records;}if(this.item._get_record_status()===e.RECORD_UNCHANGED)this.remove_record_log();}else{c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];for(var i=0;i<this.item.details.length;i++){d=this.item.details[i];d._dataset=a.details[d.ID];}}},update:function(a,b){var c,d,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(a){d=a.changes;for(var t in d)if(d.hasOwnProperty(t)){c=d[t];f=c.log_id;g=c.rec_id;i=c.details;j=this.logs[f];if(j){k=j.record;l=j.details;m=i.length;for(var u=0;u<m;u++){h=i[u];n=h.ID;o=this.item.detail_by_ID(parseInt(n,10));p=l[n];if(!this.is_empty_obj(p)){o.change_log.logs=p.logs;o.change_log.update(h,g);}}if(g)if(!k[this.item._primary_key_field.bind_index])k[this.item._primary_key_field.bind_index]=g;if(b)if(!k[this.item._master_rec_id_field.bind_index])k[this.item._master_rec_id_field.bind_index]=b;q=this.item.get_rec_info(undefined,k);q[e.REC_STATUS]=e.RECORD_UNCHANGED;q[e.REC_CHANGE_ID]=e.RECORD_UNCHANGED;delete this.logs[f];}}}},prepare:function(){var a=this,b,c=this.item.fields.length;if(this.item.master)a=this.item.master.change_log.get_detail_log(this.item.ID);if(a){a.records=[];a.logs={};a.fields=[];for(b=0;b<c;b++)if(!this.item.fields[b].master_field)a.fields.push(this.item.fields[b].field_name);a.expanded=this.item.expanded;}}};o.prototype=new k();function o(b,c,d,e,f,g,h){var i;k.call(this,b,c,d,e,f,g,h);if(this.task&&g!==0&&!(d in this.task))this.task[d]=this;this.field_defs=[];this._fields=[];this.fields=[];this.filter_defs=[];this.filters=[];this.details=[];this.controls=[];this.change_log=new n(this);this._paginate=false;this.disabled=false;this.expanded=true;this._log_changes=true;this._dataset=null;this._eof=false;this._bof=false;this._cur_row=null;this._old_row=0;this._old_status=null;this._buffer=null;this._modified=null;this._state=0;this._read_only=false;this._active=false;this._disabled_count=0;this._open_params={};this._where_list=[];this._order_by_list=[];this._select_field_list=[];this._record_lookup_index=-1;this._record_info_index=-1;this._is_delta=false;this._limit=1;this._offset=0;this._selections=undefined;this._show_selected=false;this.selection_limit=1500;this.is_loaded=false;if(this.task){this.view_options=a.extend({},this.task.view_options);this.table_options=a.extend({},this.task.table_options);this.edit_options=a.extend({},this.task.edit_options);this.filter_options=a.extend({},this.task.form_options);}Object.defineProperty(this,"rec_no",{get:function(){return this._get_rec_no();},set:function(a){this._set_rec_no(a);}});Object.defineProperty(this,"rec_count",{get:function(){return this.get_rec_count();}});Object.defineProperty(this,"active",{get:function(){return this._get_active();}});Object.defineProperty(this,"read_only",{get:function(){return this._get_read_only();},set:function(a){this._set_read_only(a);}});Object.defineProperty(this,"filtered",{get:function(){return this._get_filtered();},set:function(a){this._set_filtered(a);}});Object.defineProperty(this,"item_state",{get:function(){return this._get_item_state();},set:function(a){this._set_item_state(a);}});Object.defineProperty(this,"record_status",{get:function(){return this._get_record_status();},set:function(a){this._set_record_status(a);}});Object.defineProperty(this,"default_field",{get:function(){return this.get_default_field();}});Object.defineProperty(this,"log_changes",{get:function(){return this._get_log_changes();},set:function(a){this._set_log_changes(a);}});Object.defineProperty(this,"dataset",{get:function(){return this.get_dataset();},set:function(a){this.set_dataset(a);}});Object.defineProperty(this,"selections",{get:function(){return this.get_selections();},set:function(a){this.set_selections(a);}});Object.defineProperty(this,"keep_history",{get:function(){return this.get_keep_history();}});Object.defineProperty(this,"paginate",{get:function(){return this._paginate;},set:function(a){this._paginate=a;}});}a.extend(o.prototype,{constructor:o,getChildClass:function(){return q;},initAttr:function(a){var b,c=a.fields,d=a.filters,e;if(c){e=c.length;for(b=0;b<e;b++){this.field_defs.push(c[b]);new r(this,c[b]);}}if(d){e=d.length;for(b=0;b<e;b++){this.filter_defs.push(d[b]);new s(this,d[b]);}}this.reports=a.reports;},_bind_item:function(){var a=0,b,c;this._prepare_fields();this._prepare_filters();b=this.reports.length;c=this.reports;this.reports=[];for(a=0;a<b;a++)this.reports.push(this.task.item_by_ID(c[a]));this.init_params();},can_create:function(){return this.task.has_privilege(this,'can_create');},can_edit:function(){return this.task.has_privilege(this,'can_edit');},can_delete:function(){return this.task.has_privilege(this,'can_delete');},_prepare_fields:function(){var a=0,b=this._fields.length,c,d,e;for(;a<b;a++){c=this._fields[a];if(c.lookup_item&&(typeof c.lookup_item==="number")){c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number")){d=c.lookup_item._field_by_ID(c.lookup_field);c.lookup_field=d.field_name;if(d.lookup_item&&c.lookup_field1){c.lookup_item1=d.lookup_item;if(typeof c.lookup_item1==="number")c.lookup_item1=this.task.item_by_ID(c.lookup_item1);if(typeof c.lookup_field1==="number"){e=c.lookup_item1._field_by_ID(c.lookup_field1);c.lookup_field1=e.field_name;}if(e.lookup_item&&c.lookup_field2){c.lookup_item2=e.lookup_item;if(typeof c.lookup_item2==="number")c.lookup_item2=self.task.item_by_ID(c.lookup_item2);if(typeof c.lookup_field2==="number")c.lookup_field2=c.lookup_item2._field_by_ID(c.lookup_field2).field_name;}}}}if(c.master_field&&(typeof c.master_field==="number"))c.master_field=this.get_master_field(this._fields,c.master_field);if(c.lookup_values&&(typeof c.lookup_values==="number"))c.lookup_values=self.task.lookup_lists[c.lookup_values];}this.fields=this._fields.slice(0);for(a=0;a<b;a++){c=this.fields[a];if(this[c.field_name]===undefined)this[c.field_name]=c;}},dyn_fields:function(a){var b,c,d,e,f,g,i;this._fields=[];this.fields=[];this.field_defs=[];for(var b=0;b<a.length;b++){i=[];for(var c=0;c<h.length;c++){d=h[c];if(d.charAt(0)==='_')d=d.substr(1);if(d==='data_type')d='field_type';e=a[b][d];switch(d){case 'ID':e=b+1;break;case 'field_type':f=a[b].field_type;e=j.indexOf(f);if(e<1)e=1;g=e;break;case 'field_size':if(g===1&&!e)e=99999;break;case 'lookup_item':if(e){lookup_item=e;e=e.ID;}break;}i.push(e);}this.field_defs.push(i);}for(b=0;b<this.field_defs.length;b++)new r(this,this.field_defs[b]);this._prepare_fields();},_prepare_filters:function(){var a=0,b,c;b=this.filters.length;for(a=0;a<b;a++){c=this.filters[a].field;if(c.lookup_item&&(typeof c.lookup_item==="number"))c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}},ids_to_field_names:function(a){var b,c,d=[];if(a&&a.length)for(b=0;b<a.length;b++){c=this._field_by_ID(a[b]);if(c)d.push(c.field_name);}return d;},ids_to_item_names:function(a){var b,c,d=[];if(a&&a.length)for(b=0;b<a.length;b++){c=this.item_by_ID(a[b]);if(c)d.push(c.item_name);}return d;},_process_view_params:function(){var b,c,d,e=[],f,g,h,i,j,k,l={};if(this._view_params instanceof Array){for(b=0;b<this._view_params.length;b++){d=this._field_by_ID(this._view_params[b][0]);if(d)e.push([d.ID,'']);}this._view_params={0:['',{},[],{},e]};}j=this._view_params[0][0];k=this._view_params[0][1];i=this._view_params[0][2];g=this._view_params[0][3];h=this._view_params[0][4];e=[];for(b=0;b<h.length;b++){d=this._field_by_ID(h[b][0]);if(d){c=d.field_name;e.push(c);if(h[b][1])l[c]=h[b][1];}}this.view_options.fields=e;k.default_order=[];if(this._default_order)for(b=0;b<this._default_order.length;b++){d=this._field_by_ID(this._default_order[b][0]);if(d){f=d.field_name;if(this._default_order[b][1])f='-'+f;k.default_order.push(f);}else{k.default_order=[];break;}}this._default_order=undefined;k.view_detail=this.ids_to_item_names(k.view_detail);k.view_detail=k.view_detail.length?k.view_detail[0]:undefined;k.search_field=this.ids_to_field_names(k.search_field);k.search_field=k.search_field.length?k.search_field[0]:undefined;g.column_width=l;g.summary_fields=this.ids_to_field_names(g.summary_fields);g.editable_fields=this.ids_to_field_names(g.edit_fields);delete g.edit_fields;g.sort_fields=this.ids_to_field_names(g.sort_fields);this.view_options.title=this.item_caption;this.view_options=a.extend(this.view_options,k);this._view_options=a.extend({},this.view_options);this.table_options=a.extend(this.table_options,g);this._table_options=a.extend({},this.table_options);},_process_edit_params:function(){var b,c,d,e,f,g=[],h,i,j,k,l,m,n,o,p;if(this._edit_params instanceof Array){for(b=0;b<this._edit_params.length;b++){f=this._field_by_ID(this._edit_params[b][0]);if(f)g.push([f.ID,'']);}this._edit_params={0:['',{},[],[['',[[{},g,'']]]]]};}this.edit_options.fields=[];n=this._edit_params[0][0];o=this._edit_params[0][1];m=this._edit_params[0][2];l=this._edit_params[0][3];i=[];g=[];for(b=0;b<l.length;b++){h={};h.name=l[b][0];h.bands=[];k=l[b][1];for(c=0;c<k.length;c++){j={};j.fields=[];p={};j.options=k[c][0];j.options.input_width=p;g=k[c][1];j.name=k[c][2];for(d=0;d<g.length;d++){f=this._field_by_ID(g[d][0]);if(f){e=f.field_name;j.fields.push(e);if(g[d][1])p[e]=g[d][1];}}h.bands.push(j);}i.push(h);}o.edit_details=this.ids_to_item_names(o.edit_details);this.edit_options.title=this.item_caption;this.edit_options=a.extend(this.edit_options,o);this.edit_options.tabs=i;this._edit_options=a.extend(true,{},this.edit_options);},init_params:function(){this._process_view_params();this._process_edit_params();},each:function(a){var b;if(this._active){this.first();while(!this.eof()){b=a.call(this,this);if(b===false)break;else this.next();}}},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},each_filter:function(a){var b=0,c=this.filters.length,d;for(;b<c;b++){d=a.call(this.filters[b],this.filters[b],b);if(d===false)break;}},each_detail:function(a){var b=0,c=this.details.length,d;for(;b<c;b++){d=a.call(this.details[b],this.details[b],b);if(d===false)break;}},_field_by_name:function(a){return this.field_by_name(a,this._fields);},field_by_name:function(a,b){var c=0,d,e;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].field_name===a)return b[c];return e;},_field_by_ID:function(a){return this.field_by_ID(a,this._fields);},field_by_ID:function(a,b){var c=0,d;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].ID===a)return b[c];},filter_by_name:function(a){var b=0,c=this.filters.length;try{return this.filters[a];}catch(d){for(;b<c;b++)if(this.filters[b].filter_name===a)return this.filters[b];}},detail_by_name:function(a){var b=0,c=this.details.length;try{return this.details[a];}catch(d){for(;b<c;b++)if(this.details[b].item_name===a)return this.details[b];}},get_dataset:function(){var a,b,c=[];if(this.active){b=this._dataset.length;for(a=0;a<b;a++)c.push(this._dataset[a].slice(0,this._record_info_index));return c;}},set_dataset:function(a){this._dataset=a;},get_keep_history:function(){if(this.master)return this.master._keep_history;else return this._keep_history;},get_selections:function(){return this._selections;},process_selection_changed:function(a){var b=a[0],c=a[1];if(b&&!b.length)b=undefined;if(c&&!c.length)c=undefined;if(this.on_selection_changed&&(b||c))this.on_selection_changed.call(this,this,b,c);},set_selections:function(a){var b=this;if(!a||!(a instanceof Array))a=[];if(this._selections)this.process_selection_changed([undefined,this._selections.slice(0)]);this._selections=a;this._selections.add=function(){var a=b._selections.indexOf(arguments[0]);if(a===-1){Array.prototype.push.apply(this,arguments);b.process_selection_changed([[arguments[0]],undefined]);}};this._selections.push=function(){Array.prototype.push.apply(this,arguments);b.process_selection_changed([[arguments[0]],undefined]);};this._selections.remove=function(){var a=b._selections.indexOf(arguments[0]),c,d=[];if(a!==-1){c=[b._selections[a]];Array.prototype.splice.call(this,a,1);b.process_selection_changed([undefined,c]);}};this._selections.splice=function(){var a=b._selections.slice(arguments[0],arguments[0]+arguments[1]);Array.prototype.splice.apply(this,arguments);b.process_selection_changed([undefined,a]);};this._selections.pop=function(){throw 'Item selections do not support pop method';};this._selections.shift=function(){throw 'Item selections do not support shift method';};this._selections.unshift=function(){throw 'Item selections do not support unshift method';};this.process_selection_changed([this._selections.slice(0),undefined]);this.update_controls();},copy:function(a){if(this.master)throw 'A detail can not be copied.';return this._copy(a);},_copy:function(b){var c,d,e,f,g,h,i={filters:true,details:true,handlers:true};h=new o(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);h.master=this.master;h.item_type=this.item_type;b=a.extend({},i,b);h.ID=this.ID;h.item_name=this.item_name;h.expanded=this.expanded;h.field_defs=this.field_defs;h.filter_defs=this.filter_defs;h._primary_key=this._primary_key;h._deleted_flag=this._deleted_flag;h._master_id=this._master_id;h._master_rec_id=this._master_rec_id;h._edit_options=this._edit_options;h._view_options=this._view_options;h._table_options=this._table_options;h.prototype_ID=this.prototype_ID;h._keep_history=this._keep_history;h._view_params=this._view_params;h._edit_params=this._edit_params;e=h.field_defs.length;for(d=0;d<e;d++)new r(h,h.field_defs[d]);h._prepare_fields();if(b.filters){e=h.filter_defs.length;for(d=0;d<e;d++)new s(h,h.filter_defs[d]);h._prepare_filters();}h._events=this._events;if(b.handlers){e=this._events.length;for(d=0;d<e;d++)h[this._events[d][0]]=this._events[d][1];for(var j in this)if(this.hasOwnProperty(j))if((j.substring(0,3)==="on_")&&(typeof this[j]==="function"))h[j]=this[j];}h.edit_options=a.extend({},this._edit_options);h.view_options=a.extend({},this._view_options);h.table_options=a.extend({},this._table_options);if(b.details)this.each_detail(function(a,d){c=a._copy(b);c.owner=h;c.expanded=a.expanded;c.master=h;c.item_type=a.item_type;h.details.push(c);h.items.push(c);if(!(c.item_name in h))h[c.item_name]=c;if(!(c.item_name in h.details))h.details[c.item_name]=c;});return h;},clone:function(a){var b,c,d,f,g;if(a===undefined)a=true;b=new o(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);b.master=this.master;b.item_type=this.item_type;b.ID=this.ID;b.item_name=this.item_name;b.expanded=this.expanded;b.field_defs=this.field_defs;b.filter_defs=this.filter_defs;b._primary_key=this._primary_key;b._deleted_flag=this._deleted_flag;b._master_id=this._master_id;b._master_rec_id=this._master_rec_id;d=b.field_defs.length;for(c=0;c<d;c++)f=new r(b,b.field_defs[c]);b._prepare_fields();d=b.fields.length;for(c=0;c<d;c++){f=b.fields[c];if(b[f.field_name]!==undefined)delete b[f.field_name];}b.fields=[];d=this.fields.length;for(c=0;c<d;c++){f=this.fields[c];g=b._field_by_name(f.field_name);b.fields.push(g);if(b[g.field_name]===undefined)b[g.field_name]=g;}b._update_system_fields();b._bind_fields(b.expanded);b._dataset=this._dataset;if(a){b.on_filter_record=this.on_filter_record;b.filtered=this.filtered;}b._active=true;b._set_item_state(e.STATE_BROWSE);b.first();return b;},store_handlers:function(){var a={};for(var b in this)if(this.hasOwnProperty(b))if((b.substring(0,3)==="on_")&&(typeof this[b]==="function"))a[b]=this[b];return a;},clear_handlers:function(){for(var a in this)if(this.hasOwnProperty(a))if((a.substring(0,3)==="on_")&&(typeof this[a]==="function"))this[a]=undefined;},load_handlers:function(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b];},_get_log_changes:function(){return this._log_changes;},_set_log_changes:function(a){this._log_changes=a;},is_modified:function(){if(this.on_get_modified)return this.on_get_modified.call(this,this);else return this._modified;},_set_modified:function(a){this._modified=a;if(this.master&&a)this.master._set_modified(a);},_bind_fields:function(a){var b=0;if(a===undefined)a=true;this.each_field(function(a,b){a.bind_index=null;a.lookup_index=null;});this.each_field(function(a,c){if(!a.master_field){a.bind_index=b;b+=1;}});this.each_field(function(a,b){if(a.master_field)a.bind_index=a.master_field.bind_index;});this._record_lookup_index=b;if(a)this.each_field(function(a,c){if(a.lookup_item){a.lookup_index=b;b+=1;}});this._record_info_index=b;},set_fields:function(a){this._select_field_list=a;},set_order_by:function(a){this._order_by_list=[];if(a)this._order_by_list=this.get_order_by_list(a);},get_order_by_list:function(a){var b,c,d,e,f,g,h=[];g=a.length;for(f=0;f<g;f++){b=a[f];c=b;d=false;if(b[0]==='-'){d=true;c=b.substring(1);}try{e=this.field_by_name(c);}catch(i){throw this.item_name+': set_order_by method arument error - '+b+' '+i;}h.push([e.field_name,d]);}return h;},set_where:function(a){this._where_list=this.get_where_list(a);},get_where_list:function(a){var b,c,d,f,h,i,j,k=[];for(c in a)if(a.hasOwnProperty(c)){d=c;i=a[c];j=c.indexOf('__');if(j>-1){h=c.substring(j+2);c=c.substring(0,j);}else h='eq';f=g.indexOf(h);if(f!==-1)f+=1;else throw this.item_name+': set_where method arument error - '+d;b=this._field_by_name(c);if(!b)throw this.item_name+': set_where method arument error - '+d;if(i!==null){if(b.data_type===e.DATETIME&&f!==e.FILTER_ISNULL)i=b.format_date_to_string(i,'%Y-%m-%d %H:%M:%S');k.push([c,f,i,-1]);}}return k;},_update_system_fields:function(){var a,b,c,d,e,f=['_primary_key','_deleted_flag','_master_id','_master_rec_id'];b=f.length;for(a=0;a<b;a++){e=f[a];d=this[e];if(d){c=this.field_by_name(d);if(c)this[e+'_field']=c;}}},_update_fields:function(a){var b,c,d;c=this.fields.length;for(b=0;b<c;b++){d=this.fields[b];if(this[d.field_name]!==undefined)delete this[d.field_name];}this.fields=[];if(a===undefined&&this._select_field_list.length)a=this._select_field_list;if(a){c=a.length;for(b=0;b<c;b++)this.fields.push(this._field_by_name(a[b]));}else this.fields=this._fields.slice(0);a=[];c=this.fields.length;for(b=0;b<c;b++){d=this.fields[b];if(this[d.field_name]===undefined)this[d.field_name]=d;a.push(d.field_name);}this._update_system_fields();return a;},_do_before_open:function(a,b,c,d,f,g,h,i,j,k){var l,m,n=[];if(this.on_before_open)this.on_before_open.call(this,this,g);g.__expanded=a;g.__fields=[];b=this._update_fields(b);this._select_field_list=[];if(b)g.__fields=b;g.__open_empty=f;if(!g.__order)g.__order=[];if(!g.__filters)g.__filters=[];if(!f){g.__limit=0;g.__offset=0;if(i){g.__limit=i;if(h)g.__offset=h;}if(c)n=this.get_where_list(c);else if(this._where_list.length)n=this._where_list.slice(0);else this.each_filter(function(a,b){if(a.get_value()!==null)n.push([a.field.field_name,a.filter_type,a.get_value(),a.ID]);});if(g.__search!==undefined){var o=g.__search;n.push([o[0],o[2],o[1],-2]);}if(this._show_selected)n.push([this._primary_key,e.FILTER_IN,this.selections,-3]);g.__filters=n;if(d)g.__order=this.get_order_by_list(d);else if(this._order_by_list.length)g.__order=this._order_by_list.slice(0);this._where_list=[];this._order_by_list=[];if(j)g.__funcs=j;if(k)g.__group_by=k;}this._open_params=g;},_do_after_open:function(){if(this.on_after_open)this.on_after_open.call(this,this);if(this.master)this.master._detail_changed(this);},open_details:function(){var a,b=this,c=this._check_args(arguments),d=c['function'],e=c.object,f=c.boolean,g=this.details,h=0,i=function(){h-=1;if(h===0&&d)d.call(b,b);};if(e&&e.details)g=e.details;if(d||f){for(a=0;a<g.length;a++)if(!g[a].disabled)h+=1;for(a=0;a<g.length;a++)if(!g[a].disabled)g[a].open(i);}else for(a=0;a<g.length;a++)if(!g[a].disabled)g[a].open();},find_change_log:function(){if(this.master)if(this.master._get_record_status()!==e.RECORD_UNCHANGED)return this.master.change_log.get_detail_log(this.ID);},_check_open_options:function(b){if(b){if(b.fields&&!a.isArray(b.fields))throw this.item_name+': open method options error: the fields option must be an array.';if(b.order_by&&!a.isArray(b.order_by))throw this.item_name+': open method options error: the order_by option must be an array.';if(b.group_by&&!a.isArray(b.group_by))throw this.item_name+': open method options error: the group_by option must be an array.';}},_update_params:function(a,b){var c,d,f=a.__filters,g=[],h,i,j;for(c=0;c<a.__filters.length;c++){h=a.__filters[c];switch(h[3]){case -1:g.push(h);break;case -2:i=h;break;case -3:j=h;break;}}this.each_filter(function(a,b){if(a.get_value()!==null)g.push([a.field.field_name,a.filter_type,a.get_value(),a.ID]);});if(b.hasOwnProperty('__search')){d=b.__search;a.__search=b.__search;if(d!==undefined)g.push([d[0],d[2],d[1],-2]);}else if(i)g.push(i);if(b.hasOwnProperty('__show_selected_changed')){if(this._show_selected)g.push([this._primary_key,e.FILTER_IN,this.selections,-3]);}else if(j)g.push(j);a.__filters=g;this._open_params=a;return a;},_update_page:function(a,b){this.open({offset:0,params:a,page_changed:false},b);},open:function(){var a=this._check_args(arguments),b=a['function'],c=a.object,d=a.boolean,f,g,h,i,j,k,l,m,b,n,o,p,q,r,s,t;self=this;this._check_open_options(c);if(c){f=c.expanded;g=c.fields;h=c.where;i=c.order_by;j=c.open_empty;m=c.params;p=c.offset;o=c.limit;k=c.funcs;l=c.group_by;t=c.page_changed;}if(!m)m={};if(f===undefined)f=this.expanded;else this.expanded=f;if(!d)d=b?true:false;if(this.master)if(!this.disabled&&this.master.record_count()>0){m.__master_id=this.master.ID;m.__master_rec_id=this.master.field_by_name(this.master._primary_key).value;if(this.master.is_new())s=[];else{n=this.find_change_log();if(n){s=n.records;g=n.fields;f=n.expanded;}}if(s!==undefined){this._do_before_open(f,g,h,i,j,m,p,o,k,l);this._bind_fields(f);if(this.master.is_new())this.change_log.prepare();this._dataset=s;this._active=true;this._set_item_state(e.STATE_BROWSE);this.first();this._do_after_open();this.update_controls(e.UPDATE_OPEN);if(b)b.call(this,this);return;}}else{this.close();return;}if(this._paginate&&p!==undefined){if(t===undefined)t=true;m=this._update_params(this._open_params,m);m.__offset=p;if(this.on_before_open)this.on_before_open.call(this,this,m);}else{if(p===undefined)p=0;this._do_before_open(f,g,h,i,j,m,p,o,k,l);this._bind_fields(f);}if(this._paginate)m.__limit=this._limit;this.change_log.prepare();this._dataset=[];this._do_open(p,d,m,j,t,b);},_do_open:function(b,c,d,e,f,g){var h=this,i,j,k;d=a.extend(true,{},d);for(i=0;i<d.__filters.length;i++)d.__filters[i].length=3;if(this.on_open&&!e){if(this.on_open)this.on_open.call(this,this,d,function(a){h._do_after_load(a,b,g);});}else if(c&&!e)this.send_request('open',d,function(a){h._do_after_load(a,b,f,g);});else{if(e)k=[[],''];else k=this.send_request('open',d);this._do_after_load(k,b,f,g);}},_do_after_load:function(a,b,c,d){var f,g,h,i;if(a){g=a[1];if(g)this.alert_error(g);else if(a[0]){f=a[0];i=f.length;this._dataset=f;if(this._limit&&this._paginate&&f){this._offset=b;this.is_loaded=false;}if(i<this._limit)this.is_loaded=true;this._active=true;this._set_item_state(e.STATE_BROWSE);this._cur_row=null;this.first();this._do_after_open();if(!this._paginate||this._paginate&&b===0){if(this.on_filters_applied)this.on_filters_applied.call(this,this);if(this._on_filters_applied_internal)this._on_filters_applied_internal.call(this,this);}if(c)this.update_controls(e.UPDATE_PAGE_CHANGED);else this.update_controls(e.UPDATE_OPEN);if(d)d.call(this,this);}}else{this._dataset=[];console.log(this.item_name+" error while opening table");}},_do_close:function(){this._active=false;this._dataset=null;this._cur_row=null;},close:function(){var a=this.details.length;this.update_controls(e.UPDATE_CLOSE);this._do_close();for(var b=0;b<a;b++)this.details[b].close();},sort:function(a){var b=this.get_order_by_list(a);this._sort(b);},_sort:function(a){var b,c=[],d=[];for(b=0;b<a.length;b++){c.push(this.field_by_name(a[b][0]).field_name);d.push(a[b][1]);}this._sort_dataset(c,d);},_sort_dataset:function(a,b){var c=this,d,f,g;function h(a,b){if(a===null)if(b===e.TEXT)a='';else if(b===e.INTEGER||b===e.FLOAT||b===e.CURRENCY)a=0;else if(b===e.DATE||b===e.DATETIME)a=new Date(0);else if(b===e.BOOLEAN)a=false;if(b===e.FLOAT)a=Number(a.toFixed(10));if(b===e.CURRENCY)a=Number(a.toFixed(2));return a;}function i(d,e){var f,g,i,j,k,l,m;for(var f=0;f<a.length;f++){g=c.field_by_name(a[f]);j=g.bind_index;if(g.lookup_item)j=g.lookup_index;i=g.get_lookup_data_type();l=h(d[j],i);m=h(e[j],i);if(l<m)k=-1;if(l>m)k=1;if(k){if(b[f])k=-k;return k;}}return 0;}this._dataset.sort(i);this.update_controls();},search:function(){var a=this._check_args(arguments),b=a['function'],f=a.boolean,h=arguments[0],i=arguments[1].trim(),j=i,k,l,k,m,n,o,p,q,r,s,t,u,v={};if(arguments.length>2&&typeof arguments[2]==="string"){k=arguments[2];m=g.indexOf(k)+1;}else m=e.FILTER_CONTAINS_ALL;l=this.field_by_name(h);if(l){if(i&&l.lookup_values){u=this.field_by_name(h).lookup_values;q=[];if(i.length)for(n=0;n<u.length;n++){s=u[n][1].toLowerCase();r=i.toLowerCase().split(' ');t=true;for(o=0;o<r.length;o++)if(r[o])if(s.indexOf(r[o])===-1){t=false;break;}if(t)q.push(u[n][0]);}if(!q.length)q.push(-1);i=q;m=e.FILTER_IN;}else if(l.numeric_field()&&(m===e.FILTER_CONTAINS||m===e.FILTER_STARTWITH||m===e.FILTER_ENDWITH||m===e.FILTER_CONTAINS_ALL)){i=i.replace(c.DECIMAL_POINT,".");i=i.replace(c.MON_DECIMAL_POINT,".");if(i&&isNaN(i)){this.alert_error(d.invalid_value.replace('%s',''));throw d.invalid_value.replace('%s','');}}v.__search=undefined;if(i.length)v.__search=[h,i,m,j];if(f)this._update_page(v,b);else this.open({params:v},b);return [h,i,g[m-1]];}},total_records:function(a){var b=this;if(this._open_params.__open_empty&&a)return 0;else if(this.on_count){this.on_count.call(this,this,this._open_params,function(c){if(c&&a)a.call(b,c[0]);});}else this.send_request('total_records',this._open_params,function(c){if(c&&a)a.call(b,c[0]);});},new_record:function(){var a=[];this.each_field(function(b,c){if(!b.master_field)a.push(null);});if(this.expanded)this.each_field(function(b,c){if(b.lookup_item)a.push(null);});return a;},_do_before_append:function(){if(this.on_before_append)this.on_before_append.call(this,this);},_do_after_append:function(){for(var a=0;a<this.fields.length;a++)if(this.fields[a].default_value)this.fields[a].assign_default_value();this._modified=false;if(this.on_after_append)this.on_after_append.call(this,this);},append:function(){if(!this._active)throw d.append_not_active.replace('%s',this.item_name);if(this._applying)throw 'Can not perform this operation. Item is applying data to the database';if(this.master&&!this.master.is_changing())throw d.append_master_not_changing.replace('%s',this.item_name);if(this._get_item_state()!==e.STATE_BROWSE)throw d.append_not_browse.replace('%s',this.item_name);this._do_before_append();this._do_before_scroll();this._old_row=this._get_rec_no();this._set_item_state(e.STATE_INSERT);this._dataset.push(this.new_record());this._cur_row=this._dataset.length-1;this._set_record_status(e.RECORD_INSERTED);this.update_controls(e.UPDATE_APPEND);this._do_after_scroll();this._do_after_append();},insert:function(){if(!this._active)throw d.insert_not_active.replace('%s',this.item_name);if(this._applying)throw 'Can not perform this operation. Item is applying data to the database';if(this.master&&!this.master.is_changing())throw d.insert_master_not_changing.replace('%s',this.item_name);if(this._get_item_state()!==e.STATE_BROWSE)throw d.insert_not_browse.replace('%s',this.item_name);this._do_before_append();this._do_before_scroll();this._old_row=this._get_rec_no();this._set_item_state(e.STATE_INSERT);this._dataset.splice(0,0,this.new_record());this._cur_row=0;this._modified=false;this._set_record_status(e.RECORD_INSERTED);this.update_controls(e.UPDATE_INSERT);this._do_after_scroll();this._do_after_append();},_do_before_edit:function(){if(this.on_before_edit)this.on_before_edit.call(this,this);},_do_after_edit:function(){if(this.on_after_edit)this.on_after_edit.call(this,this);},edit:function(){if(!this._active)throw d.edit_not_active.replace('%s',this.item_name);if(this._applying)throw 'Can not perform this operation. Item is applying data to the database';if(this.record_count()===0)throw d.edit_no_records.replace('%s',this.item_name);if(this.master&&!this.master.is_changing())throw d.edit_master_not_changing.replace('%s',this.item_name);if(this._get_item_state()!==e.STATE_BROWSE)throw d.edit_not_browse.replace('%s',this.item_name);this._do_before_edit();this.change_log.log_change();this._buffer=this.change_log.store_record_log();this._set_item_state(e.STATE_EDIT);this._old_row=this._get_rec_no();this._old_status=this._get_record_status();this._modified=false;this._do_after_edit();},_do_before_cancel:function(){if(this.on_before_cancel)this.on_before_cancel.call(this,this);},_do_after_cancel:function(){if(this.on_after_cancel)this.on_after_cancel.call(this,this);},cancel:function(){var a,b,c=this._modified,f=this,g;this._do_before_cancel();if(this._get_item_state()===e.STATE_EDIT){this.change_log.restore_record_log(this._buffer);this.update_controls(e.UPDATE_CANCEL);for(var a=0;a<this.details.length;a++)this.details[a].update_controls(e.UPDATE_OPEN);}else if(this._get_item_state()===e.STATE_INSERT){this.change_log.remove_record_log();this.update_controls(e.UPDATE_DELETE);this._dataset.splice(this.rec_no,1);}else throw d.cancel_invalid_state.replace('%s',this.item_name);g=this._get_item_state();this._set_item_state(e.STATE_BROWSE);if(g===e.STATE_INSERT)this._do_before_scroll();this._cur_row=this._old_row;if(g===e.STATE_EDIT)this._set_record_status(this._old_status);this._modified=false;if(g===e.STATE_INSERT)this._do_after_scroll();this._do_after_cancel();if(c&&this.details.length)this.each_detail(function(a){f._detail_changed(a);});},is_browsing:function(){return this._get_item_state()===e.STATE_BROWSE;},is_changing:function(){return(this._get_item_state()===e.STATE_INSERT)||(this._get_item_state()===e.STATE_EDIT);},is_new:function(){return this._get_item_state()===e.STATE_INSERT;},is_edited:function(){return this._get_item_state()===e.STATE_EDIT;},is_deleting:function(){return this._get_item_state()===e.STATE_DELETE;},_do_before_delete:function(a){if(this.on_before_delete)this.on_before_delete.call(this,this);},_do_after_delete:function(){if(this.on_after_delete)this.on_after_delete.call(this,this);},"delete":function(){var a=this._get_rec_no();if(!this._active)throw d.delete_not_active.replace('%s',this.item_name);if(this.record_count()===0)throw d.delete_no_records.replace('%s',this.item_name);if(this.master&&!this.master.is_changing())throw d.delete_master_not_changing.replace('%s',this.item_name);this._set_item_state(e.STATE_DELETE);try{this._do_before_delete();this._do_before_scroll();this.update_controls(e.UPDATE_DELETE);this.change_log.log_change();if(this.master)this.master._set_modified(true);this._dataset.splice(a,1);this._set_rec_no(a);this._set_item_state(e.STATE_BROWSE);this._do_after_scroll();this._do_after_delete();if(this.master)this.master._detail_changed(this,true);}catch(b){throw b;}finally{this._set_item_state(e.STATE_BROWSE);}},detail_by_ID:function(a){var b;if(typeof a==="string")a=parseInt(a,10);this.each_detail(function(c,d){if(c.ID===a){b=c;return false;}});return b;},post:function(a){var b,c,d,f=this._get_item_state(),g=this._modified;if(!this.is_changing())throw this.item_name+' post method: dataset is not in edit or insert mode';if(this.on_before_post)this.on_before_post.call(this,this);if(this.master&&this._master_id)this.field_by_name(this._master_id).set_data(this.master.ID);this.check_record_valid();d=this.details.length;for(c=0;c<d;c++)if(this.details[c].is_changing())this.details[c].post();if(this.is_modified()||this.is_new())this.change_log.log_change();else if(this._get_record_status()===e.RECORD_UNCHANGED)this.change_log.remove_record_log();this._modified=false;this._set_item_state(e.STATE_BROWSE);if(this.on_after_post)this.on_after_post.call(this,this);if(!this._valid_record()){this.update_controls(e.UPDATE_DELETE);this._search_record(this._get_rec_no(),0);}if(this.master&&g)this.master._detail_changed(this,true);},apply:function(){var b=this._check_args(arguments),c=b['function'],d=b.object,e=b.boolean,f=this,g={},h,i,h=true;if(this.master){if(c)c.call(this);return;}if(this.is_changing())this.post();this.change_log.get_changes(g);if(!this.change_log.is_empty_obj(g.data)){this._applying=true;if(this.on_before_apply){h=this.on_before_apply.call(this,this);if(h)d=a.extend({},d,h);}if(c||e)this.send_request('apply',[g,d],function(a){f._process_apply(a,c);});else{i=this.send_request('apply',[g,d]);h=this._process_apply(i);}}else if(c)if(c)c.call(this);},_process_apply:function(a,b){var c,d;if(a){c=a[0];d=a[1];if(d){if(b)b.call(this,d);throw d;}else{this.change_log.update(c);if(this.on_after_apply)this.on_after_apply.call(this,this);if(b)b.call(this);this.update_controls(e.UPDATE_APPLIED);}}this._applying=false;},delta:function(a){var b,c,d,f;if(a===undefined){a={};this.change_log.get_changes(a);}f=this.copy({filters:false,details:true,handlers:false});f.on_after_scroll=function(a){a.open_details();};f.expanded=false;f._is_delta=true;c=f.details.length;for(b=0;b<c;b++){f.details[b].expanded=false;f.details[b]._is_delta=true;}f.change_log.set_changes(a);f._dataset=f.change_log.records;f._update_fields(f.change_log.fields);f._bind_fields(f.change_log.expanded);f._set_item_state(e.STATE_BROWSE);f._cur_row=null;f._active=true;f.first();return f;},field_by_id:function(a,b,c){var d,e,f;if(typeof b==='string')b=[b];d=this.copy();d.set_where({id:a});if(c){d.open({expanded:false,fields:b},function(){e=d._dataset[0];if(b.length===1)e=e[0];return e;});}else{d.open({expanded:false,fields:b});if(d.record_count()===1){e=d._dataset[0];if(b.length===1)e=e[0];return e;}}},locate:function(a,b){var c=this.clone();function d(){var d,e;if(a instanceof Array){e=a.length;for(d=0;d<e;d++)if(c.field_by_name(a[d]).value!==b[d])return false;return true;}else if(c.field_by_name(a).value===b)return true;}c.first();while(!c.eof()){if(d()){this.rec_no=c.rec_no;return true;}c.next();}},_get_active:function(){return this._active;},_set_read_only:function(a){var b,c;this._read_only=a;c=this.fields.length;for(b=0;b<c;b++)this.fields[b].update_controls();this.each_detail(function(b,c){b._set_read_only(a);});},_get_read_only:function(){if(this.master&&this.master.read_only)return true;else return this._read_only;},_get_filtered:function(){return this._filtered;},_set_filtered:function(a){if(a)if(!this.on_filter_record)a=false;if(this._filtered!==a){this._filtered=a;this.first();this.update_controls(e.UPDATE_OPEN);}},clear_filters:function(){this.each_filter(function(a){a.value=null;});},assign_filters:function(a){var b=this;a.each_filter(function(a){if(a.value===null)b.filter_by_name(a.filter_name).field.value=null;else b.filter_by_name(a.filter_name).field.value=a.field.value;});},_set_item_state:function(a){if(this._state!==a){this._state=a;if(this.on_state_changed)this.on_state_changed.call(this,this);this.update_controls(e.UPDATE_STATE);}},_get_item_state:function(){return this._state;},_do_after_scroll:function(){var a=this.details.length,b;for(var c=0;c<a;c++)this.details[c]._do_close();this.update_controls(e.UPDATE_SCROLLED);if(this.on_after_scroll)this.on_after_scroll.call(this,this);if(this._on_after_scroll_internal)this._on_after_scroll_internal.call(this,this);},_do_before_scroll:function(){if(this._cur_row!==null){if(this.is_changing())this.post();if(this.on_before_scroll)this.on_before_scroll.call(this,this);if(this._on_before_scroll_internal)this._on_before_scroll_internal.call(this,this);}},skip:function(a){var b,c,d,e;if(this.record_count()===0){this._do_before_scroll();this._eof=true;this._bof=true;this._do_after_scroll();}else{d=this._cur_row;b=false;c=false;e=a;if(e<0){e=0;c=true;}if(e>=this._dataset.length){e=this._dataset.length-1;b=true;}this._eof=b;this._bof=c;if(d!==e){this._do_before_scroll();this._cur_row=e;this._do_after_scroll();}else if(b||c&&this.is_new()&&this.record_count()===1){this._do_before_scroll();this._do_after_scroll();}}},_set_rec_no:function(a){if(this._active)if(this.filter_active())this._search_record(a,0);else this.skip(a);},_get_rec_no:function(){if(this._active)return this._cur_row;},filter_active:function(){if(this.on_filter_record&&this.filtered)return true;},first:function(){if(this.filter_active())this.find_first();else this._set_rec_no(0);},last:function(){if(this.filter_active())this.find_last();else this._set_rec_no(this._dataset.length);},next:function(){if(this.filter_active())this.find_next();else this._set_rec_no(this._get_rec_no()+1);},prior:function(){if(this.filter_active())this.find_prior();else this._set_rec_no(this._get_rec_no()-1);},eof:function(){if(this.active)return this._eof;else return true;},bof:function(){if(this.active)return this._bof;else return true;},_valid_record:function(){if(this.on_filter_record&&this.filtered)return this.on_filter_record.call(this,this);else return true;},_search_record:function(a,b){var c,d,e=this;if(b===undefined)b=1;function f(){if(e.record_count()===0){e._eof=true;e._bof=true;}else{e._eof=false;e._bof=false;if(e._cur_row<0){e._cur_row=0;e._bof=true;}if(e._cur_row>=e._dataset.length){e._cur_row=e._dataset.length-1;e._eof=true;}}}function g(){if(b===1)return e.eof();else return e.bof();}if(this.active){if(this.record_count()===0){this.skip(a);return;}d=this._cur_row;this._cur_row=a+b;f();if(b===0){if(this._valid_record()){this._cur_row=d;this.skip(a);return;}b=1;}while(!g())if(this._valid_record()){if(a!==this._cur_row){c=this._cur_row;this._cur_row=a;this.skip(c);return;}}else{this._cur_row=this._cur_row+b;f();}}},find_first:function(){this._search_record(-1,1);},find_last:function(){this._search_record(this._dataset.length,-1);},find_next:function(){this._search_record(this._get_rec_no(),1);},find_prior:function(){this._search_record(this._get_rec_no(),-1);},_count_filtered:function(){var a=this.clone(true),b=0;a.each(function(){b+=1;});return b;},get_rec_count:function(){if(this._dataset)if(this.filtered)return this._count_filtered();else return this._dataset.length;else return 0;},record_count:function(){if(this._dataset)return this._dataset.length;else return 0;},find_rec_info:function(a,b){if(b===undefined)if(a===undefined){a=this._get_rec_no();if(this.record_count()>0)b=this._dataset[a];}if(b&&(this._record_info_index>0)){if(b.length<this._record_info_index+1)b.push([null,{},null]);return b[this._record_info_index];}},get_rec_info:function(a,b){return this.find_rec_info(a,b);},_get_record_status:function(){var a=this.get_rec_info();if(a)return a[e.REC_STATUS];},_set_record_status:function(a){var b=this.get_rec_info();if(b&&this.log_changes)b[e.REC_STATUS]=a;},rec_controls_info:function(){var a=this.get_rec_info();if(a)return a[e.REC_CONTROLS_INFO];},_get_rec_change_id:function(){var a=this.get_rec_info();if(a)return a[e.REC_CHANGE_ID];},_set_rec_change_id:function(a){var b=this.get_rec_info();if(b)b[e.REC_CHANGE_ID]=a;},rec_unchanged:function(){return this._get_record_status()===e.RECORD_UNCHANGED;},rec_inserted:function(){return this._get_record_status()===e.RECORD_INSERTED;},rec_deleted:function(){return this._get_record_status()===e.RECORD_DELETED;},rec_modified:function(){return this._get_record_status()===e.RECORD_MODIFIED||this._get_record_status()===e.RECORD_DETAILS_MODIFIED;},insert_record:function(b,c){b=this._check_container(b);if(b&&this.task.can_add_tab(b)&&a('.modal').length===0)this._append_record_in_tab(b,c);else this._insert_record();},_insert_record:function(a){if(this.can_create()){if(!this.is_changing())this.insert();this.create_edit_form(a);}},append_record:function(b,c){if(b&&this.task.can_add_tab(b)&&a('.modal').length===0)this._append_record_in_tab(b,c);else this._append_record();},_append_record:function(a){if(this.can_create()){if(!this.is_changing())this.append();this.create_edit_form(a);}},_append_record_in_tab:function(a,b){var c=this.item_name+0,d,e=this,f=this.copy(),g;a=this._check_container(a);if(this.can_create()){if(!b)b='<i class="icon-plus-sign"></i> '+this.item_caption;g=task.add_tab(a,b,{tab_id:c,show_close_btn:true,set_active:true,on_close:function(){task.show_tab(a,c);f.close_edit_form();}});if(g){f._tab_info={container:a,tab_id:c};f.open({open_empty:true},function(){var a=f.on_after_apply;f.edit_options.tab_id=c;f._append_record(g);f.on_after_apply=function(b){if(a)a(f,f);e.refresh_page(true);};});}}},_check_container:function(a){if(a&&a.length)return a;else if(!a&&this.edit_options.modeless&&this.task.forms_in_tabs&&this.task.forms_container)return this.task.forms_container;},edit_record:function(b,c){b=this._check_container(b);if(this.rec_count)if(a('.modal').length===0&&b&&this.task.can_add_tab(b))this._edit_record_in_tab(b,c);else this._edit_record();},_edit_record:function(a){if(!this.is_changing())this.edit();if(!this.read_only)this.read_only=!this.can_edit();this.create_edit_form(a);},_edit_record_in_tab:function(a,b){var c=this._primary_key,d=this.field_by_name(c).value,e={},f=this.item_name+d,g,h=this,i=this.copy(),j;if(this.can_edit()){if(!b)b='<i class="icon-edit"></i> '+this.item_caption;j=task.add_tab(a,b,{tab_id:f,show_close_btn:true,set_active:true,on_close:function(){task.show_tab(a,f);i.close_edit_form();}});if(j){i._tab_info={container:a,tab_id:f};e[c]=d;i.set_where(e);i.open(function(){var a=i.on_after_apply;i.edit_options.tab_id=f;i._edit_record(j);i.on_after_apply=function(b){if(a)a(i,i);h.refresh_page(true);};});}}},record_is_edited:function(a){var b=this._primary_key,c=this.field_by_name(b).value,d=this.item_name+c,e,f;for(e=0;e<task._edited_items.length;e++){f=task._edited_items[e];if(f.ID===this.ID)if(f._tab_info.tab_id===d){if(a)task.show_tab(f._tab_info.container,f._tab_info.tab_id);return true;}}},cancel_edit:function(){if(this.is_changing())this.cancel();this.close_edit_form();},delete_record:function(){var a=this,b=a.rec_no,c=a._dataset[b],e=this._check_args(arguments),f=e['function'],g=e.boolean;if(g===undefined)g=true;if(!this.paginate)g=false;if(this.can_delete())if(this.rec_count>0){this.question(d.delete_record,function(){a["delete"]();a.apply(function(b){var c;if(b){c=(b+'').toUpperCase();if(c&&(c.indexOf('FOREIGN KEY')!==-1||c.indexOf('INTEGRITY CONSTRAINT')!==-1||c.indexOf('REFERENCE CONSTRAINT')!==-1))a.alert_error(d.cant_delete_used_record);else a.warning(b);a.refresh_page(true);}else if(f)f.call(this,this);else if(g)a.refresh_page(true);});});}else this.warning(d.no_record);},check_record_valid:function(){var a;this.each_field(function(b,c){try{b.check_valid();}catch(d){b.update_control_state(d);if(!a)a=d;}});if(a)throw a;},check_filters_valid:function(){var a;this.each_filter(function(b,c){try{b.check_valid();}catch(d){b.field.update_control_state(d);if(b.field1)b.field1.update_control_state(d);if(!a)a=d;}});if(a)throw a;},post_record:function(){this.post();this.close_edit_form();},apply_record:function(){var a=this._check_args(arguments),b=a['function'],c=a.object,d=this;if(this.is_changing()){this.disable_edit_form();try{this.post();this.apply(c,function(a){if(a){d.warning(a);this.enable_edit_form();if(!d.is_changing())d.edit();}else{if(b)b.call(d,d);d.close_edit_form();}});}catch(e){this.alert_error(e);if(this.edit_form_disabled())this.enable_edit_form();}}else this.close_edit_form();},_do_on_view_keyup:function(a){if(this.task.on_view_form_keyup)this.task.on_view_form_keyup.call(this,this,a);if(this.owner.on_view_form_keyup)this.owner.on_view_form_keyup.call(this,this,a);if(this.on_view_form_keyup)this.on_view_form_keyup.call(this,this,a);},_do_on_view_keydown:function(a){if(this.task.on_view_form_keydown)this.task.on_view_form_keydown.call(this,this,a);if(this.owner.on_view_form_keydown)this.owner.on_view_form_keydown.call(this,this,a);if(this.on_view_form_keydown)this.on_view_form_keydown.call(this,this,a);},view_modal:function(a){this.is_lookup_item=true;this.view(a);},view:function(a,b){this._show_selected=false;if(a&&this.task.can_add_tab(a))this._view_in_tab(a,b);else this._view(a);},_view:function(a){var b=this;this.load_modules([this,this.owner],function(){if(!b._order_by_list.length&&b.view_options.default_order)b.set_order_by(b.view_options.default_order);b.create_view_form(a);if(b.view_options.enable_search)b.init_search();if(b.view_options.enable_filters)b.init_filters();});},_view_in_tab:function(b,c){var d=this,e=this.item_name,f,g={tab_id:undefined,caption:this.item_caption,show_close_btn:true};c=a.extend({},g,c);if(c.tab_id)e=e+'_'+c.tab_id;f=this.task.add_tab(b,c.caption,{tab_id:e,show_close_btn:c.show_close_btn,set_active:true,on_close:function(){task.show_tab(b,e);d.close_view_form();}});if(f){this._tab_info={container:b,tab_id:e};this._view(f);}},create_view_form:function(a){this._create_form('view',a);},close_view_form:function(){this._close_form('view');},create_edit_form:function(a){this._create_form('edit',a);},close_edit_form:function(){this._close_form('edit');},create_filter_form:function(a){this._create_form('filter',a);},close_filter_form:function(){this._close_form('filter');},apply_filters:function(a){var b=this,c={},d,e,f;try{if(this.on_filters_apply)this.on_filters_apply.call(this,this);this.check_filters_valid();try{if(a){d=a[0];e=a[1];f=a[2];f=g.indexOf(f)+1;if(e)c.__search=[d,e,f];}}catch(h){c={};}this._update_page(c,function(){b.close_filter_form();});}catch(h){}},get_filter_text:function(){var a='';this.each_filter(function(b){if(b.text)a+=' '+b.text;});if(a&&task.old_forms)a=d.filter+' -'+a;return a;},get_filter_html:function(){var a='';this.each_filter(function(b){if(b.get_html())a+=' '+b.get_html();});return a;},close_filter:function(){this.close_filter_form();},disable_controls:function(){this._disabled_count+=1;},enable_controls:function(){this._disabled_count-=1;if(this.controls_enabled())this.update_controls(e.UPDATE_SCROLLED);},controls_enabled:function(){return this._disabled_count===0;},controls_disabled:function(){return !this.controls_enabled();},update_controls:function(a){var b=0,c=this.fields.length;if(a===undefined)a=e.UPDATE_CONTROLS;if(this.controls_enabled()){for(b=0;b<c;b++)this.fields[b].update_controls(a,true);c=this.controls.length;if(this.on_update_controls)this.on_update_controls.call(this,this);for(b=0;b<c;b++)this.controls[b].update(a);}},create_detail_table:function(a,b){var c=this,d=this.find(this.view_options.view_detail),e=this.on_after_scroll,f;if(d&&a&&a.length){b.editable=false;b.multiselect=false;d.create_table(a,b);this._on_after_scroll_internal=function(){if(c.view_form.length){clearTimeout(f);f=setTimeout(function(){d.set_order_by(d.view_options.default_order);d.open(true);},100);}};}},create_detail_views:function(a,b){var c=this,d,e,f,g=[],h;if(!a.length)return;if(b)h=b.details;if(!h)h=this.edit_options.edit_details;if(h.length){if(h.length>1)this.task.init_tabs(a);for(d=0;d<h.length;d++){e=this.find(h[d]);f=a;if(h.length>1)f=task.add_tab(a,e.item_caption);e.view_options.form_header=false;e.view_options.form_border=false;e.view_options.close_on_escape=false;e.view(f);if(!e.active)g.push(e);}if(g.length){this.disable_edit_form();this.open_details({details:g},function(){c.enable_edit_form();});}}},add_view_button:function(b,c){var d,e={parent_class_name:'form-footer'};c=a.extend({},e,c);d=this.view_form.find('.'+c.parent_class_name);return this.add_button(d,b,c);},add_edit_button:function(b,c){var d,e={parent_class_name:'form-footer'};c=a.extend({},e,c);d=this.edit_form.find('.'+c.parent_class_name);return this.add_button(d,b,c);},add_button:function(b,c,d){var e={btn_id:undefined,btn_class:undefined,image:undefined,type:undefined,pull_left:false,shortcut:undefined},f,g;if(!b.length)return;d=a.extend({},e,d);if(!c)c='Button';g=a('<button class="btn expanded-btn" type="button"></button>');if(d.btn_id)g.attr('id',d.btn_id);if(d.btn_class)g.addClass(d.btn_class);if(d.pull_left)g.addClass('pull-left');if(d.type)g.addClass('btn-'+d.type);if(d.image&&d.shortcut)g.html('<i class="'+d.image+'"></i> '+c+'<small class="muted">&nbsp;['+d.shortcut+']</small>');else if(d.image)g.html('<i class="'+d.image+'"></i> '+c);else if(d.shortcut)g.html(' '+c+'<small class="muted">&nbsp;['+d.shortcut+']</small>');else g.html(' '+c);if(d.pull_left)b.append(g);else{f=b.find('> .btn:not(.pull-left):first');if(f.length)f.before(g);else b.append(g);}return g;},select_records:function(a,b){var c=this,a=this.field_by_name(a),d;d=a.lookup_item.copy();d.selections=[];d.on_view_form_close_query=function(){var b=d.copy(),e=b._primary_key+'__in',f={};if(d.selections.length){f[e]=d.selections;b.set_where(f);b.lookup_field=a;b.open(function(){var a=c.rec_no;c.disable_controls();try{b.each(function(a){c.append();b.set_lookup_field_value();c.post();});}catch(d){console.error(d);}finally{if(a===null)c.first();else c.rec_no=a;c.enable_controls();c.update_controls();}});}};d.view();},_detail_changed:function(a,b){if(b&&!a.paginate&&this.on_detail_changed||a.controls.length&&a.table_options.summary_fields.length){var c=this;clearTimeout(this._detail_changed_time_out);this._detail_changed_time_out=setTimeout(function(){a._summary=undefined;if(b&&c.on_detail_changed)c.on_detail_changed.call(c,c,a);if(a._summary===undefined)c.calc_summary(a);},100);}},calc_summary:function(b,c,d){var f,g,h=b.table_options.summary_fields,i,j,k,l,m,n,o,p,q=[];b._summary={};g=b.clone();if(this.on_detail_changed)if(c instanceof Array&&c.length)for(f=0;f<c.length;f++){m=Object.keys(c[f])[0];i=c[f][m];k=undefined;if(typeof i==='function')l=i;else k=g.field_by_name(i);n=this.field_by_name(m);q.push({sum:0,field:k,func:l,master_field:n});}if(b.controls.length&&h.length)for(f=0;f<h.length;f++){j=h[f];k=g.field_by_name(j);if(k)q.push({sum:0,field:k,field_name:j});}if(q.length){g.each(function(a){for(f=0;f<q.length;f++)if(q[f].field)if(q[f].field.numeric_field())q[f].sum+=q[f].field.value;else q[f].sum+=1;else if(q[f].func)q[f].sum+=q[f].func(a);});for(f=0;f<q.length;f++){n=q[f].master_field;if(n&&this.is_changing()){o=q[f].sum;if(n.value!==o)n.value=o;}else{j=q[f].field_name;k=q[f].field;o=q[f].sum;if(j){p=o+'';if(k.data_type===e.CURRENCY)p=k.cur_to_str(o);else if(k.data_type===e.FLOAT)p=k.float_to_str(o);b._summary[j]=p;}}}if(!a.isEmptyObject(b._summary))b.update_controls(e.UPDATE_SUMMARY);if(d)d.call(this,this);}},create_table:function(a,b){return new v(this,a,b);},create_tree:function(a,b,c,d,e){return new u(this,a,b,c,d,e);},create_bands:function(b,c){var d,e,f,g,h,i,j;for(d=0;d<b.bands.length;d++){h=b.bands[d].fields;if(h.length){j=b.bands[d].options;j.fields=h;i=a('<div>');c.append(i);this.create_inputs(i,j);}}},create_tabs:function(a){var b,c=this.edit_options.tabs;this.task.init_tabs(a);for(b=0;b<c.length;b++)this.create_bands(c[b],task.add_tab(a,c[b].name));},create_controls:function(a){var b=this.edit_options.tabs;a.empty();if(b.length>1||b.length===1&&b[0].name)this.create_tabs(a);else this.create_bands(b[0],a);},create_inputs:function(b,c){var d,e,f,g,h,i=[],j=[],k=[],l,m,n;if(!b.length)return;d={fields:[],col_count:1,label_on_top:false,label_width:undefined,label_size:3,row_count:undefined,autocomplete:false,in_well:true,tabindex:undefined};if(c&&c.fields&&c.fields.length)j=c.fields;else j=this.edit_options.fields;if(j.length==0){n=this.edit_options.tabs;if(n)if(n.length===1&&!n[0].name&&n[0].bands.length===1){j=n[0].bands[0].fields;d=a.extend({},d,n[0].bands[0].options);}else{this.create_controls(b);return;}else this.each_field(function(a){if(a.field_name!==a.owner._primary_key&&a.field_name!==a.owner._deleted_flag)j.push(a.field_name);});}f=j.length;for(e=0;e<f;e++){h=this.field_by_name(j[e]);if(h)i.push(h);else console.error(this.item_name+' create_entries: there is not a field with field_name - "'+j[e]+'"');}c=a.extend({},d,c);b.empty();m=a('<form class="row-fluid" autocomplete="off"></form>').appendTo(b);if(c.in_well)m.addClass('well');if(c.autocomplete)m.attr("autocomplete","on");else m.attr("autocomplete","off");if(!c.label_on_top)m.addClass("form-horizontal");f=i.length;for(g=0;g<c.col_count;g++)k.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(m));l=c.tabindex;if(!c.row_count)c.row_count=Math.ceil(f/c.col_count);for(e=0;e<f;e++)new y(i[e],e+l,k[Math.floor(e/c.row_count)],c);},create_filter_inputs:function(b,c){var f,g,h,i,j,k=[],l=[],m,n;if(!b.length)return;f={filters:[],col_count:1,label_on_top:false,label_width:undefined,autocomplete:false,in_well:true,tabindex:undefined};c=a.extend({},f,c);if(c.filters.length){h=c.filters.length;for(g=0;g<h;g++)k.push(this.filter_by_name(c.filters[g]));}else this.each_filter(function(a,b){if(a.visible)k.push(a);});b.empty();n=a('<form form class="row-fluid" autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(c.in_well)n.addClass('well');if(c.autocomplete)n.attr("autocomplete","on");if(!c.label_on_top)n.addClass("form-horizontal");h=k.length;for(i=0;i<c.col_count;i++)l.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(n));m=c.tabindex;if(!m&&this.filter_form){m=this.filter_form.tabindex;this.filter_form.tabindex+=h;}for(g=0;g<h;g++){j=k[g];if(j.filter_type===e.FILTER_RANGE){new y(j.field,g+1,l[Math.floor(g%c.col_count)],c,j.filter_caption+' '+d.range_from);new y(j.field1,g+1,l[Math.floor(g%c.col_count)],c,j.filter_caption+' '+d.range_to);}else new y(j.field,g+1,l[Math.floor(g%c.col_count)],c,j.filter_caption);}},_find_lookup_value:function(a,b){if(b.field_kind===e.ITEM_FIELD){if(a.lookup_field&&a.lookup_field1){if(a.owner.ID===b.lookup_item.ID&&a.lookup_item.ID===b.lookup_item1.ID&&a.lookup_field===b.lookup_field1&&a.lookup_item1.ID===b.lookup_item2.ID&&a.lookup_field1===b.lookup_field2)return a.lookup_value;}else if(a.lookup_field){if(a.field_name===b.lookup_field&&a.owner.ID===b.lookup_item.ID&&a.lookup_field===b.lookup_field1&&a.lookup_item.ID===b.lookup_item1.ID)return a.lookup_value;}else if(a.field_name===b.lookup_field&&a.owner.ID===b.lookup_item.ID)return a.lookup_value;}else if(a.field_name===b.lookup_field)return a.lookup_value;},set_lookup_field_value:function(){if(this.record_count()){var a=this.lookup_field,b=this.field_by_name(a.lookup_field),c=null,d=this.lookup_field.owner,f=[],g={},h=this;if(b)c=this._find_lookup_value(b,a);if(a.owner&&a.owner.is_changing&&!a.owner.is_changing())a.owner.edit();if(this.lookup_field.data_type===e.KEYS)this.selections=[this._primary_key_field.value];else if(a.multi_select)a.set_value([this._primary_key_field.value],c);else{if(d)d.each_field(function(b){if(b.master_field===a)h.each_field(function(a){var c;if(a.lookup_value){c=h._find_lookup_value(a,b);if(c){g[b.field_name]=c;return false;}}});});a.set_value(this._primary_key_field.value,c,g,this);}}if(this.lookup_field)this.close_view_form();},get_default_field:function(){var a=0;if(this._default_field===undefined){this._default_field=null;for(a=0;a<this.fields.length;a++)if(this.fields[a].is_default){this._default_field=this.fields[a];break;}}return this._default_field;},set_edit_fields:function(a){this.edit_options.fields=a;},set_view_fields:function(a){this.view_options.fields=a;},round:function(a,b){return Number(a.toFixed(b));},refresh:function(a){},_do_on_refresh_record:function(a,b){var c,d;if(a.record_count()===1){d=a._dataset[0].length;for(c=0;c<d;c++)this._dataset[this.rec_no][c]=a._dataset[0][c];this.update_controls(e.UPDATE_CANCEL);if(b)b.call(this);}},refresh_record:function(a){var b=this._check_args(arguments),a=b['function'],c=b.boolean,d=this,e=[],f=this._primary_key,g={},h;if(this.master)throw 'The refresh_record method can not be executed for a detail item';if(!this.rec_count)return;h=this.copy({filters:false,details:false,handlers:false});if(this._primary_key_field.value){d.each_field(function(a){e.push(a.field_name);});g[f]=this._primary_key_field.value;if(a||c)h.open({expanded:this.expanded,fields:e,where:g},function(){d._do_on_refresh_record(h,a);});else{h.open({expanded:this.expanded,fields:e,where:g});this._do_on_refresh_record(h);}}},_do_on_refresh_page:function(a,b){if(a!==null)this.rec_no=a;this.update_controls(e.UPDATE_OPEN);if(b)b.call(this);},refresh_page:function(a){var b=this._check_args(arguments),c=b['function'],d=b.boolean,e=this,f=this.rec_no;if(!this.master)if(c||d)this.open({params:this._open_params,offset:this._open_params.__offset},function(){this._do_on_refresh_page(f,c);});else{this.open({params:this._open_params,offset:this._open_params.__offset});this._do_on_refresh_page(f,c);}},format_string:function(a,b){var c=a;if(typeof b==='object'){for(var d in b)if(b.hasOwnProperty(d))c=c.replace('%('+d+')s',b[d]+'');}else c=c.replace('%s',b+'');return c;}});p.prototype=new k();function p(b,c,d,f,g,h,i){k.call(this,b,c,d,f,g,h,i);if(this.task&&!(d in this.task))this.task[d]=this;this._fields=[];this.params=this._fields;this._state=e.STATE_EDIT;this.param_options=a.extend({},this.task.form_options);}a.extend(p.prototype,{constructor:p,_set_item_state:function(a){if(this._state!==a)this._state=a;},_get_item_state:function(){return this._state;},initAttr:function(a){var b,c=a.fields,d;if(c){d=c.length;for(b=0;b<d;b++)new t(this,c[b]);}},_bind_item:function(){var a=0,b,c=this.params.length;for(a=0;a<c;a++){b=this.params[a];if(b.lookup_item&&(typeof b.lookup_item==="number"))b.lookup_item=this.task.item_by_ID(b.lookup_item);if(b.lookup_field&&(typeof b.lookup_field==="number"))b.lookup_field=b.lookup_item._field_by_ID(b.lookup_field).field_name;if(b.lookup_values&&(typeof b.lookup_values==="number"))b.lookup_values=self.task.lookup_lists[b.lookup_values];}this.param_options.title=this.item_caption;},eachParam:function(a){var b=0,c=this.params.length,d;for(;b<c;b++){d=a.call(this.params[b],this.params[b],b);if(d===false)break;}},each_field:function(a){this.eachParam(a);},param_by_name:function(a){var b=0,c=this.params.length;for(;b<c;b++)if(this.params[b].param_name===a)return this.params[b];},create_param_form:function(a){this._create_form('param',a);},close_param_form:function(){this._close_form('param');},print:function(a,b){var c=this;this.load_modules([this,this.owner],function(){c._print(a,b);});},_print:function(){var a=this._check_args(arguments),b=a['function'],c=a.boolean;if(!c)this.eachParam(function(a){if(a.edit_visible){c=true;return false;}});if(c)this.create_param_form();else this.process_report(b);},checkParams:function(){var a,b=this.params.length;for(a=0;a<b;a++)try{this.params[a].check_valid();}catch(c){this.warning(c);return false;}return true;},process_report:function(a){var b=this,c=[location.protocol,'//',location.host,location.pathname].join(''),d,e,f=[];if(this.checkParams()){if(this.task.on_before_print_report)this.task.on_before_print_report.call(this,this);if(this.owner.on_before_print_report)this.owner.on_before_print_report.call(this,this);if(this.on_before_print_report)this.on_before_print_report.call(this,this);e=this.params.length;for(d=0;d<e;d++)f.push(this.params[d].get_data());this.send_request('print',[f,c,this.extension],function(c){var d,e,f,g,h;if(c)d=c[0],e=c[1];if(e)b.warning(e);if(d)if(b.on_open_report)b.on_open_report.call(b,b,d);else if(b.owner.on_open_report)b.owner.on_open_report.call(b.owner,b,d);else{f=d.split('.').pop();if(f==='ods')window.open(d,"_self");else{h=window.open(d,"_blank");if(b.send_to_printer)h.onload=function(){h.print();g=setTimeout(function(){h.onfocus=function(){h.close();};},1000);};}}if(a)a.call(b,b,d);});return true;}},create_param_inputs:function(b,c){var d,e,f,g,h=[],i=[],j,k;if(!b.length)return;d={params:[],col_count:1,label_on_top:false,label_width:undefined,autocomplete:false,in_well:true,tabindex:undefined};c=a.extend({},d,c);if(c.params.length){f=c.params.length;for(e=0;e<f;e++)h.push(this.param_by_name(c.params[e]));}else{this.eachParam(function(a){if(a.edit_visible&&a.edit_index!==-1)h.push(a);});h.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});}b.empty();j=a('<form form class="row-fluid" autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(c.in_well)j.addClass('well');if(c.autocomplete)j.attr("autocomplete","on");if(!c.label_on_top)j.addClass("form-horizontal");f=h.length;for(g=0;g<c.col_count;g++)i.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(j));k=c.tabindex;if(!k&&this.param_form){k=this.param_form.tabindex;this.param_form.tabindex+=f;}for(e=0;e<f;e++)new y(h[e],e+k,i[Math.floor(e%c.col_count)],c);}});q.prototype=new o();q.prototype.constructor=q;function q(a,b,c,d,e,f,g){o.call(this,a,b,c,d,e,f,g);if(a){this.master=a;a.details.push(this);a.details[c]=this;}this.item_type="detail";}q.prototype.getChildClass=function(){return undefined;};function r(a,b){this.owner=a;this.set_info(b);this.controls=[];this.bind_index=null;this.lookup_index=null;this.field_type=j[this.data_type];this.field_kind=e.ITEM_FIELD;if(a)a._fields.push(this);Object.defineProperty(this,"data",{get:function(){return this.get_data();}});Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"raw_value",{get:function(){return this.get_raw_value();}});Object.defineProperty(this,"text",{get:function(){return this.get_text();},set:function(a){this.set_text(a);}});Object.defineProperty(this,"display_text",{get:function(){return this.get_display_text();}});Object.defineProperty(this,"lookup_text",{get:function(){return this.get_lookup_text();}});Object.defineProperty(this,"lookup_value",{get:function(){return this.get_lookup_value();},set:function(a){this.set_lookup_value(a);}});Object.defineProperty(this,"lookup_type",{get:function(){return j[this.get_lookup_data_type()];}});Object.defineProperty(this,"alignment",{get:function(){return this.get_alignment();},set:function(a){this.set_alignment(a);}});Object.defineProperty(this,"read_only",{get:function(){return this._get_read_only();},set:function(a){this._set_read_only(a);}});}r.prototype={constructor:r,copy:function(a){var b=new r(a,this.get_info());b.lookup_item=this.lookup_item;b.lookup_field=this.lookup_field;return b;},get_info:function(){var a,b=h.length,c=[];for(a=0;a<b;a++)c.push(this[h[a]]);return c;},set_info:function(a){if(a){var b,c=h.length;for(b=0;b<c;b++)this[h[b]]=a[b];}},get_row:function(){if(this.owner._dataset&&this.owner._dataset.length)return this.owner._dataset[this.owner._get_rec_no()];else{var a=d.value_in_empty_dataset.replace('%s',this.owner.item_name);if(this.owner)this.owner.alert_error(a,{duration:0});throw a;}},get_data:function(){var a;if(this.field_kind===e.ITEM_FIELD){a=this.get_row();if(a&&this.bind_index>=0)return a[this.bind_index];}else return this._value;},set_data:function(a){var b;if(this.field_kind===e.ITEM_FIELD){b=this.get_row();if(b&&this.bind_index>=0)b[this.bind_index]=a;}else this._value=a;},get_lookup_data:function(){var a;if(this.field_kind===e.ITEM_FIELD){a=this.get_row();if(a&&this.lookup_index>=0)return a[this.lookup_index];}else return this._lookup_value;},set_lookup_data:function(a){var b;if(this.field_kind===e.ITEM_FIELD){b=this.get_row();if(b&&this.lookup_index>=0)b[this.lookup_index]=a;}else this._lookup_value=a;},get_text:function(){var a="",b="";try{if(this.data!==null){a=this.value;switch(this.data_type){case e.TEXT:break;case e.INTEGER:a=this.int_to_str(a);break;case e.FLOAT:a=this.float_to_str(a);break;case e.CURRENCY:a=this.float_to_str(a);break;case e.DATE:a=this.date_to_str(a);break;case e.DATETIME:a=this.datetime_to_str(a);break;case e.BOOLEAN:if(this.get_value())a=d.yes;else a=d.no;break;case e.KEYS:if(a.length)a=d.items_selected.replace('%s',a.length);break;}}}catch(c){a='';console.error(c);}if(typeof a!=='string')a='';return a;},set_text:function(a){var b="";if(a!==this.get_text())switch(this.data_type){case e.TEXT:this.set_value(a);break;case e.INTEGER:this.set_value(this.str_to_int(a));break;case e.FLOAT:this.set_value(this.str_to_float(a));break;case e.CURRENCY:this.set_value(this.str_to_float(a));break;case e.DATE:this.set_value(this.str_to_date(a));break;case e.DATETIME:this.set_value(this.str_to_datetime(a));break;case e.BOOLEAN:if(d)if(a.length&&a.toUpperCase().trim()===d.yes.toUpperCase().trim())this.set_value(true);else this.set_value(false);else if(a.length&&(a[0]==='T'||a[0]==='t'))this.set_value(true);else this.set_value(false);break;case e.KEYS:break;default:this.set_value(a);}},_convert_date_time:function(a){if(a){if(a.search('.')!==-1)a=a.split('.')[0];return this.format_string_to_date(a,'%Y-%m-%d %H:%M:%S');}else return a;},_convert_date:function(a){if(a){if(a.search(' ')!==-1)a=a.split(' ')[0];return this.format_string_to_date(a,'%Y-%m-%d');}else return a;},_convert_keys:function(a){var b=[];if(this.get_lookup_data())return this.get_lookup_data();else if(a)if(this.get_lookup_data_type()===e.TEXT)b=a.split(';');else b=a.split(';').map(function(a){return parseInt(a,10);});this.set_lookup_data(b);return b;},get_raw_value:function(){var a=this.get_data();if(this.data_type===e.DATETIME&&a)a=a.replace('T',' ');else if(this.multi_select)if(a instanceof Array)if(!a.length)a=null;return a;},get_value:function(){var a=this.get_raw_value();if(a===null){if(this.field_kind===e.ITEM_FIELD)switch(this.data_type){case e.INTEGER:a=0;break;case e.FLOAT:a=0;break;case e.CURRENCY:a=0;break;case e.TEXT:a='';break;case e.BOOLEAN:a=false;break;case e.KEYS:a=[];break;}else if(this.data_type===e.KEYS)a=[];}else switch(this.data_type){case e.DATE:a=this._convert_date(a);break;case e.DATETIME:a=this._convert_date_time(a);break;case e.BOOLEAN:return a?true:false;break;case e.KEYS:return this._convert_keys(a);break;}return a;},_change_lookup_field:function(a,b){var c=this,d=this.owner,e;if(this.lookup_item){if(this.owner){e=this;if(this.master_field)e=this.master_field;e.lookup_value=null;this.owner.each_field(function(a){if(a.master_field===e)if(e===c&&b&&b[a.field_name])a.lookup_value=b[a.field_name];else a.lookup_value=null;});}if(a)this.lookup_value=a;}},_do_before_changed:function(){if(this.field_kind===e.ITEM_FIELD){if(this.owner._get_item_state()!==e.STATE_INSERT&&this.owner._get_item_state()!==e.STATE_EDIT)throw d.not_edit_insert_state.replace('%s',this.owner.item_name);if(this.owner.on_before_field_changed)this.owner.on_before_field_changed.call(this.owner,this);}},_do_after_changed:function(a){if(this.owner&&this.owner.on_field_changed)this.owner.on_field_changed.call(this.owner,this,a);if(this.filter){this.filter.update(this);if(this.filter.owner.on_filter_changed)this.filter.owner.on_filter_changed.call(this.filter.owner,this.filter);}},_check_system_field_value:function(a){if(this.field_kind===e.ITEM_FIELD){if(this.field_name===this.owner._primary_key&&this.value&&this.value!==a)throw d.no_primary_field_changing.replace('%s',this.owner.item_name);if(this.field_name===this.owner._deleted_flag&&this.value!==a)throw d.no_deleted_field_changing.replace('%s',this.owner.item_name);}},set_value:function(a,b,c,d){if(a===undefined)a=null;this._check_system_field_value(a);this.new_value=null;this.new_lookup_value=b;if(a!==null){this.new_value=a;if(!this.multi_select)switch(this.data_type){case e.INTEGER:this.new_value=a;if(typeof a==="string")this.new_value=parseInt(a,10);break;case e.FLOAT:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case e.CURRENCY:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case e.BOOLEAN:this.new_value=a?1:0;break;case e.DATE:this.new_value=this.format_date_to_string(a,'%Y-%m-%d');break;case e.DATETIME:this.new_value=this.format_date_to_string(a,'%Y-%m-%d %H:%M:%S');break;case e.TEXT:this.new_value=a+'';break;case e.KEYS:this.new_value=a.join(';');b=a;break;}}if(this.get_raw_value()!==this.new_value){this._do_before_changed();try{this.set_data(this.new_value);}catch(f){throw this.field_name+": "+this.type_error();}this._change_lookup_field(b,c);this._set_modified(true);this._do_after_changed(d);}else if(b&&b!==this.lookup_value){this.lookup_value=b;this._do_after_changed(d,c);}this.new_value=null;this.new_lookup_value=null;this.update_controls();},_set_modified:function(a){if(this.field_kind===e.ITEM_FIELD)if(this.owner._set_modified&&!this.calculated)this.owner._set_modified(a);},get_lookup_data_type:function(){if(this.lookup_values)return e.TEXT;else if(this.lookup_item)if(this.lookup_field2)return this.lookup_item2._field_by_name(this.lookup_field2).data_type;else if(this.lookup_field1)return this.lookup_item1._field_by_name(this.lookup_field1).data_type;else return this.lookup_item._field_by_name(this.lookup_field).data_type;else return this.data_type;},_get_value_in_list:function(a){var b=0,c=this.lookup_values.length,d='';if(a===undefined)a=this.data;for(;b<c;b++)if(this.lookup_values[b][0]===a)d=this.lookup_values[b][1];return d;},get_lookup_value:function(){var a=null;if(this.lookup_values)try{a=this._get_value_in_list();}catch(b){}else if(this.lookup_item){if(this.get_value()){a=this.get_lookup_data();switch(this.get_lookup_data_type()){case e.DATE:if(typeof a==="string")a=this._convert_date(a);break;case e.DATETIME:if(typeof a==="string")a=this._convert_date_time(a);break;case e.BOOLEAN:if(a)return true;else return false;break;}}}else a=this.get_value();return a;},set_lookup_value:function(a){if(this.lookup_item){this.set_lookup_data(a);this.update_controls();}},get_lookup_text:function(){var a=this,b,c,d='';try{if(this.lookup_values)d=this.get_lookup_value();else if(this.lookup_item){if(this.data_type===e.KEYS)d=this.text;else if(this.get_value()){c=this.lookup_item.field_by_name(this.lookup_field);if(c.lookup_values)d=c._get_value_in_list(this.lookup_value);else d=this.get_lookup_value();}if(d===null)d='';else{b=this.get_lookup_data_type();if(b)switch(b){case e.DATE:d=this.date_to_str(d);break;case e.DATETIME:d=this.datetime_to_str(d);break;case e.FLOAT:d=this.float_to_str(d);break;case e.CURRENCY:d=this.cur_to_str(d);break;}}}}catch(f){}return d;},get_display_text:function(){var a,b,c,f='';if(this.multi_select){c=this.raw_value;if(c instanceof Array)b=c.length;if(b)if(b===1&&this.lookup_value)f=this.lookup_value;else f=d.items_selected.replace('%s',b);}else if(this.lookup_values){f=this.get_lookup_text();if(f==='&nbsp')f='';}else if(this.lookup_item)if(this.field_kind===e.ITEM_FIELD&&!this.owner.expanded)f=this.get_text();else f=this.get_lookup_text();else if(this.data_type===e.CURRENCY){if(this.raw_value!==null)f=this.cur_to_str(this.get_value());}else f=this.get_text();if(this.owner&&(this.owner.on_field_get_text||this.owner.on_get_field_text))if(!this.on_field_get_text_called){this.on_field_get_text_called=true;try{if(this.owner.on_field_get_text)a=this.owner.on_field_get_text.call(this.owner,this);else if(this.owner.on_get_field_text)a=this.owner.on_get_field_text.call(this.owner,this);if(a!==undefined)f=a;}finally{this.on_field_get_text_called=false;}}if(f===undefined)f='';return f;},assign_default_value:function(){if(this.default_value)try{switch(this.data_type){case e.INTEGER:this.value=parseInt(this.default_value,10);break;case e.FLOAT:case e.CURRENCY:this.value=parseFloat(this.default_value);break;case e.DATE:if(this.default_value==='current date')this.value=new Date();break;case e.DATETIME:if(this.default_value==='current datetime')this.value=new Date();break;case e.BOOLEAN:if(this.default_value==='true')this.value=true;else if(this.default_value==='false')this.value=false;break;case e.TEXT:case e.LONGTEXT:this.value=this.default_value;break;}}catch(a){console.error(a);}},_set_read_only:function(a){this._read_only=a;this.update_controls();},_get_read_only:function(){var a=this._read_only;if(this.owner&&this.owner._get_read_only&&this.owner._get_read_only())a=this.owner._get_read_only();return a;},set_visible:function(a){this._visible=a;this.update_controls();},get_visible:function(){return this._visible;},set_alignment:function(a){this._alignment=a;this.update_controls();},get_alignment:function(){return this._alignment;},set_expand:function(a){this._expand=a;this.update_controls();},get_expand:function(){return this._expand;},set_word_wrap:function(a){this._word_wrap=a;this.update_controls();},get_word_wrap:function(){return this._word_wrap;},check_type:function(){this.get_value();if((this.data_type===e.TEXT)&&(this.field_size!==0)&&(this.get_text().length>this.field_size))throw this.field_caption+': '+d.invalid_length.replace('%s',this.field_size);return true;},check_reqired:function(){if(!this.required)return true;else if(this.data!==null)return true;else throw this.field_caption+': '+d.value_required;},get_mask:function(){var a='',b,d='';if(this.data_type===e.DATE)b=c.D_FMT;else if(this.data_type===e.DATETIME)b=c.D_T_FMT;if(b)for(var f=0;f<b.length;++f){a=b.charAt(f);switch(a){case "%":break;case "d":case "m":d+='99';break;case "Y":d+='9999';break;case "H":case "M":case "S":d+='99';break;default:d+=a;}}return d;},check_valid:function(){var a;if(this.check_reqired())if(this.check_type()){if(this.owner&&this.owner.on_field_validate){a=this.owner.on_field_validate.call(this.owner,this);if(a){throw a;return;}}if(this.filter){a=this.filter.check_value(this);if(a){throw a;return;}}return true;}},typeahead_options:function(){var a=this,b=10,c=a.lookup_item.copy(),d;c.lookup_field=this,d={length:b,lookup_item:c,source:function(d,f){var g={};a._do_select_value(c);g.__search=[a.lookup_field,d,e.FILTER_CONTAINS_ALL];c.open({limit:b,params:g},function(b){var c=[],d=b.field_by_name(a.lookup_field);b.each(function(a){c.push([a._primary_key_field.value,d.value]);});return f(c);});}};return d;},get_typeahead_defs:function(a){var b=this,c,d=10,f;c=b.lookup_item.copy(),c.lookup_field=this,f={items:d,lookup_item:c,field:this,source:function(a,f){var g={};b._do_select_value(c);g.__search=[b.lookup_field,a,e.FILTER_CONTAINS_ALL];c.open({limit:d,params:g},function(a){var c=[],d=a.field_by_name(b.lookup_field);a.each(function(a){c.push([a._primary_key_field.value,d.value]);});return f(c);});}};return f;},numeric_field:function(){if(!this.lookup_item&&(this.data_type===e.INTEGER||this.data_type===e.FLOAT||this.data_type===e.CURRENCY))return true;},system_field:function(){if(this.field_name===this.owner._primary_key||this.field_name===this.owner._deleted_flag||this.field_name===this.owner._master_id||this.field_name===this.owner._master_rec_id)return true;},_check_args:function(a){var b,c={};for(b=0;b<a.length;b++)c[typeof a[b]]=a[b];return c;},update_controls:function(){var a,b,c=this._check_args(arguments),d=c.boolean,e=c.number;b=this.controls.length;for(a=0;a<b;a++)this.controls[a].update(e);if(!d&&this.owner&&this.owner.controls){b=this.owner.controls.length;for(a=0;a<b;a++)this.owner.controls[a].update_field(this);}},update_control_state:function(a){for(var b=0;b<this.controls.length;b++){this.controls[b].error=a;this.controls[b].updateState(false);}},type_error:function(){switch(this.data_type){case e.INTEGER:return d.invalid_int.replace('%s','');case e.FLOAT:return d.invalid_float.replace('%s','');case e.CURRENCY:return d.invalid_cur.replace('%s','');case e.DATE:return d.invalid_date.replace('%s','');case e.DATE_TIME:return d.invalid_date.replace('%s','');case e.BOOLEAN:return d.invalid_bool.replace('%s','');default:return d.invalid_value.replace('%s','');}},valid_char_code:function(a){var b=String.fromCharCode(a),d=a>=48&&a<=57,f=b==='.'||b===c.DECIMAL_POINT||b===c.MON_DECIMAL_POINT,g=b==='+'||b==='-',h=this.get_lookup_data_type();if(h===e.INTEGER)if(!d&&!g)return false;if(h===e.FLOAT||h===e.CURRENCY)if(!d&&!g&&!f)return false;return true;},str_to_int:function(a){var b=parseInt(a,10);if(isNaN(b))throw "invalid integer value";return b;},str_to_date:function(a){return this.format_string_to_date(a,c.D_FMT);},str_to_datetime:function(a){return this.format_string_to_date(a,c.D_T_FMT);},str_to_float:function(a){var b;a=a.replace(c.DECIMAL_POINT,".");a=a.replace(c.MON_DECIMAL_POINT,".");b=parseFloat(a);if(isNaN(b))throw "invalid float value";return b;},str_to_cur:function(b){var d='';if(value){d=a.trim(b);if(c.MON_THOUSANDS_SEP)d=d.replace(c.MON_THOUSANDS_SEP,'');if(c.CURRENCY_SYMBOL)d=a.trim(d.replace(c.CURRENCY_SYMBOL,''));if(c.POSITIVE_SIGN)d=d.replace(c.POSITIVE_SIGN,'');if(c.NEGATIVE_SIGN&&d.indexOf(c.NEGATIVE_SIGN)!==-1){d=d.replace(c.NEGATIVE_SIGN,'');d='-'+d;}d=a.trim(d.replace(c.MON_DECIMAL_POINT,'.'));d=parseFloat(d);}return d;},int_to_str:function(a){if(a||a===0)return a.toString();else return '';},float_to_str:function(a){var b,d,e='';if(a||a===0){b=(''+a.toFixed(6)).replace(".",c.DECIMAL_POINT);d=b.length-1;for(;d>=0;d--)if((b[d]==='0')&&(e.length===0))continue;else e=b[d]+e;if(e.slice(e.length-1)===c.DECIMAL_POINT)e=e+'0';}return e;},date_to_str:function(a){if(a)return this.format_date_to_string(a,c.D_FMT);else return '';},datetime_to_str:function(a){if(a)return this.format_date_to_string(a,c.D_T_FMT);else return '';},cur_to_str:function(a){var d,e,f,g,h,i=0,j,k='';if(a||a===0){k=a.toFixed(c.FRAC_DIGITS);if(isNaN(k[0]))k=k.slice(1,k.length);d=k.indexOf('.');e='';f=k;if(d>=0){f=k.slice(0,d);e=k.slice(d+1,k.length);}k='';j=f.length;for(g=0;g<j;g++){h=f[j-g-1];k=h+k;i+=1;if((i%3===0)&&(g!==j-1))k=c.MON_THOUSANDS_SEP+k;}if(e)k=k+c.MON_DECIMAL_POINT+e;if(a<0){if(c.N_SIGN_POSN===3)k=c.NEGATIVE_SIGN+k;else if(c.N_SIGN_POSN===4)k=b.result+c.NEGATIVE_SIGN;}else if(c.P_SIGN_POSN===3)k=c.POSITIVE_SIGN+k;else if(c.P_SIGN_POSN===4)k=k+c.POSITIVE_SIGN;if(c.CURRENCY_SYMBOL)if(a<0)if(c.N_CS_PRECEDES)if(c.N_SEP_BY_SPACE)k=c.CURRENCY_SYMBOL+' '+k;else k=c.CURRENCY_SYMBOL+k;else if(c.N_SEP_BY_SPACE)k=k+' '+c.CURRENCY_SYMBOL;else k=k+c.CURRENCY_SYMBOL;else if(c.P_CS_PRECEDES)if(c.P_SEP_BY_SPACE)k=c.CURRENCY_SYMBOL+' '+k;else k=c.CURRENCY_SYMBOL+k;else if(c.P_SEP_BY_SPACE)k=k+' '+c.CURRENCY_SYMBOL;else k=k+c.CURRENCY_SYMBOL;if(a<0){if(c.N_SIGN_POSN===0&&c.NEGATIVE_SIGN)k=c.NEGATIVE_SIGN+'('+k+')';else if(c.N_SIGN_POSN===1)k=c.NEGATIVE_SIGN+k;else if(c.N_SIGN_POSN===2)k=k+c.NEGATIVE_SIGN;}else if(c.P_SIGN_POSN===0&&c.POSITIVE_SIGN)k=c.POSITIVE_SIGN+'('+k+')';else if(c.P_SIGN_POSN===1)k=c.POSITIVE_SIGN+k;else if(c.P_SIGN_POSN===2)k=k+c.POSITIVE_SIGN;}return k;},parseDateInt:function(a,b){var c=parseInt(a.substring(0,b),10);if(isNaN(c))throw 'invalid date';return c;},format_string_to_date:function(a,b){var c='',d=a,e,f,g,h=0,i=0,j=0;for(var k=0;k<b.length;++k){c=b.charAt(k);switch(c){case "%":break;case "d":e=this.parseDateInt(d,2);d=d.slice(2);break;case "m":f=this.parseDateInt(d,2);d=d.slice(2);break;case "Y":g=this.parseDateInt(d,4);d=d.slice(4);break;case "H":h=this.parseDateInt(d,2);d=d.slice(2);break;case "M":i=this.parseDateInt(d,2);d=d.slice(2);break;case "S":j=this.parseDateInt(d,2);d=d.slice(2);break;default:d=d.slice(c.length);}}return new Date(g,f-1,e,h,i,j);},leftPad:function(a,b,c){var d=a.toString();while(d.length<b)d=c+d;return d;},format_date_to_string:function(a,b){var c='',d='';for(var e=0;e<b.length;++e){c=b.charAt(e);switch(c){case "%":break;case "d":d+=this.leftPad(a.getDate(),2,'0');break;case "m":d+=this.leftPad(a.getMonth()+1,2,'0');break;case "Y":d+=a.getFullYear();break;case "H":d+=this.leftPad(a.getHours(),2,'0');break;case "M":d+=this.leftPad(a.getMinutes(),2,'0');break;case "S":d+=this.leftPad(a.getSeconds(),2,'0');break;default:d+=c;}}return d;},_do_select_value:function(a){if(this.owner&&this.owner.on_param_select_value)this.owner.on_param_select_value.call(this.owner,this,a);if(this.owner&&this.owner.on_field_select_value)this.owner.on_field_select_value.call(this.owner,this,a);if(this.filter&&this.filter.owner.on_filter_select_value)this.filter.owner.on_filter_select_value.call(this.filter.owner,this.filter,a);},select_value:function(){var a=this,b=this.lookup_item.copy(),c=b.on_view_form_closed;if(!b.can_view()){task.alert(task.language.cant_view.replace('%s',b.item_caption));return;}b.is_lookup_item=true;b.lookup_field=this;if(this.data_type===e.KEYS){b.selections=this.value;b.on_view_form_closed=function(d){if(c)c(d);a.value=b.selections;};}this._do_select_value(b);b.view();}};function s(a,b){var c=this,f;this.owner=a;this.set_info(b);if(a){a.filters.push(this);if(!(this.filter_name in a.filters))a.filters[this.filter_name]=this;if(this.field_name){f=this.owner._field_by_ID(this.field_name);this.field=this.create_field(f);this.field.required=false;if(this.field.lookup_values&&(typeof this.field.lookup_values==="number"))this.field.lookup_values=this.owner.task.lookup_lists[this.field.lookup_values];this.field.field_help=this.filter_help;this.field.field_placeholder=this.filter_placeholder;this.field.multi_select_all=this.multi_select_all;if(this.filter_type===e.FILTER_IN||this.filter_type===e.FILTER_NOT_IN)this.field.multi_select=true;if(this.filter_type===e.FILTER_RANGE){this.field1=this.create_field(f);this.field1.field_help=undefined;}if(this.field.data_type===e.BOOLEAN||this.filter_type===e.FILTER_ISNULL){this.field.bool_filter=true;this.field.data_type=e.INTEGER;this.field.lookup_values=[[null,''],[0,d.no],[1,d.yes]];}}}Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"text",{get:function(){return this.get_text();}});}s.prototype={constructor:s,create_field:function(a){var b=new r();b.set_info(a.get_info());b._read_only=false;b.filter=this;b._value=null;b._lookup_value=null;b.field_kind=e.FILTER_FIELD;return b;},copy:function(a){var b=new s(a,this.get_info());return b;},get_info:function(){var a,b=i.length,c=[];for(a=0;a<b;a++)c.push(this[i[a]]);return c;},set_info:function(a){if(a){var b,c=i.length;for(b=0;b<c;b++)this[i[b]]=a[b];}},get_value:function(){var a;if(this.filter_type===e.FILTER_RANGE)if(this.field.raw_value!==null&&this.field1.raw_value!==null)return [this.field.raw_value,this.field1.raw_value];else return null;else return this.field.raw_value;},set_value:function(a,b){var c;if(this.filter_type===e.FILTER_RANGE)if(a===null){this.field.value=null;this.field1.value=null;}else{this.field.value=a[0];this.field1.value=a[1];}else this.field.set_value(a,b);},update:function(a){var b=this.field,c;if(this.filter_type===e.FILTER_RANGE)if(a.value!==null){if(a===this.field)b=this.field1;if(b.raw_value===null)b.value=a.value;}},check_valid:function(){var a=this.check_value(this.field);if(a)throw a;},check_value:function(a){if(this.filter_type===e.FILTER_RANGE)if(this.field.raw_value===null&&this.field1.raw_value!==null||this.field.raw_value!==null&&this.field1.raw_value===null||this.field.value>this.field1.value)return d.invalid_range;},get_text:function(){var a='';if(this.visible&&this.value!=null){a=this.filter_caption+': ';if(this.filter_type===e.FILTER_RANGE)a+=this.field.get_display_text()+' - '+this.field1.get_display_text();else a+=this.field.display_text;}return a;},get_html:function(){var a,b='';if(this.visible&&this.value!=null){b=this.filter_caption+': ';if(this.filter_type===e.FILTER_RANGE)a=this.field.get_display_text()+' - '+this.field1.get_display_text();else a=this.field.display_text;b+='<b>'+a+'</b>';}return b;}};t.prototype=new r();t.prototype.constructor=r;function t(a,b){r.call(this,a,b);this.param_name=this.field_name;this.param_caption=this.field_caption;this.field_size=0;this.report=a;this._value=null;this._lookup_value=null;this.field_kind=e.PARAM_FIELD;if(this.owner[this.param_name]===undefined)this.owner[this.param_name]=this;}function u(a,b,c,d,e,f){this.init(a,b,c,d,e,f);}u.prototype={constructor:u,init:function(b,c,d){var e=this,f={id_field:undefined,parent_field:undefined,text_field:undefined,parent_of_root_value:undefined,text_tree:undefined,on_click:undefined,on_dbl_click:undefined};this.id=b.task.controlId++;this.item=b;this.$container=c;this.options=a.extend({},f,d);this.$element=a('<div class="dbtree '+this.item.item_name+'" tabindex="0" style="overflow-x:auto; overflow-y:auto;"></div>');this.$element.css('position','relative');this.$element.data('tree',this);this.$element.tabindex=0;this.item.controls.push(this);this.$element.bind('destroyed',function(){e.item.controls.splice(e.item.controls.indexOf(e),1);});this.$element.appendTo(this.$container);this.height(c.height());this.$element.on('focus blur',function(a){e.select_node(e.selected_node,false);});this.$element.on('keyup',function(a){e.keyup(a);});this.$element.on('keydown',function(a){e.keydown(a);});if(b._get_active()&&this.$container.width())this.build();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},height:function(a){if(a)this.$element.height(a);else return this.$element.height();},is_focused:function(){return this.$element.get(0)===document.activeElement;},scroll_into_view:function(){this.select_node(this.selected_node);},update:function(a){var b,c=this,d;if(this.form_closing())return;switch(a){case e.UPDATE_OPEN:this.build();break;case e.UPDATE_CANCEL:this.changed();break;case e.UPDATE_APPEND:this.changed();break;case e.UPDATE_INSERT:this.changed();break;case e.UPDATE_DELETE:case e.UPDATE_DELETE:this.changed();break;case e.UPDATE_SCROLLED:this.syncronize();break;case e.UPDATE_CONTROLS:this.build();break;case e.UPDATE_CLOSE:this.$element.empty();break;}},keydown:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(this.selected_node&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.toggle_expanded(this.selected_node);break;case 38:a.preventDefault();c=this.selected_node.prev();if(c.length)this.select_node(c);else{c=this.selected_node.parent().parent();if(c.length&&c.prop("tagName")==="LI")this.select_node(c);}break;case 40:a.preventDefault();if(this.selected_node.hasClass('parent')&&!this.selected_node.hasClass('collapsed')){c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}else{c=this.selected_node.next();if(c.length)this.select_node(c);else{c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}}break;}},keyup:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 13:break;case 38:break;case 40:break;}},build_child_nodes:function(a,b){var c=0,d=b.length,e,f,g,h,i,j,k,l,m,n,o,p;for(c=0;c<d;c++){e=b[c];f=e.id;g=e.text;h=e.rec;i='<span class="empty-bullet"></span>',j="",k="",o=this.child_nodes[f+''];if(o&&o.length){i='<i class="icon-chevron-right bullet"></i>';j=' parent';k='collapsed';}l='<li class="'+k+j+'" style="list-style: none" data-rec="'+h+'">'+'<div><span class="tree-bullet">'+i+'</span>'+'<span class="tree-text">'+g+'<span></div>';a+=l;if(o&&o.length){a+='<ul style="display: none">';a=this.build_child_nodes(a,o);a+='</ul>';}a+='</li>';a+='</li>';}return a;},collect_nodes:function(a){var b=a[this.options.id_field],c=a[this.options.parent_field],d=a[this.options.text_field],e;this.child_nodes={};a.first();while(!a.eof()){e=this.child_nodes[c.value+''];if(e===undefined){e=[];this.child_nodes[c.value+'']=e;}e.push({'id':b.value,'text':d.display_text,'rec':a.rec_no});a.next();}},build:function(){var b=this,c=this.item.clone(),d='<ul>',e,f,g,h,i,j,k;c.on_field_get_text=this.item.on_field_get_text;this.collect_nodes(c);this.$element.empty();k=this.child_nodes[this.options.parent_of_root_value+''];if(k&&k.length)d=this.build_child_nodes(d,k);d+='</ul>';this.$element.append(a(d));j=this.$element.find('li');f=j.length;for(e=0;e<f;e++){i=j.eq(e);g=i.data('rec');c._set_rec_no(g);this.item._cur_row=g;i.data("record",c._dataset[g]);h=c.rec_controls_info();h[this.id]=i.get(0);if(this.options.node_callback)this.options.node_callback(i,this.item);}this.select_node(j.eq(0));this.$element.off('click','li.parent > div span.tree-bullet');this.$element.on('click','li.parent > div span.tree-bullet',function(c){var d=a(this),e=d.parent().parent(),f;b.toggle_expanded(e);c.preventDefault();c.stopPropagation();});this.$element.off('click','li > div span.tree-text');this.$element.on('click','li > div span.tree-text',function(c){var d=a(this).parent().parent();b.select_node(d);});},toggle_expanded:function(a){var b=a.find('div:first span.tree-bullet'),c;if(a.hasClass('parent')){c=a.find('ul:first'),a.toggleClass('collapsed');if(a.hasClass('collapsed'))b.html('<i class="icon-chevron-right bullet"></i>');else b.html('<i class="icon-chevron-down bullet"></i>');c.slideToggle(0);}},expand:function(a){if(a.hasClass('parent')&&a.hasClass('collapsed'))this.toggle_expanded(a);a=a.parent().parent();if(a.prop("tagName")==="LI")this.expand(a);},collapse:function(a){if(a.hasClass('parent')&&!a.hasClass('collapsed'))this.toggle_expanded(a);},select_node:function(a,b){var c=this,d,e;if(b===undefined)b=true;if(this.selected_node)this.selected_node.removeClass('selected selected-focused');if(a&&(!this.selected_node||a.get(0)!==this.selected_node.get(0))){this.selected_node=a;e=this.item._dataset.indexOf(a.data("record"));if(e!==this.item.rec_no)this.item._set_rec_no(e);d=this.selected_node.parent().parent();if(d.prop("tagName")==="LI")this.expand(d);}if(this.is_focused())this.selected_node.addClass('selected-focused');else this.selected_node.addClass('selected');if(b)this.update_selected_node(this.selected_node);},update_selected_node:function(a){var b,c,d,e,f;if(a.length){b=this.$element.scrollTop();c=b+this.$element.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$element.scrollTop(d);else if(e>c)this.$element.scrollTop(e-this.$element.height());}},update_field:function(){},syncronize:function(){var b,c;if(this.item.record_count())try{b=this.item.rec_controls_info(),c=a(b[this.id]);this.select_node(c);}catch(d){console.log(d);}},changed:function(){}};function v(a,b,c,d){this.init(a,b,c,d);}v.prototype={constructor:v,init:function(b,c,d,e){var f=this;if(!c.length)return;this.item=b;this.id=b.task._grid_id++;this.$container=c;this.$container.css('position','relative');this.master_table=e;this.editMode=false;this._sorted_fields=[];this._multiple_sort=false;this.page=0;this.record_count=0;this.cellWidths={};this.auto_field_width=true;this.scrollLeft=0;this.field_width_updated=false;this.init_options(d);this.init_selections();this.init_fields();this.$element=a('<div class="dbtable">');this.$element.addClass(b.item_name);this.$element.append(a('<div class="table-container" style="overflow-x:auto;">'));this.$element.append(a('<div class="paginator text-center">'));if(this.options.table_class)this.$element.addClass(this.options.table_class);this.$element.data('dbtable',this);this.item.controls.push(this);this.resize_id='resize.dbtable-'+this.item.item_name+this.id;if(this.master_table){this.$element.addClass('freezed');this.resize_id='resize.dbtable.freezed-'+this.item.item_name+this.id;}a(window).on(this.resize_id,function(){clearTimeout(f.timeOut);f.timeOut=setTimeout(function(){if(f.master_table&&!f.master_table.freezed_table)return;f.build();f.sync_freezed();},50);});this.$element.bind('destroyed',function(){a(window).off(f.resize_id);f.item.controls.splice(f.item.controls.indexOf(f),1);});this.$container.empty();this.$element.appendTo(this.$container);this.createTable();this.create_pager();this.sync_freezed();if(b._get_active())f.do_after_open();},ids_to_field_names:function(a){var b,c,d;if(a&&a.length){d=[];for(b=0;b<a.length;b++){c=this.item._field_by_ID(a[b]);if(c)d.push(c.field_name);}}return d;},init_options:function(b){var c={table_class:undefined,multiselect:false,height:undefined,row_count:undefined,fields:[],column_width:{},title_word_wrap:false,row_line_count:1,expand_selected_row:0,selections:undefined,select_all:true,selection_limit:undefined,tabindex:0,striped:true,dblclick_edit:true,on_click:undefined,on_dblclick:undefined,on_pagecount_update:undefined,on_page_changed:undefined,editable:false,editable_fields:undefined,keypress_edit:true,selected_field:undefined,append_on_lastrow_keydown:false,sortable:false,sort_fields:undefined,sort_add_primary:false,row_callback:undefined,title_callback:undefined,summary_fields:[],show_footer:undefined,show_paginator:true,paginator_container:undefined,freeze_count:0,hide_y_scroll:true};this.options=a.extend(true,{},c,this.item.table_options);this.options=a.extend({},this.options,b);if(!this.item._paginate)c.striped=false;if(this.options.row_count)this.options.height=undefined;if(!this.options.height&&!this.options.row_count)this.options.height=480;if(this.options.row_line_count<1){this.options.row_line_count=0;this.options.hide_y_scroll=false;}if(this.item.master)this.options.select_all=false;if(this.options.summary_fields&&this.options.summary_fields.length)this.options.show_footer=true;if(this.options.editable_fields&&this.options.editable_fields.length)this.options.editable=true;if(this.options.sort_fields&&this.options.sort_fields.length)this.options.sortable=true;this.on_dblclick=this.options.on_dblclick;},init_fields:function(){var a=0,b,c,d=[];this.fields=[];if(this.options.fields.length)d=this.options.fields;else if(this.item.view_options.fields&&this.item.view_options.fields.length)d=this.item.view_options.fields;else if(!d.length)this.item.each_field(function(a){if(a.field_name!==a.owner._primary_key&&a.field_name!==a.owner._deleted_flag)d.push(a.field_name);});if(d.length){b=d.length;for(a=0;a<b;a++){c=this.item.field_by_name(d[a]);if(c)this.fields.push(c);}}if(this.options.editable)this.options.striped=false;this.editableFields=[];if(this.options.editable_fields){b=this.fields.length;for(a=0;a<b;a++)if(!this.fields[a].read_only)if(this.options.editable_fields.indexOf(this.fields[a].field_name)!==-1)this.editableFields.push(this.fields[a]);}else{b=this.fields.length;for(a=0;a<b;a++)if(!this.fields[a].read_only)this.editableFields.push(this.fields[a]);}this.initSelectedField();this.colspan=this.fields.length;if(this.options.multiselect)this.colspan+=1;},can_edit:function(){if(this.item.read_only)return false;if(this.item.master&&!this.item.master.is_changing())return false;return this.options.editable;},get_freezed_fields:function(a){var b,c=[];if(!a)a=this.options.freeze_count;for(b=0;b<a;b++)c.push(this.fields[b].field_name);return c;},create_freezed_table:function(){var b,c,d;c=a.extend({},this.options);c.show_paginator=false;c.fields=[];c.freeze_count=0;c.fields=this.get_freezed_fields();d=a('<div>');this.freezed_table=new v(this.item,d,c,this);this.freezed_table.$element.detach();this.freezed_table.$element.css('position','absolute');this.freezed_table.$element.css('left','0');this.freezed_table.$element.css('top','0');this.freezed_table.$element.css('overflow','hidden');this.freezed_table.$table_container.css('overflow','hidden');this.freezed_table.$outer_table.css('overflow','hidden');this.freezed_table.$scroll_div.css('overflow','hidden');this.freezed_table.$container=this.$container;this.$container.append(this.freezed_table.$element);},delete_freezed_table:function(){this.freezed_table.$element.remove();delete this.freezed_table;this.freezed_table=undefined;},sync_freezed:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;if(this.options.freeze_count){if(this.freezed_table){h=this.get_freezed_fields();i=this.freezed_table.get_freezed_fields(this.options.freeze_count);j=h.length===i.length;if(j)for(a=0;a<h.length;a++)if(h[a]!==i[a]){j=false;break;}if(!j)this.delete_freezed_table();}if(this.$scroll_div.get(0).scrollWidth>this.$element.innerWidth()){if(!this.freezed_table)this.create_freezed_table();b=this.options.freeze_count-1;if(this.options.multiselect)b+=1;c=this.$head.find('th').eq(b);k=this.$element.find('.table-container')[0].scrollLeft;m=k+(c.position().left+c.outerWidth(true)+1);this.freezed_table.$element.width(m);}else if(this.freezed_table)this.delete_freezed_table();}else if(this.master_table){this.$outer_table.find('thead tr').height(this.master_table.$outer_table.find('thead tr').height());for(a=0;a<this.fields.length-1;a++){g=this.fields[a].field_name;f=this.master_table.getCellWidth(g);this.setCellWidth(g,f);d=this.$table.find('td.'+g);c=this.$element.find("thead tr:first th."+g);e=this.$element.find("tfoot tr:first th."+g);d.width(f);d.find('div').width(f);c.width(f);c.find('div').width(f);e.width(f);e.find('div').width(f);}this.syncColWidth();}},init_selections:function(){var a;if(this.options.multiselect&&!this.item.selections)this.item.selections=[];if(this.item.selections)this.options.multiselect=true;if(this.options.selections&&this.options.selections.length){this.item.selections=this.options.selections;this.options.multiselect=true;}if(this.item.lookup_field&&this.item.lookup_field.multi_select){a=this.item.lookup_field.raw_value;this.options.select_all=this.item.lookup_field.multi_select_all;if(a instanceof Array)this.item.selections=a;else this.item.selections=[];this.options.multiselect=true;}this.item.select_all=this.options.select_all;},selections_update_selected:function(){var a=this.$element.find('th .multi-select .sel-count');if(this.options.multiselect){a.text(this.item.selections.length);if(this.item._show_selected)a.addClass('selected-shown');else a.removeClass('selected-shown');if(this.item.lookup_field&&this.item.lookup_field.multi_select)if(this.item.rec_count&&this.item.selections.length===1&&this.item._primary_key_field&&this.item.selections.indexOf(this.item._primary_key_field.value)!==-1)this.item.lookup_field.set_value(this.item.selections,this.item.field_by_name(this.item.lookup_field.lookup_field).display_text);else this.item.lookup_field.set_value(this.item.selections,'');}},selections_get_selected:function(){return this.item.selections.indexOf(this.item._primary_key_field.value)!==-1;},selections_can_change:function(a){var b=true;if(a&&this.options.selection_limit){b=(this.options.selection_limit&&this.options.selection_limit>=this.item.selections.length+1);if(!b)this.item.warning(d.selection_limit_exceeded.replace('%s',this.options.selection_limit));}return b;},selections_set_selected:function(a){var b=this,c=a,d,e,f=false;if(this.selections_can_change(a)){if(a){this.item.selections.add(this.item._primary_key_field.value);f=true;}else{this.item.selections.remove(this.item._primary_key_field.value);e=this.item.clone();e.each(function(a){if(b.item.selections.indexOf(a._primary_key_field.value)!==-1){f=true;return false;}});}this.selections_update_selected();this.$element.find('input.multi-select-header').prop('checked',f);}else c=false;return c;},selections_get_all_selected:function(){var a=this,b=this.item.clone(),c=false;b.each(function(b){if(a.item.selections.indexOf(b._primary_key_field.value)!==-1){c=true;return false;}});return c;},selections_set_all_selected_ex:function(a){var b=this,c,d,e=[],f,g,h,i,j;if(this.options.select_all){i=this.item.copy({handlers:false});i._where_list=this.item._open_params.__filters;i._order_by_list=this.item._open_params.__order;if(this.options.selection_limit)f=this.options.selection_limit;e.push(i._primary_key);for(c=0;c<i._where_list.length;c++){d=this.item.field_by_name(i._where_list[c][0]);if(d.lookup_item)e.push(d.field_name);}for(c=0;c<i._order_by_list.length;c++){d=this.item.field_by_ID(i._order_by_list[c][0]);if(e.indexOf(d.field_name)===-1)e.push(d.field_name);}i.open({fields:e,limit:f},function(){var d={},e=[];for(c=0;c<b.item.selections.length;c++)d[b.item.selections[c]]=true;b.item.selections.length=0;i.each(function(b){if(a)d[b._primary_key_field.value]=true;else delete d[b._primary_key_field.value];});for(var f in d)e.push(parseInt(f,10));b.item.selections=e;b.$table.find('td input.multi-select').prop('checked',a);b.$element.find('input.multi-select-header').prop('checked',b.selections_get_all_selected());b.selections_update_selected();});}},selections_set_all_selected:function(a){var b=this,c,d,e=[],f,g,h,i,j;j=this.item.clone();j.each(function(c){var d;if(b.selections_can_change(a))if(a)b.item.selections.add(c._primary_key_field.value);else b.item.selections.remove(c._primary_key_field.value);else{g=true;return false;}});if(g)this.build();else b.$table.find('td input.multi-select').prop('checked',a);this.selections_update_selected();},initKeyboardEvents:function(){var a=this,b;clearTimeout(b);b=setTimeout(function(){a.$table.on('keydown',function(b){a.keydown(b);});a.$table.on('keyup',function(b){a.keyup(b);});a.$table.on('keypress',function(b){a.keypress(b);});},300);},createTable:function(){var b=this,c=a(document),d,e,f,g,h=0,i;this.colspan=this.fields.length;if(this.options.multiselect)this.colspan+=1;this.$element.find('.table-container').append(a('<table class="outer-table" style="width: 100%;">'+'   <thead>'+'       <tr><th>&nbsp</th></tr>'+'   </thead>'+'   <tr>'+'       <td id="top-td" style="padding: 0;" colspan='+this.colspan+'>'+'           <div class="overlay-div" style="width: 100%; overflow-y: auto; overflow-x: hidden;">'+'               <table class="inner-table" style="width: 100%"></table>'+'           </div>'+'       </td>'+'   </tr>'+'   <tfoot class="outer-table">'+'       <tr><th>&nbsp</th></tr>'+'   </tfoot>'+'</table>'));this.$table_container=this.$element.find(".table-container");this.$outer_table=this.$element.find("table.outer-table");this.$scroll_div=this.$element.find('div.overlay-div');this.$table=this.$element.find("table.inner-table");this.$head=this.$element.find("table.outer-table thead tr:first");this.$foot=this.$element.find("table.outer-table tfoot tr:first");this.is_modal=this.$element.closest('.modal').length>0;if(this.item._paginate&&this.options.hide_y_scroll)this.$scroll_div.css('overflow-y','hidden');this.$scroll_div.keydown(function(a){var c=(a.keyCode?a.keyCode:a.which);if(c==32&&!b.editing)a.preventDefault();});this.$element.find('table.outer-table').addClass("table table-condensed table-bordered").css("margin",0);this.$table.addClass("table table-condensed").css("margin",0).attr("disabled",false);if(this.options.striped)this.$table.addClass("table-striped");this.$table.on('mousedown dblclick','td',function(c){var d=a(this);if(this.nodeName!=='TD')d=a(this).closest('td');if(!(b.editing&&d.find('input').length)){c.preventDefault();c.stopPropagation();b.clicked(c,d);}});this.$element.on('mousewheel DOMMouseScroll','div.overlay-div, table.inner-table',function(a){a.preventDefault();a.stopPropagation();if(a.originalEvent.wheelDelta>0||a.originalEvent.detail<0)b.prior_record();else b.next_record();});this.$table.on('click','td',function(a){if(b.options.on_click)b.options.on_click.call(b.item,b.item);});this.$table.on('mouseenter mouseup','td div',function(){var c=a(this),d=c.parent(),e=c.data('tooltip'),f='right',g=this.closest('.dbtable');b._remove_tooltip();if(Math.abs(this.offsetHeight-this.scrollHeight)>1||Math.abs(this.offsetWidth-this.scrollWidth)>1){if(b.$table.width()-(c.position().left+c.width())<200)f='left';d.tooltip({'placement':f,'container':g,'title':c.text()}).on('hide hidden show shown',function(a){if(a.target===c.get(0))a.stopPropagation();}).eq(0).tooltip('show');try{d.data('tooltip').$tip.addClass('table-tooltip');}catch(h){}}});this.$table.on('mousedown','td input.multi-select',function(c){var d=a(this),e=d.is(':checked');b.clicked(c,d.closest('td'));b.selections_set_selected(!e);d.prop('checked',b.selections_get_selected());});this.$table.on('click','td input.multi-select',function(c){var d=a(this);c.stopPropagation();c.preventDefault();d.prop('checked',b.selections_get_selected());});this.$element.on('click','input.multi-select-header',function(c){b.selections_set_all_selected(a(this).is(':checked'));});this.$table.attr("tabindex",this.options.tabindex);this.initKeyboardEvents();this.$element.on('mousemove.grid-title','table.outer-table thead tr:first th',function(c){var d=a(this),e=d.data('field_name'),f=b.$element.find("thead tr:first th:last").get(0);if(d.outerWidth()-c.offsetX<8&&!i&&(this!==f||b.master_table))d.css('cursor','col-resize');else if(b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(e)!==-1))d.css('cursor','pointer');else d.css('cursor','default');});function j(a){var b=h+a.screenX-i,c=parseInt(d.css("left"),10);if(i){a.preventDefault();if(b>-(e.innerWidth()-30)){h=b;d.css('left',c+a.screenX-i);}i=a.screenX;}}function k(a,c){var d,e,f,g,h,i,j=b.$element.find("thead tr:first th:last").get(0),k,l,m;e=a.data('field_name');g=b.$table.find('td.'+e);i=b.$element.find("tfoot tr:first th."+e);l=b.getCellWidth(e);m=l+c;b.setCellWidth(e,m);if(b.master_table){b.$element.width(b.$element.width()+c);b.master_table.setCellWidth(e,m);g=b.master_table.$table.find('td.'+e);h=b.master_table.$element.find("thead tr:first th."+e);i=b.master_table.$element.find("tfoot tr:first th."+e);g.width(m);g.find('div').width(m);h.width(m);h.find('div').width(m);i.width(m);i.find('div').width(m);b.master_table.syncColWidth();b.master_table.sync_freezed();}else{g.width(m);g.find('div').width(m);a.width(m);a.find('div').width(m);i.width(m);i.find('div').width(m);b.syncColWidth();}b.sync_freezed();}function l(a){var b,f,g,j;c.off("mousemove.grid-title");c.off("mouseup.grid-title");k(e,h);i=undefined;d.remove();}this.$element.on('mousedown.grid-title','table.outer-table thead tr:first th',function(f){var g=a(this),k,m,n=g.data('field_name'),o,p=[],k,q=false,r,s,t,u,v,w;m=b.$element.find("thead tr:first th:last").get(0);if(g.outerWidth()-f.offsetX<8&&(this!==m||b.master_table)){g.css('cursor','default');i=f.screenX;e=g;k=b.fields.indexOf(b.item.field_by_name(n));h=0;c.on("mousemove.grid-title",j);c.on("mouseup.grid-title",l);t=b.$container.closest('.modal');if(t.length){v=g.offset().left-t.offset().left;u=b.$element.offset().top-t.offset().top;}else{t=a('body');v=g.offset().left;u=b.$element.offset().top;}d=a('<div>').addClass('selection-box').css({'width':0,'height':b.$outer_table.find('thead').innerHeight()+b.$scroll_div.innerHeight(),'left':v+g.outerWidth(),'top':u});d.appendTo(t);}else if(n&&b.options.sortable&&(!b.options.sort_fields.length||b.options.sort_fields.indexOf(n)!==-1)){if(f.ctrlKey){if(!b._multiple_sort)b._multiple_sort=true;}else if(b._multiple_sort){b._sorted_fields=[];b._multiple_sort=false;}w=b._sorted_fields.slice();if(b._multiple_sort){k=-1;for(var x=0;x<w.length;x++)if(w[x][0]===n){k=x;break;}if(k===-1)w.push([n,false]);else w[k][1]=!w[k][1];}else if(w.length&&w[0][0]===n)w[0][1]=!w[0][1];else w=[[n,false]];b._sorted_fields=w.slice();if(b.item.master||!b.item._paginate)b.item._sort(b._sorted_fields);else{if(b.options.sort_add_primary){s=b.item[b.item._primary_key];q=b._sorted_fields[b._sorted_fields.length-1][1];b._sorted_fields.push([s.field_name,q]);}b.item._open_params.__order=b._sorted_fields;b.item.open({params:b.item._open_params,offset:0},true);}}});this.$table.focus(function(a){if(!this.syncronizing){this.syncronizing=true;try{b.syncronize();}finally{this.syncronizing=false;}}});this.$table.blur(function(a){b.syncronize();});this.fill_footer();this.calculate();},_remove_tooltip:function(){try{a('body').find('.tooltip.table-tooltip').remove();}catch(b){}},calculate:function(){var b,c,d,e,f,g,h,i,j,k,l;c=this.options.row_line_count;if(!c)c=1;if(this.master_table){this.row_count=this.master_table.row_count;this.text_height=this.master_table.text_height;this.row_height=this.master_table.row_height;this.selected_row_height=this.master_table.selected_row_height;this.height(this.master_table.height());this.$scroll_div.height(this.master_table.$scroll_div.height());return;}d=this.$element.clone().css("float","left").css("position","absolute").css("top",-1000);d.width(this.$container.width());if(!d.width())d.width(a('body').width());this.fill_title(d);this.fill_footer(d);this.create_pager(d);e=d.find("table.inner-table");if(this.item.selections&&!this.item.master)f='<tr><td><div><input type="checkbox"></div></td><td><div>W</div></td></tr>';else f='<tr><td><div>W</div></td></tr>';for(b=0;b<10;b++)e.append(f);d.find('th > div > p').css('margin',0);a('body').append(d);g=e.find('tr:last td');this.text_height=g.find('div').height();j=g.outerHeight(true);h=j*10-e.innerHeight();i=Math.abs(Math.abs(h)-10);if(i&&i<5&&h<0){j+=Math.round(i);h=j*10-e.innerHeight();}this.row_height=j+(c-1)*this.text_height;this.selected_row_height=0;k=d.outerHeight();l=d.find('div.overlay-div').innerHeight();d.remove();if(this.options.expand_selected_row)this.selected_row_height=j+(this.options.expand_selected_row-1)*this.text_height;if(this.options.row_count&&this.item._paginate){this.row_count=this.options.row_count;this.item._limit=this.options.row_count;this.$scroll_div.height(this.row_height*this.options.row_count);if(this.options.height)this.$scroll_div.height(this.options.height-(k-l)-d.find('.paginator').outerHeight(true));return;}this.$scroll_div.height(this.options.height-(k-l)-d.find('.paginator').outerHeight(true));if(this.options.row_count){this.row_count=this.options.row_count;this.$scroll_div.height(this.row_height*this.options.row_count);if(this.options.expand_selected_row)this.$scroll_div.height(this.row_height*(this.options.row_count-1)+this.selected_row_height+h);}if(this.item._paginate){if(!this.options.row_count){l=this.$scroll_div.innerHeight()+h;if(this.options.expand_selected_row)l=this.$scroll_div.height()-this.selected_row_height+h;this.row_count=Math.floor(l/this.row_height);if(this.options.expand_selected_row)this.row_count+=1;if(this.row_count<=0)this.row_count=1;}this.item._limit=this.row_count;}},create_pager:function(b){var c=this,e,f,g,h;if(this.item._paginate&&this.options.show_paginator){g=-1;e=a('   <div id="pager" style="margin: 0 auto">'+'       <form class="form-inline" style="margin: 0">'+'           <a class="btn btn-small" tabindex="-1" href="first"><i class="icon-backward"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="prior"><i class="icon-chevron-left"></i></a>'+'           <label  class="control-label" for="input-page">'+d.page+'</label>'+'           <input class="pager-input input-mini" id="input-page" tabindex="'+g+'" type="text">'+'           <label id="page-count" class="control-label" for="input-page">'+d.of+'1000000 </label>'+'           <a class="btn btn-small" tabindex="-1" href="next"><i class="icon-chevron-right"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="last"><i class="icon-forward"></i></a>'+'       </form>'+'   </div>');this.$fistPageBtn=e.find('[href="first"]');this.$fistPageBtn.on("click",function(a){c.firstPage();a.preventDefault();});this.$fistPageBtn.addClass("disabled");this.$priorPageBtn=e.find('[href="prior"]');this.$priorPageBtn.on("click",function(a){c.priorPage();a.preventDefault();});this.$priorPageBtn.addClass("disabled");this.$nextPageBtn=e.find('[href="next"]');this.$nextPageBtn.on("click",function(a){c.nextPage();a.preventDefault();});this.$lastPageBtn=e.find('[href="last"]');this.$lastPageBtn.on("click",function(a){c.lastPage();a.preventDefault();});this.$pageInput=e.find('input');this.$pageInput.val(1);this.$pageInput.on("keydown",function(a){var b,d=(a.keyCode?a.keyCode:a.which);if(d===13){b=parseInt(c.$pageInput.val(),10);a.preventDefault();if(!isNaN(b)&&(b>0)){c.$pageInput.val(b);c.set_page_number(b-1);}}});this.$page_count=e.find('#page-count');this.$page_count.text(d.of+'1000000');f=e.find('#pager').clone().css("float","left").css("position","absolute").css("top",-1000);a("body").append(f);h=f.width();f.remove();if(this.options.paginator_container){this.options.paginator_container.empty();this.options.paginator_container.append(e);}else if(b)b.find('.paginator').append(e);else this.$element.find('.paginator').append(e);this.$page_count.text(d.of+' ');e.find('#pager').width(h);}},initSelectedField:function(){var a;if(!this.selectedField&&this.editableFields.length){this.selectedField=this.editableFields[0];if(this.options.selected_field){a=this.item.field_by_name(this.options.selected_field);if(this.editableFields.indexOf(a)!==-1)this.selectedField=a;}}},setSelectedField:function(a){var b=this,c=this.selectedField!==a;if(this.editableFields.indexOf(a)!==-1){if(c&&this.can_edit()){this.flush_editor();this.hide_editor();}this.hide_selection();this.selectedField=a;if(this.can_edit()&&c&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){b.show_editor();},75);}this.show_selection();}},nextField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a<this.editableFields.length-1)this.setSelectedField(this.editableFields[a+1]);}},priorField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a>0)this.setSelectedField(this.editableFields[a-1]);}},hide_editor:function(){var a,b,c,d;d;if(this.editing){try{this.editMode=false;d=this.editor.$controlGroup.parent();b=this.editor.field;c=d.find('div.'+b.field_name);a=d.outerWidth();d.css("padding-left",this.editor.paddingLeft);d.css("padding-top",this.editor.paddingTop);d.css("padding-right",this.editor.paddingRight);d.css("padding-bottom",this.editor.paddingBottom);this.editor.$controlGroup.remove();this.editor.removed=true;this.editor=undefined;d.outerWidth(a);c.show();}finally{this.editing=false;}this.focus();}},flush_editor:function(){if(this.editor&&this.editing)this.editor.change_field_text();},selected_field_visible:function(){var a,b;if(this.selectedField&&this.freezed_table){a=this.selectedField.field_name;b=this.$table.find('tr:first td.'+a);if(b.position().left<this.freezed_table.$element.width())return false;}return true;},show_editor:function(){var b,c,d,e,f,g=this.itemRow();if(g&&this.can_edit()&&!this.editing&&this.selectedField&&this.selected_field_visible()&&this.item.record_count()){if(!this.item.is_changing())this.item.edit();this.editMode=true;this.editor=new x(this,this.selectedField);this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input').css('margin',0);this.editor.$controlGroup.css('margin',0);e=g.find('div.'+this.editor.field.field_name);e.hide();f=g.find('td.'+this.editor.field.field_name);this.editor.$input.css('font-size',f.css('font-size'));c=f.innerHeight();b=f.outerWidth();this.editor.paddingLeft=f.css("padding-left");this.editor.paddingTop=f.css("padding-top");this.editor.paddingRight=f.css("padding-right");this.editor.paddingBottom=f.css("padding-bottom");this.editor.padding=f.css("padding");f.css("padding",0);f.outerWidth(b);f.append(this.editor.$controlGroup);b=0;this.editor.$input.parent().children('*').each(function(){b+=a(this).outerWidth(true);});this.editor.$input.width(this.editor.$input.width()+this.editor.$controlGroup.width()-b);if(this.editor.$input.outerHeight(true)>c)this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input, btn').outerHeight(c,true);this.editor.update();if(this.is_focused())this.editor.$input.focus();this.editing=true;}},height:function(a){if(a===undefined)return this.$element.height();else this.$scroll_div.height(a-(this.$element.height()-this.$scroll_div.height()));},fill_title:function(b){var c,d,e=this,f,g,h,i,j,k,l='',m,n,o,p={},q,r='',s;if(b===undefined)b=this.$element;if(!this._sorted_fields)this._sorted_fields=[];d=this._sorted_fields.length;for(c=0;c<d;c++)try{o=this._sorted_fields[c][1];f=this.item.field_by_name(this._sorted_fields[c][0]);if(o)p[f.field_name]='icon-arrow-down';else p[f.field_name]='icon-arrow-up';}catch(t){}g=b.find("table.outer-table thead tr:first");g.empty();if(this.options.multiselect)if(this.item.master||!this.item._paginate){if(this.selections_get_all_selected())l='checked';h=a('<div class="text-center multi-select" style="overflow: hidden"></div>');n=a('<p class="sel-count text-center">'+this.item.selections.length+'</p>');h.append(n);j=a('<input class="multi-select-header" type="checkbox" '+l+' tabindex="-1">');h.append(j);i=a('<th class="multi-select-header"></th>').append(h);s=this.getCellWidth('multi-select');if(s&&this.fields.length){i.width(s);h.width('auto');}g.append(i);}else{if(this.selections_get_all_selected())l='checked';h=a('<div class="text-center multi-select" style="overflow: hidden"></div>');n=a('<p class="sel-count text-center">'+this.item.selections.length+'</p>');h.append(n);if(this.options.select_all)r+='<li id="mselect-all"><a tabindex="-1" href="#">'+task.language.select_all+'</a></li>'+'<li id="munselect-all"><a tabindex="-1" href="#">'+task.language.unselect_all+'</a></li>';q=task.language.show_selected;if(e.item._show_selected)q=task.language.show_all;r+='<li id="mshow-selected"><a tabindex="-1" href="#">'+q+'</a></li>';this.$element.find('#mselect-block').empty();k=a('<div style="height: 0; position: relative;">'+'<div id="mselect-block" class="btn-group" style="position: absolute">'+'<button type="button" class="btn mselect-btn" tabindex="-1">'+'<input class="multi-select-header" type="checkbox" tabindex="-1" style="margin: 0" '+l+'>'+'</button>'+'<a class="btn dropdown-toggle" data-toggle="dropdown" href="#" tabindex="-1" style="padding: 3px">'+'<span class="caret"></span>'+'</a>'+'<ul class="dropdown-menu">'+r+'</ul>'+'</div>'+'</div>');j=k.find('#mselect-block');k.find("#mselect-all").click(function(a){a.preventDefault();e.selections_set_all_selected_ex(true);e.$table.focus();});k.find("#munselect-all").click(function(a){a.preventDefault();e.selections_set_all_selected_ex(false);e.$table.focus();});k.find("#mshow-selected").click(function(a){a.preventDefault();e.item._show_selected=!e.item._show_selected;e.item._update_page({__show_selected_changed:true},function(){e.selections_update_selected();e.$table.focus();});});this.selection_block=k;this.$element.prepend(k);i=a('<th class="multi-select"></th>').append(h);s=this.getCellWidth('multi-select');if(s&&this.fields.length){i.width(s);h.width('auto');}g.append(i);h.css('min-height',50);i.css('padding-top',0);j.css('top',n.outerHeight()+n.position().top+4);j.css('left',(i.outerWidth()-j.width())/2+1);}d=this.fields.length;for(c=0;c<d;c++){f=this.fields[c];h=a('<div class="text-center '+f.field_name+'" style="overflow: hidden"><p>'+f.field_caption+'</p></div>');i=a('<th class="'+f.field_name+'" data-field_name="'+f.field_name+'"></th>').append(h);if(!this.options.title_word_wrap){h.css('height',this.text_height);i.css('height',this.text_height);}s=this.getCellWidth(f.field_name);if(s&&(c<this.fields.length-1)){i.width(s);h.width('auto');}if(p[f.field_name]){i.find('p').append('<i class="'+p[f.field_name]+'"></i>');i.find('i').css('margin-right',2);}g.append(i);}g.append('<th class="fake-column" style="display: None;></th>');if(this.options.title_callback)this.options.title_callback(g,this.item);this.selections_update_selected();},fill_footer:function(b){var c,d,e,f,g,h,i,j,k;if(b===undefined)b=this.$element;f=b.find("table.outer-table tfoot tr:first");g=f.clone();f.empty();if(this.options.multiselect){h=a('<div class="text-center multi-select" style="overflow: hidden; width: 100%"></div>');j=a('<th class="multi-select"></th>').append(h);f.append(j);}d=this.fields.length;for(c=0;c<d;c++){e=this.fields[c];h=a('<div class="text-center '+e.field_name+'" style="overflow: hidden; width: 100%">&nbsp</div>');i=g.find('div.'+e.field_name);if(i.length)h.html(i.html());j=a('<th class="'+e.field_name+'"></th>').append(h);f.append(j);}if(!this.options.show_footer)f.hide();},show_footer:function(){this.$element.find("table.outer-table tfoot tr:first").show();},hideFooter:function(){this.$element.find("table.outer-table tfoot tr:first").hide();},getCellWidth:function(a){return this.cellWidths[a];},setCellWidth:function(a,b){this.cellWidths[a]=b;},init_table:function(a){if(this.item._offset===0&&!a){this.init_fields();this._sorted_fields=this.item._open_params.__order;if(this.item._paginate){this.page=0;this.update_page_info();this.update_totals();}else this.field_width_updated=false;}this.refresh();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},do_after_open:function(a){var b=this;if(this.$table.is(':visible')){this.init_table(a);this.sync_freezed();}else setTimeout(function(){b.init_table(a);b.sync_freezed();},1);},update:function(a){var b,c=this,d;if(this.form_closing())return;switch(a){case e.UPDATE_OPEN:this.do_after_open();break;case e.UPDATE_PAGE_CHANGED:this.do_after_open(true);break;case e.UPDATE_CANCEL:this.refreshRow();break;case e.UPDATE_APPEND:d=this.addNewRow();this.$table.append(d);this.syncronize();this.syncColWidth();if(this.item.controls_enabled()&&this.item.record_count()===1)this.build();break;case e.UPDATE_INSERT:d=this.addNewRow();this.$table.prepend(d);this.syncronize();this.syncColWidth();break;case e.UPDATE_DELETE:this.deleteRow();break;case e.UPDATE_SCROLLED:this.syncronize();break;case e.UPDATE_CONTROLS:this.build();break;case e.UPDATE_CLOSE:this.$table.empty();break;case e.UPDATE_APPLIED:this.update_totals();break;case e.UPDATE_SUMMARY:this.update_summary();break;}},update_summary:function(){var a;for(a in this.item._summary)this.$foot.find('div.'+a).text(this.item._summary[a]);},calc_summary:function(a){var b=this,c,d,e,f,g,h,i,j,k=0,l=false,m,n;if(this.item._paginate){d=this.item.copy({handlers:false,details:false});h=d.fields[0].field_name,g=[];j=[];i=[];n={};i.push(h);n[h]='count';for(c=0;c<this.options.summary_fields.length;c++){e=this.options.summary_fields[c];f=this.item.field_by_name(e);if(f&&this.fields.indexOf(f)!==-1){g.push(e);if(f.numeric_field()){i.push(e);n[e]='sum';}else j.push(e);}}if(b.item._open_params.__search){m=this.item._open_params.__search[0];f=this.item.field_by_name(m);if(f.lookup_item)l=true;if(i.indexOf(m)===-1){i.push(m);n[m]='count';}else m='';}if(b.item._open_params.__filters)d._where_list=b.item._open_params.__filters;d.open({expanded:l,fields:i,funcs:n,params:{__summary:true}},function(){var c,e;d.each_field(function(a,c){if(c==0)k=a.value;else if(a.field_name!==m)b.$foot.find('div.'+a.field_name).text(a.display_text);});for(c=0;c<j.length;c++)b.$foot.find('div.'+j[c]).text(k);if(a)a.call(this,k);});}},update_field:function(a,b){var c=this,d=this.itemRow(),e,f,g,h;if(this.item.active&&this.item.controls_enabled()&&this.item.record_count()){h=d.find('div.'+a.field_name);if(h.length){g=this.get_field_text(a);if(g!==h.text()){h.text(g);if(this.item.record_count()<3&&(!this.item.paginate||this.item.paginate&&this.page_count===0))this.build();if(!b)this.update_selected(d);}}}},update_selected:function(a){if(!a)a=this.itemRow();if(this.options.row_callback)this.options.row_callback(a,this.item);},deleteRow:function(){var a=this.itemRow();a.remove();this.syncColWidth();},itemRow:function(){if(this.item.record_count())try{var b=this.item.rec_controls_info(),c=a(b[this.id]);this.update_selected(c);return c;}catch(d){console.log(d);}},refreshRow:function(){var a=this;this.each_field(function(b,c){a.update_field(b,true);});},do_on_edit:function(a){if(this.item.lookup_field)this.item.set_lookup_field_value();else if(!this.can_edit()||(!this.editMode&&a))if(this.on_dblclick)this.on_dblclick.call(this.item,this.item);else if(this.options.dblclick_edit)this.item.edit_record();else this.show_editor();else if(this.can_edit()&&!this.editMode&&!a)this.show_editor();},clicked:function(a,b){var c,d,e=b.parent();if(this.can_edit())this.setSelectedField(this.item.field_by_name(b.data('field_name')));c=this.item._dataset.indexOf(e.data("record"));if(this.editMode&&c!==this.item.rec_no){if(!this.item.is_edited())this.item.edit();this.flush_editor();this.item.post();}this.item._set_rec_no(c);if(!this.editing&&!this.is_focused())this.focus();if(a.type==="dblclick")this.do_on_edit(true);},hide_selection:function(){if(this.selected_row)if(this.selectedField){this.selected_row.removeClass("selected-focused selected");this.selected_row.find('td.'+this.selectedField.field_name).removeClass("field-selected-focused field-selected");}else this.selected_row.removeClass("selected-focused selected");},show_selection:function(){var a=this.is_focused(),b='selected',c='field-selected';if(a){b='selected-focused';c='field-selected-focused';}if(this.selected_row)if(this.can_edit()&&this.selectedField){this.selected_row.addClass(b);this.selected_row.find('td.'+this.selectedField.field_name).removeClass(b).addClass(c);}else this.selected_row.addClass(b);},select_row:function(a){var b,c=this.text_height;this.update_selected_row(a);this.hide_selection();if(this.options.row_line_count&&this.selected_row&&this.options.expand_selected_row)this.selected_row.find('tr, div').css('height',this.options.row_line_count*c);this.selected_row=a;this.show_selection();if(this.options.row_line_count&&this.options.expand_selected_row){b=this.selected_row.find('tr, div');b.css('height','');b.css('height',this.options.expand_selected_row*c);}},update_selected_row:function(a){var b,c,d,e;if(a.length){b=this.$scroll_div.scrollTop();c=b+this.$scroll_div.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$scroll_div.scrollTop(d);else if(e>c)this.$scroll_div.scrollTop(e-this.$scroll_div.height());}},syncronize:function(){var a=this,b,c;if(this.item.controls_enabled()&&this.item.record_count()>0){c=this.itemRow();b=!this.selected_row||(this.selected_row&&c&&this.selected_row.get(0)!==c.get(0));if(b&&this.can_edit())this.hide_editor();try{this.select_row(this.itemRow());}catch(d){}if(b&&this.can_edit()&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){a.show_editor();},75);}}},get_field_text:function(a){if(a.get_lookup_data_type()===e.BOOLEAN)if(this.owner&&(this.owner.on_field_get_text||this.owner.on_get_field_text))return a.get_display_text();else return a.get_lookup_value()?'×':'';else return a.get_display_text();},get_field_html:function(a){var b=this.get_field_text(a);if(a.field_kind===e.ITEM_FIELD&&this.item._open_params.__search)if(a.field_name===this.item._open_params.__search[0]){var c=this.item._open_params.__search[1];if(this.item._open_params.__search.length=4)c=this.item._open_params.__search[3];b=C(b,c);}return b;},next_record:function(){this.item.next();if(this.item.eof())if(this.can_edit()&&this.options.append_on_lastrow_keydown)this.item.append();else this.nextPage();},prior_record:function(){var a=this;this.item.prior();if(this.item.bof())this.priorPage(function(){a.item.last();});},keydown:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 33:case 34:case 35:case 36:case 38:case 40:if(this.editing&&c!==38&&c!==40)return;a.preventDefault();this.flush_editor();this.hide_editor();if(c===33)this.priorPage();else if(c===34)if(this.item._paginate&&this.item.is_loaded)this.item.last();else this.nextPage();else if(c===38)this.prior_record();else if(c===40)this.next_record();else if(c===36)this.firstPage();else if(c===35)this.lastPage();break;case 37:if(this.can_edit()&&!this.editMode)this.priorField();break;case 39:if(this.can_edit()&&!this.editMode)this.nextField();break;}},keyup:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(a.target===this.$table.get(0)&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.do_on_edit(false);break;case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();break;case 32:a.preventDefault();if(this.options.multiselect){c=this.itemRow().find('input.multi-select');this.selections_set_selected(!c[0].checked);c.prop('checked',this.selections_get_selected());}break;}},keypress:function(a){var b=this,c,d=a.which;if(d>32&&this.can_edit()&&this.options.keypress_edit&&!this.editMode)if(this.selectedField&&this.selectedField.valid_char_code(d))this.show_editor();},set_page_number:function(a,b,c){var d=this;if(c===undefined)c=true;if(!this.item._paginate||this.loading)return;if(a<this.page_count||a===0){this._remove_tooltip();this.page=a;this.scrollLeft=this.$element.find('.table-container').get(0).scrollLeft;if(this.master_table)this.master_table.scrollLeft=this.master_table.$element.find('.table-container').get(0).scrollLeft;this.loading=true;if(this.item.record_count())this.item._do_before_scroll();this.item.open({offset:this.page*this.item._limit},function(){if(b)b.call(d);d.loading=false;d.update_page_info();d.$element.find('.table-container').get(0).scrollLeft=d.scrollLeft;if(d.master_table)d.master_table.$element.find('.table-container').get(0).scrollLeft=d.master_table.scrollLeft;if(a===this.page_count-1&&d.item.rec_count===0&&c)d.update_totals(function(){d.set_page_number(d.page_count-1,b,false);});else if(b)b.call(this);});}},reload:function(a){if(this.item._paginate)this.set_page_number(this.page,a);else this.open(a);},update_page_info:function(){if(this.options.show_paginator&&this.$pageInput){this.$pageInput.val(this.page+1);if(this.page===0){this.$fistPageBtn.addClass("disabled");this.$priorPageBtn.addClass("disabled");}else{this.$fistPageBtn.removeClass("disabled");this.$priorPageBtn.removeClass("disabled");}if(this.item.is_loaded){this.$lastPageBtn.addClass("disabled");this.$nextPageBtn.addClass("disabled");}else{this.$lastPageBtn.removeClass("disabled");this.$nextPageBtn.removeClass("disabled");}}if(this.options.on_page_changed)this.options.on_page_changed.call(this.item,this.item,this);},update_totals:function(a){var b=this;this.calc_summary(function(c){b.update_page_count(c);if(a)a();});},update_page_count:function(a){if(this.item._paginate&&self.record_count!==a){this.record_count=a;this.page_count=Math.ceil(a/this.row_count);if(this.$page_count){this.$page_count.text(d.of+' 1');if(this.page_count)this.$page_count.text(d.of+' '+this.page_count);else this.$page_count.text(d.of+' '+1);}if(this.options.on_pagecount_update)this.options.on_pagecount_update.call(this.item,this.item,this);if(this.options.on_page_changed)this.options.on_page_changed.call(this.item,this.item,this);}},firstPage:function(a){if(this.item._paginate)this.set_page_number(0,a);else this.item.first();},nextPage:function(a){var b,c;if(this.item._paginate){if(!this.item.is_loaded)this.set_page_number(this.page+1,a);}else{c=this.item.clone();c._set_rec_no(this.item._get_rec_no());b=this.$scroll_div.innerHeight()/this.row_height-1;for(var d=0;d<b;d++)if(!c.eof())c.next();else break;this.item._set_rec_no(c._get_rec_no());}},priorPage:function(a){var b,c;if(this.item._paginate)if(this.page>0)this.set_page_number(this.page-1,a);else this.syncronize();else{c=this.item.clone();c._set_rec_no(this.item._get_rec_no());b=this.$scroll_div.innerHeight()/this.row_height-1;for(var d=0;d<b;d++)if(!c.eof())c.prior();else break;this.item._set_rec_no(c._get_rec_no());}},lastPage:function(a){var b=this;if(this.item._paginate)this.set_page_number(this.page_count-1,a);else this.item.last();},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},addNewRow:function(){var b=a(this.newRow()),c=this.item._get_rec_no(),d;b.data("record",this.item._dataset[c]);d=this.item.rec_controls_info();d[this.id]=b.get(0);if(this.options.row_callback)this.options.row_callback(b,this.item);return b;},newColumn:function(a,b,c,d,e){var f=this.getCellWidth(a),g='class="'+a+'"',h='data-field_name="'+a+'"',i='style="text-align:'+b+';overflow: hidden',j='style="overflow: hidden';if(this.text_height&&this.options.row_line_count)j+='; height: '+this.options.row_line_count*this.text_height+'px; width: auto';if(e&&f&&(d<this.fields.length-1))i+='; width: '+f+'px';i+='""';j+='"';return '<td '+g+' '+h+' '+i+'>'+'<div '+g+' '+j+'>'+c+'</div>'+'</td>';},newRow:function(){var a,b,c,d,g,h,i,j='',k=!this.auto_field_width||(this.auto_field_width&&this.field_width_updated);c=this.fields.length;i='';if(this.options.multiselect){if(this.selections_get_selected())j='checked';i+=this.newColumn('multi-select','center','<input class="multi-select" type="checkbox" '+j+' tabindex="-1">',-1,k);}for(b=0;b<c;b++){d=this.fields[b];a=this.item[d.field_name];if(!(a instanceof r))a=this.item.field_by_name(d.field_name);h=this.get_field_html(a);g=a.data_type===e.BOOLEAN?'center':f[a.alignment];i+=this.newColumn(a.field_name,g,h,b,k);}i+='<td class="fake-column" style="display: None;"></td>';return '<tr class="inner">'+i+'</tr>';},getElementWidth:function(a){if(!a.length)return 0;if(a.is(':visible'))return a.width();else return this.getElementWidth(a.parent());},syncColWidth:function(a){var b,c,d,e,f,g,h,i=this.fields.length;if(this.item.record_count()){b=this.$table.find("tr:first-child");if(this.options.multiselect){d=this.$head.find('th.'+'multi-select');e=b.find('td.'+'multi-select');h=d.width();d.width(h);e.width(h);}g=i-1;if(a)g=i;for(f=0;f<g;f++){c=this.fields[f];d=this.$head.find('th.'+c.field_name);e=b.find('td.'+c.field_name);h=d.width();d.width(h);e.width(h);}if(a)return;if(this.fields.length){c=this.fields[i-1];d=this.$head.find('th.'+c.field_name);if(d.width()<0){this.$head.find('th.'+'fake-column').show();this.$table.find('td.'+'fake-column').show();this.set_saved_width(b,true);this.syncColWidth(true);}else{this.$head.find('th.'+'fake-column').hide();this.$table.find('td.'+'fake-column').hide();}}}},set_saved_width:function(a,b){var c,d=this.fields.length,e=d-1,f,g;if(this.options.multiselect){g=this.getCellWidth('multi-select');a.find("td."+'multi-select').width(g);this.$head.find("th."+'multi-select').width(g);}if(b)e=d;for(c=0;c<e;c++){f=this.fields[c];g=this.getCellWidth(f.field_name);a.find("td."+f.field_name).width(g);this.$head.find("th."+f.field_name).width(g);}},fill_rows:function(){var a,b,c,d,e,f,g=[],h,i=this.item.clone(true);i.on_field_get_text=this.item.on_field_get_text;d='';f=this.item.rec_no;try{while(!i.eof()){this.item._cur_row=i._cur_row;d+=this.newRow();g.push(i._get_rec_no());i.next();}this.$table.html(d);d=this.$table.find("tr");b=d.length;for(a=0;a<b;a++){c=d.eq(a);e=g[a];i._set_rec_no(e);this.item._cur_row=e;c.data("record",i._dataset[e]);h=i.rec_controls_info();h[this.id]=c.get(0);if(this.options.row_callback)this.options.row_callback(c,this.item);}}finally{this.item._cur_row=f;}},refresh:function(b){var c,d,e,f,g,h,i,j,k,l,m,n='',o,p,q=[],r,s,t=this.$table.is(':visible'),u,v=this.item.clone(true),w=a('<div>');if(b===undefined)b=true;s=this.is_focused();if(this.options.editable&&this.editMode&&this.editor){if(!s)s=this.editor.$input.is(':focus');u=this.editor.$input.value;this.hide_editor();}w.css("position","absolute").css("top",-1000).width(this.getElementWidth(this.$element));a('body').append(w);this.$element.detach();w.append(this.$element);if(b){this.$table.empty();this.$head.empty();if(this.selection_block)this.selection_block.remove();this.$foot.hide();this.$outer_table.find('#top-td').attr('colspan',this.colspan);this.fill_rows();}f=this.$table.find("tr:first");if(this.auto_field_width&&!this.field_width_updated){this.$table.css('table-layout','auto');this.$outer_table.css('table-layout','auto');g='<tr>';if(this.options.multiselect)g=g+'<th class="multi-select">'+'<div class="text-center multi-select" style="overflow: hidden"></div>'+'</th>';d=this.fields.length;for(c=0;c<d;c++)g=g+'<th class="'+this.fields[c].field_name+'" ><div style="overflow: hidden">'+this.fields[c].field_caption+'</div></th>';g=a(g+'</tr>');this.$table.prepend(g);for(var x in this.options.column_width)if(this.options.column_width.hasOwnProperty(x))g.find("."+x).css("width",this.options.column_width[x]);if(this.options.multiselect){h=f.find("td."+'multi-select');this.setCellWidth('multi-select',38);}for(c=0;c<d;c++){e=this.fields[c];h=f.find("td."+e.field_name);this.setCellWidth(e.field_name,h.width());}this.$table.css('table-layout','fixed');this.$outer_table.css('table-layout','fixed');this.fill_title(w);this.fill_footer(w);this.set_saved_width(f);if(this.item.record_count()>0&&t)this.field_width_updated=true;g.remove();if(this.field_width_updated)this.refresh(false);}else{this.fill_title(w);this.fill_footer(w);this.syncColWidth();}if(this.options.show_footer)this.$foot.show();this.$element.detach();this.$container.append(this.$element);w.remove();this.$container.find('tfoot .pager').attr('colspan',this.colspan);this.syncronize();if(s)this.focus();if(this.can_edit()&&this.editMode&&this.editor){this.show_editor();this.editor.$input.value=u;}this.update_summary();},build:function(){var a=this.$scroll_div.scrollTop();this.init_fields();this.field_width_updated=false;this.refresh();this.syncColWidth();this.$scroll_div.scrollTop(a);this.syncronize();},is_focused:function(){return this.$table.get(0)===document.activeElement;},focus:function(){if(!this.is_focused())this.$table.focus();}};function w(a){var b=this;this.field=a;this.read_only=false;this.is_changing=true;}w.prototype={constructor:w,create_input:function(b,c,d){var g=this,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x='';if(a('body').css('font-size')==='12px')x=' btn12';else x=' btn14';if(!b)return;if(this.label){l=a('<label class="control-label"></label>').attr("for",b.field_name).text(this.label).addClass(b.field_name);if(this.field.required)l.addClass('required');if(this.label_width)l.width(this.label_width);}if(b.get_lookup_data_type()===e.BOOLEAN)m=a('<input>').attr("type","checkbox").click(function(a){g.field.value=!g.field.value;});else if(b.get_lookup_data_type()===e.LONGTEXT)m=a('<textarea>').innerHeight(70);else m=a('<input>').attr("type","text");if(c)m.attr("tabindex",c+"");s=a('<div class="controls"></div>');if(this.label_width&&!this.label_on_top)s.css('margin-left',this.label_width+20+'px');w=this.field.field_mask;if(!w)w=this.field.get_mask();if(w)try{m.mask(w);}catch(y){}this.$input=m;this.$input.addClass(b.field_name);if(task.old_forms)this.$input.attr("id",b.field_name);this.$input.addClass('dbinput');this.$input.data('dbinput',this);this.$input.focus(function(a){g.focusIn(a);});this.$input.blur(function(a){g.focusOut();});this.$input.on('input',(function(a){g.changed=true;}));this.$input.on('change',(function(a){g.changed=true;}));this.$input.mousedown(function(a){g.mouseIsDown=true;});this.$input.mouseup(function(a){if(!g.mouseIsDown)g.$input.select();g.mouseIsDown=false;});this.$input.keydown(a.proxy(this.keydown,this));this.$input.keyup(a.proxy(this.keyup,this));this.$input.keypress(a.proxy(this.keypress,this));if(b.lookup_item&&!b.master_field||b.lookup_values){t=a('<div class="input-prepend input-append"></div>');r=a('<button class="btn'+x+'"type="button"><i class="icon-remove-sign"></button>');r.attr("tabindex",-1);r.click(function(){b.set_value(null);});this.$firstBtn=r;t.append(r);t.append(m);r=a('<button class="btn'+x+'" type="button"><i></button>');r.attr("tabindex",-1);r.click(function(){if(b.lookup_values)g.dropdown.enter_pressed();else g.selectValue();});this.$lastBtn=r;t.append(r);s.append(t);if(b.lookup_values){t.addClass("lookupvalues-input-container");m.addClass("input-lookupvalues");this.$lastBtn.find('i').addClass("icon-chevron-down");this.dropdown=new A(this.field,m);if(b.filter&&b.bool_filter)m.width(36);}else{t.addClass("lookupfield-input-container");m.addClass("input-lookupitem");this.$lastBtn.find('i').addClass("icon-folder-open");if(this.field.enable_typeahead)this.dropdown=new B(this.field,m,this.field.typeahead_options());}}else{v=b.get_lookup_data_type();switch(v){case e.TEXT:m.addClass("input-text");s.append(m);break;case e.INTEGER:m.addClass("input-integer");s.append(m);break;case e.FLOAT:m.addClass("input-float");s.append(m);break;case e.CURRENCY:m.addClass("input-currency");s.append(m);break;case e.DATE:case e.DATETIME:t=a('<div class="input-prepend input-append"></div>');r=a('<button class="btn'+x+'" type="button"><i class="icon-remove-sign"></button>');r.attr("tabindex",-1);r.click(function(){b.set_value(null);});this.$firstBtn=r;t.append(r);if(v===e.DATETIME){t.addClass("datetime-input-container");m.addClass("input-datetime");}else{t.addClass("date-input-container");m.addClass("input-date");}t.append(m);r=a('<button class="btn'+x+'" type="button"><i class="icon-calendar"></button>');r.attr("tabindex",-1);r.click(function(){g.showDatePicker();});this.$lastBtn=r;t.append(r);s.append(t);break;case e.BOOLEAN:s.append(m);break;case e.LONGTEXT:m.addClass("input-longtext");s.append(m);break;}h=b.data_type===e.BOOLEAN?'center':f[b.alignment];this.$input.css("text-align",h);}if(this.label_on_top)this.$controlGroup=a('<div class="input-container"></div>');else this.$controlGroup=a('<div class="control-group input-container"></div>');if(this.label){this.$controlGroup.append(l);if(!this.label_width)this.$controlGroup.addClass('label-size'+this.label_size);}this.$controlGroup.append(s);if(d)d.append(this.$controlGroup);s.find('.add-on').css('padding-top',parseInt(s.find('.add-on').css('padding-top'))+parseInt(s.find('.add-on').css('border-top-width'))-1+'px');s.find('.add-on').css('padding-bottom',parseInt(s.find('.add-on').css('padding-bottom'))+parseInt(s.find('.add-on').css('border-bottom-width'))-1+'px');this.$modalForm=this.$input.closest('.modal');this.field.controls.push(this);this.$input.on('mouseenter',function(){var b=a(this);if(g.error)b.tooltip('show');});if(!this.grid&&this.field.field_placeholder)this.$input.attr('placeholder',this.field.field_placeholder);if(!this.grid&&this.field.field_help){u=a('<a href="#" tabindex="-1"><span class="badge help-badge">?</span></a>');u.click(function(a){a.preventDefault();g.$lastBtn.focus().click();});this.$help=u;u.find('span').popover({container:'body',placement:'right',trigger:'hover',html:true,title:g.field.field_caption,content:g.field.field_help}).click(function(a){a.preventDefault();});if(t){s.append(u);u.find('span').addClass('btns-help-badge');}else s.append(u);}this.$input.tooltip({container:'body',placement:'bottom',title:''}).on('hide hidden show shown',function(a){if(a.target===g.$input.get(0))a.stopPropagation();});this.$input.bind('destroyed',function(){g.field.controls.splice(g.field.controls.indexOf(g),1);if(g.dropdown)g.dropdown.destroy();if(g.$help)g.$help.find('span').popover('destroy');});this.update();},form_closing:function(){if(this.$modalForm)return this.$modalForm.data('_closing');return false;},set_read_only:function(a){if(this.$firstBtn)this.$firstBtn.prop('disabled',a);if(this.$lastBtn)this.$lastBtn.prop('disabled',a);if(this.$input)this.$input.prop('disabled',a);},update:function(a){var b=this.field.field_placeholder,c=this.$input.get(0)===document.activeElement,d=this.is_changing;if(this.field.field_kind===e.ITEM_FIELD){d=this.field.owner.is_changing();if(!this.field.owner.active||this.field.owner.record_count()===0){this.read_only=true;this.is_changing=false;this.set_read_only(true);this.$input.val('');return;}}if(!this.removed&&!this.form_closing()){if(this.read_only!==this.field._get_read_only()||d!==this.is_changing){this.read_only=this.field._get_read_only();this.is_changing=d;this.set_read_only(this.read_only||!this.is_changing);}if(this.field.master_field)this.set_read_only(true);if(this.field.get_lookup_data_type()===e.BOOLEAN)if(this.field.get_lookup_value())this.$input.prop("checked",true);else this.$input.prop("checked",false);if(this.field.lookup_values)this.$input.val(this.field.display_text);else if(c&&this.$input.val()!==this.field.get_text()||!c&&this.$input.val()!==this.field.get_display_text()){this.errorValue=undefined;this.error=undefined;if(c&&!this.field.lookup_item&&!this.field.lookup_values)this.$input.val(this.field.get_text());else this.$input.val(this.field.get_display_text());}if(this.read_only||!this.is_changing||this.field.master_field)b='';this.$input.attr('placeholder',b);this.updateState(true);this.changed=false;}if(a===e.UPDATE_CLOSE){this.$input.val('');this.set_read_only(true);}},keydown:function(a){var b=(a.keyCode?a.keyCode:a.which);if(this.field.lookup_item&&!this.field.enable_typeahead&&!(b===229||b===9||b==8))a.preventDefault();if(b===9)if(this.grid&&this.grid.editMode){a.preventDefault();if(a.shiftKey)this.grid.priorField();else this.grid.nextField();}},keyup:function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(this.field.enable_typeahead){b=this.$input.data('jamtypeahead');if(b&&b.shown)return;}if(c===13&&!a.ctrlKey&&!a.shiftKey){if(this.grid&&this.grid.editMode){if(!(this.dropdown&&this.dropdown.shown)){a.stopPropagation();a.preventDefault();if(!this.grid.item.is_changing())this.grid.item.edit();this.grid.flush_editor();this.grid.hide_editor();if(this.grid.item.is_changing())this.grid.item.post();}}else if(this.field.lookup_item&&!this.field.enable_typeahead){a.stopPropagation();a.preventDefault();this.selectValue();}else if((this.field.data_type===e.DATE)||(this.field.data_type===e.DATETIME)){a.stopPropagation();a.preventDefault();this.showDatePicker();}}else if(c===27)if(this.grid&&this.grid.editMode){a.preventDefault();a.stopPropagation();this.grid.item.cancel();this.grid.hide_editor();}else if(this.field.lookup_values){if(this.$input.parent().hasClass('open')){this.$input.parent().removeClass('open');a.stopPropagation();}}else if(this.changed){this.update();a.preventDefault();a.stopPropagation();}},keypress:function(a){var b=a.which;if(b===13&&!(this.$input.get(0).tagName==='TEXTAREA'))a.preventDefault();else{if(this.field.lookup_item&&!this.field.enable_typeahead)a.preventDefault();if(this.$input.is('select')){}else if(b&&!this.field.valid_char_code(b))a.preventDefault();}},showDatePicker:function(){var a=this,b;if(this.field.data_type===e.DATE)b=c.D_FMT;else if(this.field.data_type===e.DATETIME)b=c.D_T_FMT;this.$input.datepicker({weekStart:parseInt(d.week_start,10),format:b,daysMin:d.days_min.slice(1,-1).split(','),months:d.months.slice(1,-1).split(','),monthsShort:d.months_short.slice(1,-1).split(','),date:this.field.value}).on('show',function(b){if(b.target===a.$input.get(0)){b.stopPropagation();a.$input.datepicker().attr('data-weekStart',1);}}).on('hide hidden shown',function(b){if(b.target===a.$input.get(0))b.stopPropagation();}).on('changeDate',function(b){a.field.set_value(b.date);a.$input.datepicker('hide');});this.$input.datepicker('show');},selectValue:function(){if(this.field.on_entry_button_click)this.field.on_entry_button_click.call(this.item,this.field);else this.field.select_value();},change_field_text:function(){var a=true,b=this.field.data_type,c;this.errorValue=undefined;this.error=undefined;if(this.field.lookup_item||this.field.lookup_values){if(this.$input.val()!==this.field.get_lookup_text())this.$input.val(this.field.get_display_text());}else try{c=this.$input.val();if(c!==this.field.text){if(this.field.field_kind===e.ITEM_FIELD&&!this.field.owner.is_changing())this.field.owner.edit();if(c==='')this.field.set_value(null);else{this.field.set_text(c);if(!(this.field.field_kind===e.ITEM_FIELD&&!this.field.owner.rec_count)){this.field.check_valid();if(this.$input.is(':visible'))this.$input.val(c);}}this.changed=false;}}catch(d){this.errorValue=c;this.error=d;this.updateState(false);if(d.stack)console.error(d.stack);else console.error(d);a=false;}return a;},focusIn:function(a){this.hideError();if(this.field.lookup_item&&!this.field.enable_typeahead)this.$input.val(this.field.get_display_text());else{if(this.errorValue)this.$input.val(this.errorValue);else if(this.field.lookup_item||this.field.lookup_values)this.$input.val(this.field.get_display_text());else this.$input.val(this.field.get_text());if(!this.mouseIsDown){this.$input.select();this.mouseIsDown=false;}}this.mouseIsDown=false;this.updateState(true);},focusOut:function(a){var b=false;if(!this.changed){if(this.field.field_kind!==e.ITEM_FIELD||this.field.owner.rec_count)this.$input.val(this.field.get_display_text());return;}if(this.grid&&this.grid.editMode){if(this.grid.item.is_changing()){this.grid.flush_editor();this.grid.item.post();this.grid.hide_editor();}b=true;}if(this.field.data_type===e.BOOLEAN)b=true;else if(!this.grid&&this.change_field_text()){if(this.$input.is(':visible'))this.$input.val(this.field.get_display_text());b=true;}this.updateState(b);return b;},updateState:function(a){if(a){if(this.$controlGroup)this.$controlGroup.removeClass('error');this.errorValue=undefined;this.error=undefined;this.$input.tooltip('hide').attr('data-original-title','').tooltip('fixTitle');this.hideError();}else{task.alert_error(this.error,{replace:false});this.showError();if(this.$controlGroup)this.$controlGroup.addClass('error');this.$input.tooltip('hide').attr('data-original-title',this.error).tooltip('fixTitle');}},showError:function(a){},hideError:function(a){},focus:function(){this.$input.focus();}};x.prototype=new w();x.prototype.constructor=x;function x(a,b){w.call(this,b);this.grid=a;this.create_input(b,0);this.$input.attr("autocomplete","off");this.$input.addClass('dbtableinput');}a.extend(x.prototype,{});y.prototype=new w();y.prototype.constructor=y;function y(a,b,c,d,e){w.call(this,a);if(this.field.owner&&this.field.owner.edit_form&&this.field.owner.edit_form.hasClass("modal"))this.$edit_form=this.field.owner.edit_form;this.label=e;this.label_width=d.label_width;this.label_on_top=d.label_on_top;this.label_size=d.label_size;if(!this.label_size)this.label_size=3;if(!this.label)this.label=this.field.field_caption;this.create_input(a,b,c);}a.extend(y.prototype,{showError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("normal-modal-border")){this.$edit_form.removeClass("nomal-modal-border");this.$edit_form.addClass("error-modal-border");}},hideError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("error-modal-border")){this.$edit_form.removeClass("error-modal-border");this.$edit_form.addClass("nomal-modal-border");}}});function z(a,b,c){this.$element=b;this.field=a;this.options=c;}z.prototype={constructor:z,init:function(){var b={menu:'<ul class="typeahead dropdown-menu"></ul>',item:'<li><a href="#"></a></li>',length:10,min_length:1};this.options=a.extend({},b,this.options);this.$menu=a(this.options.menu);},show:function(){var b;if(this.$element){b=a.extend({},this.$element.offset(),{height:this.$element[0].offsetHeight});this.$menu.appendTo(a('body')).css({top:b.top+b.height,left:b.left,"min-width":this.$element.innerWidth(),"max-width":a(window).width()-this.$element.offset().left-20,"overflow":"hidden"}).show();this.shown=true;this.mousedover=false;return this;}},hide:function(){this.$menu.hide();this.$menu.detach();this.shown=false;return this;},destroy:function(){this.$element=undefined;this.$menu.remove();},get_items:function(b){var c;if(this.$element){this.query=this.$element.val();if(!this.query||this.query.length<this.min_length)return this.shown?this.hide():this;c=a.isFunction(this.source)?this.source(this.query,a.proxy(this.process,this)):this.source;return c?this.process(c):this;}},lookup:function(a){this.get_items(a);},process:function(b){var c=this;b=a.grep(b,function(a){return c.matcher(a);});if(!b.length)return this.shown?this.hide():this;return this.render(b.slice(0,this.length)).show();},matcher:function(a){return true;},highlighter:function(a){return C(a,this.query);},render:function(b){var c=this;b=a(b).map(function(b,d){var e;b=a(c.options.item).data('id-value',d[0]);e=c.highlighter(d[1]);if(e.trim()==='')e='&nbsp';b.find('a').html(e);return b[0];});b.first().addClass('active');this.$menu.html(b);return this;},next:function(b){var c=this.$menu.find('li.active').removeClass('active'),d=c.next();if(!d.length)d=a(this.$menu.find('li')[0]);d.addClass('active');},prev:function(a){var b=this.$menu.find('.active').removeClass('active'),c=b.prev();if(!c.length)c=this.$menu.find('li').last();c.addClass('active');},listen:function(){this.$element.on('focus',a.proxy(this.focus,this)).on('blur',a.proxy(this.blur,this)).on('keypress',a.proxy(this.keypress,this)).on('keyup',a.proxy(this.keyup,this));if(this.eventSupported('keydown'))this.$element.on('keydown',a.proxy(this.keydown,this));this.$menu.on('click',a.proxy(this.click,this)).on('mouseenter','li',a.proxy(this.mouseenter,this)).on('mouseleave','li',a.proxy(this.mouseleave,this));},eventSupported:function(a){var b=a in this.$element;if(!b){this.$element.setAttribute(a,'return;');b=typeof this.$element[a]==='function';}return b;},move:function(a){if(!this.shown)return;switch(a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault();this.prev();break;case 40:a.preventDefault();this.next();break;}a.stopPropagation();},keydown:function(b){this.suppressKeyPressRepeat=~a.inArray(b.keyCode,[40,38,9,13,27]);this.move(b);},keypress:function(a){if(this.suppressKeyPressRepeat)return;this.move(a);},keyup:function(a){if(!a.ctrlKey&&!a.shiftKey){switch(a.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown){if(a.keyCode===13)this.enter_pressed();}else this.select();break;case 27:if(!this.shown)return;this.field.update_controls();if(this.$element)this.$element.select();this.hide();break;default:this.lookup();}a.stopPropagation();a.preventDefault();}},focus:function(a){this.focused=true;},blur:function(a){this.focused=false;if(!this.mousedover&&this.shown)this.hide();},click:function(a){a.stopPropagation();a.preventDefault();this.select();this.$element.focus();},mouseenter:function(b){this.mousedover=true;this.$menu.find('li.active').removeClass('active');a(b.currentTarget).addClass('active');},mouseleave:function(a){this.mousedover=false;if(!this.focused&&this.shown)this.hide();}};A.prototype=new z();A.prototype.constructor=A;function A(a,b,c){z.call(this,a,b,c);this.init();this.listen();}a.extend(A.prototype,{matcher:function(a){if(this.query)return ~a[1].toLowerCase().indexOf(this.query.toLowerCase());else return true;},select:function(){var a=this.$menu.find('.active');if(this.field.owner&&this.field.owner.is_changing&&!this.field.owner.is_changing())this.field.owner.edit();this.field.value=a.data('id-value');return this.hide();},enter_pressed:function(){this.query='';if(this.$element)this.$element.focus();this.process(this.field.lookup_values);}});B.prototype=new z();B.prototype.constructor=B;function B(a,b,c){z.call(this,a,b,c);this.init();this.source=this.options.source;this.lookup_item=this.options.lookup_item;this.listen();}a.extend(B.prototype,{lookup:function(a){var b=this;clearTimeout(this.timeOut);this.timeOut=setTimeout(function(){b.get_items(a);},400);},select:function(){var a=this.$menu.find('.active'),b=a.data('id-value');this.lookup_item.locate(this.lookup_item._primary_key,b);this.lookup_item.set_lookup_field_value();return this.hide();},enter_pressed:function(){this.field.select_value();}});function C(a,b){var c=0,d,e;if(b){e=b.split(' ');for(c=0;c<e.length;c++){d=e[c];if(d.indexOf('strong>')===-1&&d.length){d=d.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,'\\$&');a=a.replace(new RegExp('('+d+')','ig'),function(a,b){return '<strong>'+b+'</strong>';});}}}return a;}a.event.special.destroyed={remove:function(a){if(a.handler)a.handler();}};window.task=new l();})(jQuery);